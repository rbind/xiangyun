---
title: 空间数据可视化与 R 语言（上篇）
author: 黄湘云
date: '2022-02-01'
slug: maps-in-r
categories:
  - 统计图形
tags:
  - 数据可视化
  - 空间数据
  - ggplot2
  - ggmap
  - echarts4r
  - plotly
  - leaflet
  - leafletCN
  - baidumap
  - RgoogleMaps
  - lattice
  - sf
  - terra
  - sp
  - raster
output:
  blogdown::html_page:
    toc: true
    number_sections: true
link-citations: true
math: true
thumbnail: img/usmap-statex77.png
csl: institute-of-mathematical-statistics.csl
bibliography: 
  - refer.bib
  - packages.bib
description: "介绍用于地理可视化的几种常用数据结构，比如 **sp** 包和**sf** 包提供的空间数据类型、数据操作和绘图方法。介绍地理可视化常用的展示形式，如瓦片图、围栏图、气泡图、热力图、等高图等，以及绘制过程中需要注意的制图规范问题。介绍 **ggplot2**、**lattice**、**leaflet**、**plotly** 和 **echarts4r** 等诸多 R 包，分别调用谷歌、高德等多个地图服务实现静态或交互式地理可视化。"
---


<div id="TOC">
<ul>
<li><a href="#概览" id="toc-概览"><span class="toc-section-number">1</span> 概览</a></li>
<li><a href="#空间数据" id="toc-空间数据"><span class="toc-section-number">2</span> 空间数据</a>
<ul>
<li><a href="#示例美国旧金山犯罪数据" id="toc-示例美国旧金山犯罪数据"><span class="toc-section-number">2.1</span> 示例：美国旧金山犯罪数据</a></li>
<li><a href="#示例美国人口普查统计数据" id="toc-示例美国人口普查统计数据"><span class="toc-section-number">2.2</span> 示例：美国人口普查统计数据</a></li>
<li><a href="#示例美国锡安公园地形数据" id="toc-示例美国锡安公园地形数据"><span class="toc-section-number">2.3</span> 示例：美国锡安公园地形数据</a></li>
</ul></li>
<li><a href="#可视化包" id="toc-可视化包"><span class="toc-section-number">3</span> 可视化包</a>
<ul>
<li><a href="#echarts4r" id="toc-echarts4r"><span class="toc-section-number">3.1</span> echarts4r</a></li>
<li><a href="#leaflet" id="toc-leaflet"><span class="toc-section-number">3.2</span> leaflet</a></li>
<li><a href="#plotly" id="toc-plotly"><span class="toc-section-number">3.3</span> plotly</a></li>
<li><a href="#lattice" id="toc-lattice"><span class="toc-section-number">3.4</span> lattice</a></li>
</ul></li>
<li><a href="#数据结构" id="toc-数据结构"><span class="toc-section-number">4</span> 数据结构</a>
<ul>
<li><a href="#矢量数据-sp" id="toc-矢量数据-sp"><span class="toc-section-number">4.1</span> 矢量数据 sp</a></li>
<li><a href="#矢量数据-sf" id="toc-矢量数据-sf"><span class="toc-section-number">4.2</span> 矢量数据 sf</a></li>
</ul></li>
<li><a href="#数据操作" id="toc-数据操作"><span class="toc-section-number">5</span> 数据操作</a>
<ul>
<li><a href="#一般数据操作" id="toc-一般数据操作"><span class="toc-section-number">5.1</span> 一般数据操作</a></li>
<li><a href="#空间数据操作" id="toc-空间数据操作"><span class="toc-section-number">5.2</span> 空间数据操作</a></li>
</ul></li>
<li><a href="#案例美国北卡婴儿猝死综合征数据" id="toc-案例美国北卡婴儿猝死综合征数据"><span class="toc-section-number">6</span> 案例：美国北卡婴儿猝死综合征数据</a>
<ul>
<li><a href="#ggplot2-sf" id="toc-ggplot2-sf"><span class="toc-section-number">6.1</span> ggplot2 &amp; sf</a></li>
<li><a href="#leaflet-mapdeck" id="toc-leaflet-mapdeck"><span class="toc-section-number">6.2</span> leaflet &amp; mapdeck</a></li>
<li><a href="#spspplot" id="toc-spspplot"><span class="toc-section-number">6.3</span> sp::spplot</a></li>
<li><a href="#latticeextramapplot" id="toc-latticeextramapplot"><span class="toc-section-number">6.4</span> latticeExtra::mapplot</a></li>
</ul></li>
<li><a href="#总结归纳" id="toc-总结归纳"><span class="toc-section-number">7</span> 总结归纳</a></li>
<li><a href="#未来展望" id="toc-未来展望"><span class="toc-section-number">8</span> 未来展望</a></li>
<li><a href="#环境信息" id="toc-环境信息"><span class="toc-section-number">9</span> 环境信息</a></li>
<li><a href="#refer" id="toc-refer"><span class="toc-section-number">10</span> 参考文献</a></li>
</ul>
</div>

<div class="rmdinfo">
<p>本文引用的所有信息均为公开信息，仅代表作者本人观点，与就职单位无关。</p>
</div>
<div id="概览" class="section level1" number="1">
<h1><span class="header-section-number">1</span> 概览</h1>
<p>本文首先以实际示例介绍三类典型的空间数据，希望读者能对不同类型的空间数据的特点和使用场景有个简单印象。紧接着，介绍各类地理空间数据的可视化方法及 R 包实现，笔者从个人经验出发详细介绍了4个，相信足够让读者应付大部分使用场景。之后，再介绍 R 语言中的空间数据类型及其基本操作，空间数据操作是基本功，也是比较难的，没放在空间数据可视化前面是怕吓跑了一些读者，笔者所知也十分有限，也怕写不好。再基于一个真实数据用不同的 R 包实现类似的可视化效果，是几代空间数据可视化方法的并列介绍，最后是一些心得、总结和展望。</p>
<p>本文有几个写作意图：</p>
<ol style="list-style-type: decimal">
<li>如何用 R 语言调用<strong>各类</strong>地图服务实现<strong>各类</strong>空间数据的<strong>各种</strong>可视化方法。</li>
<li>以丰富的实例数据和图形展示各类空间数据，帮助读者建立直觉。</li>
<li>对比多个可视化 R 包，提供丰富的效果图，帮助读者选择合适的可视化图形。</li>
<li>希望在这个颜值走遍天下的时代，能吸引更多的人入坑 R 语言，并感受 R 语言在数据可视化领域的魅力。</li>
</ol>
<!-- 
无需强调：笔者不是测绘专业出身，自学过一点地统计学（Geostatistics），很多地理信息和空间分析的领域知识是现学现卖，恐有错漏，还请多多指正。 
-->
</div>
<div id="空间数据" class="section level1" number="2">
<h1><span class="header-section-number">2</span> 空间数据</h1>
<p>空间数据基本类型有点、线、面（或称多边形）等，还分矢量数据和栅格数据，地理可视化的展示形式有气泡图、热力图、瓦片图、地形图等。下面通过几个实际的空间数据，以图形的展示方式以期帮助读者建立数据直觉，陆续使用 <strong>lattice</strong> <span class="citation">[<a href="#ref-lattice" role="doc-biblioref">1</a>]</span>、<strong>ggplot2</strong> <span class="citation">[<a href="#ref-ggplot2" role="doc-biblioref">2</a>]</span>和 <strong>leaflet</strong> <span class="citation">[<a href="#ref-leaflet" role="doc-biblioref">3</a>]</span> 来绘制静态和交互图形。</p>
<div id="示例美国旧金山犯罪数据" class="section level2" number="2.1">
<h2><span class="header-section-number">2.1</span> 示例：美国旧金山犯罪数据</h2>
<p>下面以 <strong>RgoogleMaps</strong> 包内置的数据集 incidents 为例介绍空间点数据，并作一些简单的分析。</p>
<pre class="r"><code>library(RgoogleMaps)
# 加载 incidents 
data(incidents)
# 查看数据
head(incidents)
#        IncidntNum           Category                              Descript DayOfWeek
# 67026   120621114            ASSAULT                              STALKING  Saturday
# 34773   120328627     OTHER OFFENSES   FAILURE TO HEED RED LIGHT AND SIREN Wednesday
# 113571  120653593       NON-CRIMINAL          AIDED CASE, MENTAL DISTURBED    Friday
# 35951   120333927      LARCENY/THEFT           PETTY THEFT FROM A BUILDING    Friday
# 102975  120963370     OTHER OFFENSES DRIVERS LICENSE, SUSPENDED OR REVOKED  Thursday
# 35201   120338701 DISORDERLY CONDUCT         MAINTAINING A PUBLIC NUISANCE    Sunday
#              Date  Time PdDistrict        Resolution                     Location    lon
# 67026  2012-07-21 00:01       PARK              NONE MCALLISTER ST / BRODERICK ST -122.4
# 34773  2012-04-25 17:29    MISSION              NONE          16TH ST / BRYANT ST -122.4
# 113571 2012-08-17 09:50   SOUTHERN PSYCHOPATHIC CASE      1200 Block of MARKET ST -122.4
# 35951  2012-04-27 11:30       PARK              NONE       1000 Block of HAYES ST -122.4
# 102975 2012-11-29 07:00    BAYVIEW     ARREST, CITED    BAY SHORE BL / AUGUSTA ST -122.4
# 35201  2012-04-29 00:23    MISSION    ARREST, BOOKED         400 Block of CAPP ST -122.4
#          lat violent HrOfDay TimeOfDay HourOfWeek censusBlock
# 67026  37.78    TRUE      00   0.01667     24.017 06075015802
# 34773  37.77   FALSE      17  17.48333    137.483 06075017700
# 113571 37.78   FALSE      09   9.83333      9.833 06075017601
# 35951  37.78   FALSE      11  11.50000     11.500 06075016400
# 102975 37.73   FALSE      07   7.00000    151.000 06075025702
# 35201  37.76   FALSE      00   0.38333     48.383 06075020800</code></pre>
<p>数据集 incidents 来自 2012 年旧金山的犯罪数据，更多数据见 <a href="https://datasf.org/opendata/">DataSF 项目</a>，一些数据分析见 Github <a href="https://github.com/datasf">项目</a>。数据集 incidents 随机抽取了 5000 行，16个观测变量，分别是犯罪数目 <code>IncidntNum</code>、犯罪类型 <code>Category</code>、犯罪行为描述 <code>Descript</code>、犯罪行为发生在周几 <code>DayOfWeek</code>、犯罪行为发生的日期 <code>Date</code>、犯罪行为发生的时间（hh::mm）<code>Time</code>、警局辖区 <code>PdDistrict</code>、警方处置方式 <code>Resolution</code>、位置 <code>Location</code>、经度 <code>lon</code>、纬度 <code>lat</code>、是否属于暴力行为 <code>violent</code>、发生时间（小时，以2位整数计） <code>HrOfDay</code>、发生时间（小时，以10进制计）<code>TimeOfDay</code>、发生时间（一周168个小时，0-168之间的数字）<code>HourOfWeek</code>、人口普查的区块标记 <code>censusBlock</code>。图<a href="#fig:incidents-map">2.1</a>展示警方出警地点，或者说犯罪行为发生地点，红点表示此处发生暴力冲突，黑点表示此处没有暴力冲突。</p>
<pre class="r"><code>plotmap(
  lat = lat, lon = lon, data = incidents, 
  col = &#39;violent&#39;, zoom = 12,
  pch = 20, cex = 0.5, API = &quot;google&quot;,
  apiKey = Sys.getenv(&quot;GGMAP_GOOGLE_API_KEY&quot;)
)</code></pre>
<div class="figure"><span style="display:block;" id="fig:incidents-map"></span>
<img src="img/incidents-map.png" class="full" alt="" />
<p class="caption">图 2.1:  2012 年旧金山警方出警地点的空间分布</p>
</div>
<p>除了 <strong>RgoogleMaps</strong> 提供的 <code>plotmap()</code> 函数，当然，还可以用 <strong>leaflet</strong> 来绘制交互式的散点图，因为交互，可以放入更多的信息。如图<a href="#fig:incidents-leaflet">2.2</a>，鼠标悬浮在散点上可以看到事件发生的警区 PdDistrict，点击可以看到警方的处置方式 Resolution，这是设置 <code>addCircles()</code> 的参数 <code>label</code> 和 <code>popup</code> 实现的，实际上，它们还可以放入更加丰富的信息。</p>
<pre class="r"><code>library(leaflet)
# 分类变量映射成颜色
colorize_factor &lt;- function(x) {
  # 设置颜色梯度数目
  scales::col_factor(palette = &quot;plasma&quot;, domain = unique(x))(x)
}
# 警方处置方式 Resolution 映射成颜色变量
incidents &lt;- transform(incidents, color = colorize_factor(Resolution))
# 绘制交互图形
leaflet(options = leafletOptions(
    minZoom = 4, maxZoom = 18, zoomControl = FALSE
  )) |&gt; 
  addTiles() |&gt; 
  setView(lng = -122.4, lat = 37.77, zoom = 13) |&gt; 
  addCircles(
    data = incidents, popup = ~Resolution, 
    radius = 30, label = ~PdDistrict,
    lng = ~lon, lat = ~lat, color = ~color
  ) |&gt; 
  addLegend(&quot;topright&quot;, pal = colorFactor(
    palette = &quot;plasma&quot;, domain = unique(incidents$Resolution)
  ), values = incidents$Resolution, opacity = 1)</code></pre>
<div class="figure"><span style="display:block;" id="fig:incidents-leaflet"></span>
<img src="img/incidents-leaflet.png" class="full" alt="" />
<p class="caption">图 2.2:  2012 年旧金山警方出警地点的空间分布</p>
</div>
<p>接下来再细致一点地探索 incidents 数据集，各个警区出警次数的分布情况，</p>
<pre class="r"><code>library(data.table)
incidents &lt;- as.data.table(incidents)
library(ggplot2)
# SOUTHERN 警区的犯罪记录显著高于其他警区
dat &lt;- incidents[, .(cnt = length(IncidntNum)), by = c(&quot;PdDistrict&quot;, &quot;violent&quot;)]

ggplot(data = dat, aes(x = PdDistrict, y = cnt, fill = violent)) +
  geom_col()</code></pre>
<div class="figure"><span style="display:block;" id="fig:incidents-pddistrict"></span>
<img src="img/incidents-pddistrict.png" class="full" alt="" />
<p class="caption">图 2.3:  事件发生次数随警区的分布</p>
</div>
<p>进一步，可将图<a href="#fig:incidents-pddistrict">2.3</a>所示分布绘制在地图上，如图<a href="#fig:incidents">2.4</a>展示事件发生次数随警区的空间分布。</p>
<pre class="r"><code>dat &lt;- incidents[, .(cnt = length(IncidntNum), lat = mean(lat), lon = mean(lon)), by = c(&quot;violent&quot;, &quot;PdDistrict&quot;)]
# RgoogleMapsPlot 函数合成了地图和 lattice 分面绘图的能力
RgoogleMapsPlot(cnt ~ lat * lon | violent,
  data = dat,
  pch = 19, col = &quot;orangered&quot;,
  scales = list(
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  panel = panel.loaPlot, show.axes = TRUE
)</code></pre>
<div class="figure"><span style="display:block;" id="fig:incidents"></span>
<img src="img/incidents.png" class="full" alt="" />
<p class="caption">图 2.4:  事件发生次数随警区的<strong>空间</strong>分布：左图<strong>非暴力</strong>事件，右图<strong>暴力</strong>事件</p>
</div>
<p>再从全年来看，事件发生的时间分布，发现犯罪的高峰时段从下午 5-6 点一直持续到午夜 12 点。</p>
<pre class="r"><code>dat &lt;- incidents[, .(cnt = length(IncidntNum)), by = c(&quot;HrOfDay&quot;, &quot;violent&quot;)]
ggplot(data = dat, aes(x = HrOfDay, y = cnt, fill = violent)) +
  geom_col()</code></pre>
<div class="figure"><span style="display:block;" id="fig:incidents-hour"></span>
<img src="img/incidents-hour.png" class="full" alt="" />
<p class="caption">图 2.5:  事件发生次数随时段的分布</p>
</div>
<p>每次接报出警，警方会根据具体情况快速对事件定级分类，然后派出相应的警力以及处置方式。可以见事件性质 Category、是否发生暴力 violent 和警方处置方式 Resolution 应当有很强的关联。既然 Category， violent 和 Resolution 有很强的关联，展示关联关系非常重要，有的分类 Category 就应该给予足够的处置力度，特别对于暴力事件，关注警方的措施是否有不当或处置不力的？以此，还可以推测旧金山的治安状况。</p>
<pre class="r"><code>dat &lt;- incidents[, .(cnt = length(IncidntNum)), by = c(&quot;Category&quot;, &quot;violent&quot;, &quot;Resolution&quot;)]

ggplot(data = dat, aes(x = reorder(Category, cnt), y = cnt, fill = Resolution)) +
  geom_col() +
  coord_flip() +
  facet_grid(rows = vars(violent), scales = &quot;free&quot;, space = &quot;free&quot;) +
  labs(x = &quot;Category&quot;)</code></pre>
<div class="figure"><span style="display:block;" id="fig:incidents-resolution"></span>
<img src="img/incidents-resolution.png" class="full" alt="" />
<p class="caption">图 2.6:  事件性质和警方处置情况</p>
</div>
<p>从图<a href="#fig:incidents-resolution">2.6</a>看出，对于不同的事件 Category 有不同的执行措施 Resolution，执行措施和是否属于暴力有关系。一般来讲，暴力事件都应该有处置，发生暴力事件只有 5 类，按发生次数依次是打架斗殴、抢劫、性骚扰、绑架、盗窃，从图中也可看出盗窃是最多的犯罪事件。下表 <a href="#tab:incidents-category">2.1</a> 是对图中分类的中文翻译，笔者英文水平一般，翻译仅供参考。</p>
<table>
<caption><span id="tab:incidents-category">表 2.1: </span>事件性质</caption>
<thead>
<tr class="header">
<th align="left">Category</th>
<th align="left">Category_cn</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">LARCENY/THEFT</td>
<td align="left">盗窃</td>
</tr>
<tr class="even">
<td align="left">NON-CRIMINAL</td>
<td align="left">非犯罪</td>
</tr>
<tr class="odd">
<td align="left">OTHER OFFENSES</td>
<td align="left">其他罪行</td>
</tr>
<tr class="even">
<td align="left">ASSAULT</td>
<td align="left">打架斗殴</td>
</tr>
<tr class="odd">
<td align="left">VANDALISM</td>
<td align="left">蓄意破坏</td>
</tr>
<tr class="even">
<td align="left">DRUG/NARCOTIC</td>
<td align="left">毒品/麻醉品</td>
</tr>
<tr class="odd">
<td align="left">BURGLARY</td>
<td align="left">入室盗窃</td>
</tr>
<tr class="even">
<td align="left">VEHICLE THEFT</td>
<td align="left">车辆盗窃</td>
</tr>
<tr class="odd">
<td align="left">MISSING PERSON</td>
<td align="left">人员失踪</td>
</tr>
<tr class="even">
<td align="left">ROBBERY</td>
<td align="left">抢劫</td>
</tr>
<tr class="odd">
<td align="left">SUSPICIOUS OCC</td>
<td align="left">可疑的 OCC</td>
</tr>
<tr class="even">
<td align="left">FRAUD</td>
<td align="left">欺诈</td>
</tr>
<tr class="odd">
<td align="left">TRESPASS</td>
<td align="left">非法入侵</td>
</tr>
<tr class="even">
<td align="left">FORGERY/COUNTERFEITING</td>
<td align="left">伪造/假冒</td>
</tr>
<tr class="odd">
<td align="left">WEAPON LAWS</td>
<td align="left">武器法</td>
</tr>
<tr class="even">
<td align="left">DISORDERLY CONDUCT</td>
<td align="left">扰乱秩序</td>
</tr>
<tr class="odd">
<td align="left">RECOVERED VEHICLE</td>
<td align="left">回收车辆</td>
</tr>
<tr class="even">
<td align="left">DRIVING UNDER THE INFLUENCE</td>
<td align="left">非正常行驶</td>
</tr>
<tr class="odd">
<td align="left">DRUNKENNESS</td>
<td align="left">醉酒</td>
</tr>
<tr class="even">
<td align="left">SEX OFFENSES, FORCIBLE</td>
<td align="left">性骚扰</td>
</tr>
<tr class="odd">
<td align="left">RUNAWAY</td>
<td align="left">逃跑</td>
</tr>
<tr class="even">
<td align="left">KIDNAPPING</td>
<td align="left">绑架</td>
</tr>
<tr class="odd">
<td align="left">LOITERING</td>
<td align="left">游荡</td>
</tr>
<tr class="even">
<td align="left">LIQUOR LAWS</td>
<td align="left">酒法</td>
</tr>
<tr class="odd">
<td align="left">PROSTITUTION</td>
<td align="left">卖淫</td>
</tr>
<tr class="even">
<td align="left">ARSON</td>
<td align="left">纵火</td>
</tr>
<tr class="odd">
<td align="left">EMBEZZLEMENT</td>
<td align="left">挪用公款</td>
</tr>
<tr class="even">
<td align="left">EXTORTION</td>
<td align="left">勒索</td>
</tr>
<tr class="odd">
<td align="left">STOLEN PROPERTY</td>
<td align="left">被盗财产</td>
</tr>
<tr class="even">
<td align="left">GAMBLING</td>
<td align="left">赌博</td>
</tr>
<tr class="odd">
<td align="left">BAD CHECKS</td>
<td align="left">空头支票</td>
</tr>
<tr class="even">
<td align="left">PORNOGRAPHY/OBSCENE MAT</td>
<td align="left">色情/淫秽</td>
</tr>
<tr class="odd">
<td align="left">SUICIDE</td>
<td align="left">自杀</td>
</tr>
</tbody>
</table>
</div>
<div id="示例美国人口普查统计数据" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> 示例：美国人口普查统计数据</h2>
<p><strong>ggplot2</strong> 提供的 <code>map_data()</code> 函数可以从 <strong>maps</strong> 包中提取和转化地图数据，而 <code>coord_map()</code> 函数结合 <strong>mapproj</strong> 包可以实现坐标转化。下面以 R 内置的数据集 state.x77 为例，它记录了美国 1977 年 50 个州的人口普查情况，Population 各州的人口数量 （1975 年 7 月 1 日估计），Income 人均收入（1974年），Illiteracy 文盲比例（人口百分比），平均寿命（1969-1971年统计），Murder 谋杀和非过失杀人率（单位：十万分之一，1976年统计），HS Grad 高中毕业生百分比（1970 年统计），Frost 首都或大城市最低气温低于冰点的平均天数（1931-1960年统计），Area 土地面积（单位：平方英里）。如图<a href="#fig:ggplot2-statex77">2.7</a>， <strong>maps</strong> 包内置的美国各州的地图数据缺少夏威夷和阿拉斯加州。</p>
<pre class="r"><code>library(ggplot2)
# 准备地图数据
# maps 包的地图数据提取转为 data.frame 数据类型
states_map &lt;- map_data(map = &quot;state&quot;)
# 准备观测数据
state.x77 &lt;- data.frame(region = tolower(rownames(state.x77)), state.x77)

# 将观测数据合并进地图数据
states_map &lt;- merge(states_map, state.x77, by = &quot;region&quot;, all.x = TRUE, sort = FALSE)
# 地图数据排序保证地图绘制顺序
states_map &lt;- states_map[order(states_map$order), ]
# 绘图
ggplot(states_map, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(group = group, fill = Population)) +
  scale_fill_binned(
    type = &quot;viridis&quot;,
    guide = guide_colourbar(
      barwidth = 25, barheight = 0.4,
      title.position = &quot;top&quot; # 图例标题位于图例上方
    )
  ) +
  coord_map(projection = &quot;albers&quot;, lat0 = 45.5, lat1 = 29.5) +
  labs(x = &quot;Longitude&quot;, y = &quot;Latitude&quot;, fill = &quot;State Population (1975)&quot;) +
  theme_void() +
  theme(legend.position = &quot;bottom&quot;) # 图例位置图形下方</code></pre>
<div class="figure"><span style="display:block;" id="fig:ggplot2-statex77"></span>
<img src="img/ggplot2-statex77.png" class="full" alt="" />
<p class="caption">图 2.7:  1975年美国各个州的人口</p>
</div>
<p><a href="https://github.com/pdil/usmap/"><strong>usmap</strong></a> 提供 <code>plot_usmap()</code> 函数可谓专门用来绘制美国各州县的地图，包含夏威夷和阿拉斯加州，不包含波多黎各，参数 <code>data</code> 需要传入一个数据框，且必须有一列可以和地图提供的区域名称映射上，即需要有一列的列名是 state 或 fips。实际上，<strong>usmap</strong> 包 还内置有区县级地图数据，也支持抽取特定的州县，更多介绍见<a href="https://usmap.dev/">这里</a>。</p>
<pre class="r"><code>library(ggplot2)
state_x77 &lt;- data.frame(state = tolower(rownames(state.x77)), state_x77)

usmap::plot_usmap(data = state_x77, values = &quot;Population&quot;, labels = TRUE) +
  scale_fill_gradientn(
    colours = hcl.colors(10), na.value = &quot;grey90&quot;,
    guide = guide_colourbar(
      barwidth = 25, barheight = 0.4,
      title.position = &quot;top&quot; # 图例标题位于图例上方
    )
  ) +
  labs(fill = &quot;State Population (1975)&quot;) +
  theme(legend.position = &quot;bottom&quot;) # 图例位置图形下方</code></pre>
<div class="figure"><span style="display:block;" id="fig:usmap-statex77"></span>
<img src="img/usmap-statex77.png" class="full" alt="" />
<p class="caption">图 2.8:  1975年美国各个州的人口</p>
</div>
</div>
<div id="示例美国锡安公园地形数据" class="section level2" number="2.3">
<h2><span class="header-section-number">2.3</span> 示例：美国锡安公园地形数据</h2>
<p>美国西南部犹他州锡安国家公园的高程珊格数据 elevation，该数据集由 <a href="https://nowosad.github.io/">Jakub Nowosad</a> 收集于 <a href="https://github.com/Nowosad/spDataLarge">spDataLarge</a> 包内，由于该 R 包收集的地理信息数据很多又很大，超出了 <a href="https://cran.r-project.org/">CRAN</a> 对 R 包的大小限制，因此，需要从作者制作的 drat 站点下载。</p>
<pre class="r"><code>install.packages(&quot;spDataLarge&quot;, repos = &quot;https://nowosad.github.io/drat/&quot;)</code></pre>
<p>elevation 数据集通过雷达地形测绘 SRTM (Shuttle Radar Topography Mission) 获得，其分辨率为 90m <span class="math inline">\(\times\)</span> 90m，属于高精度地形网格数据，更多细节描述见 <a href="http://srtm.csi.cgiar.org/" class="uri">http://srtm.csi.cgiar.org/</a>，下图<a href="#fig:raster-elevation">2.9</a>将公园的地形清晰地展示出来了，读者不妨再借助维基百科词条 (<a href="https://en.wikipedia.org/wiki/Zion_National_Park" class="uri">https://en.wikipedia.org/wiki/Zion_National_Park</a>) 从整体上了解该公园的情况，结合丰富的实景图可以获得更加直观的感受。</p>
<div class="figure"><span style="display:block;" id="fig:raster-elevation"></span>
<img src="img/raster-elevation.png" class="full" alt="" />
<p class="caption">图 2.9:  <strong>terra</strong> 包绘制锡安国家公园地形</p>
</div>
<div class="rmdtip">
<p>R 软件内置的调色板 <code>terrain.colors()</code> 专用于地形图配色，从翠绿色、土黄色、沙白色，无不暗示海拔变化，读者不妨想象一下，山上的树呈翠绿色，山腰的砂石土块呈土黄色，山脚的河床小路呈沙白色，十分符合我国南方的丘陵山地印象。</p>
</div>
</div>
</div>
<div id="可视化包" class="section level1" number="3">
<h1><span class="header-section-number">3</span> 可视化包</h1>
<p>本节主要介绍几个 R 语言社区提供的地理可视化 R 包，分别是绘制交互式地图的 <strong>echarts4r</strong> 包 <span class="citation">[<a href="#ref-echarts4r" role="doc-biblioref">4</a>]</span>、<strong>leaflet</strong> 包和 <strong>plotly</strong> 包。它们各有千秋， <strong>echarts4r</strong> 背靠 <a href="https://github.com/apache/echarts">Apache Echarts</a> 功能覆盖面比较广，但是还不够精纯，在易用性和性能上还有较大提升空间，此外，在统计方面有些弱，比如分组线性回归很难实现。<strong>leaflet</strong> 专注于交互式地理可视化，支持常见的矢量和栅格数据对象。<strong>plotly</strong> 背后的支持来自商业公司，上游依赖是开源的JavaScript 库<a href="https://github.com/plotly">plotly</a>，深耕多年，功能全面，使用的体感是性能比较差。</p>
<p>地理可视化的 R 包是有很多的，本文无法穷尽。<a href="https://github.com/trulia/choroplethr">choroplethr</a> 和<a href="https://github.com/trulia/choroplethrMaps">choroplethrMaps</a> 主要用来制作地区分布图，需要的区域数据，<strong>choroplethrMaps</strong> 包提供三份地图数据，分别是美国州、县地图和世界地图，相关介绍材料见<a href="https://arilamstein.com/open-source/">这里</a>。<a href="https://github.com/r-tmap/tmap">tmap</a> 制作交互地图，<a href="https://github.com/riatelab/mapsf">mapsf</a> 制作符号地图、等值地图、拓扑地图，关于各类地图的可视化示例见<a href="https://antv.vision/zh">AntV 官网</a>。<a href="https://github.com/michaeldorman/mapsapi">mapsapi</a> 可以连接 4 种 Google 提供的 Web 地图服务。</p>
<p>地理可视化的展示形式有多种，散点图、气泡图、峰窝图和热度图等，还可以有更加复合的专题地图，如在地图上省、市、区、县一级别，显示各个年龄段的人口比例，类似将饼图贴在地图上。为简单起见，主要以散点图为例介绍入门级别的内容。</p>
<div id="echarts4r" class="section level2" number="3.1">
<h2><span class="header-section-number">3.1</span> echarts4r</h2>
<p><strong>echarts4r</strong> 支持使用多种地图服务，包括 OSM（OpenStreetMap）、Mapbox、谷歌、高德等，只要提供引用瓦片服务数据模版即可。<strong>echarts4r</strong> 内置了一份矢量地图数据，如图<a href="#fig:quakes-echarts4r">3.1</a>所示。简单起见，这里使用了 R 内置的数据集 quakes，它描述了太平洋岛国斐济及周边自 1964 年以来的四级以上的地震活动。从图中不难看出有两个非常清晰的地震带。结合背景材料，一个在主要板块交界处，另一个是新西兰附近的汤加海沟。火山爆发和地震不是一回事，但紧密相连。2022年1月14日，汤加海底火山爆发，引发海啸等一系列自然灾害，中国地震局也发布新闻资讯—<a href="https://www.cea.gov.cn/cea/xwzx/fzjzyw/5647231/index.html">汤加火山喷发，会造成哪些影响？</a>详细介绍了这一事件。</p>
<pre class="r"><code>library(echarts4r)
# 使用默认的地图
quakes |&gt;
  e_charts(x = long) |&gt;
  e_geo(
    roam = TRUE,
    map = &quot;world&quot;,
    boundingCoords = list(
      c(165.67, -38.59),
      c(188.13, -10.72)
    )
  )  |&gt;
  e_scatter(
    serie = lat, size = mag, name = &quot;Fiji&quot;,
    coord_system = &quot;geo&quot;
  ) |&gt;
  e_visual_map(mag, scale = e_scale)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-echarts4r"></span>
<img src="img/quakes-echarts4r.png" class="full" alt="" />
<p class="caption">图 3.1:  <strong>echarts4r</strong> 使用内置矢量地图数据</p>
</div>
<p><strong>echarts4r</strong> 提供地理图层 <code>e_geo()</code> 专门用来加载地图数据，在这个例子中，只需要展示局部地图，因此基于数据集 quakes 提取经纬度范围，获取了边界信息，设置了参数 <code>boundingCoords</code>，即矩形的左上顶点和右下顶点的两个坐标，关于其它参数更加详尽的介绍，见 Apache Echarts 官方文档里 <a href="https://echarts.apache.org/en/option.html#geo.boundingCoords">地理图层</a>。下面做一些更加细致的调整，最终效果如图<a href="#fig:quakes-chalk">3.2</a>。</p>
<ul>
<li><code>e_effect_scatter()</code> 替换 <code>e_scatter()</code> 实现一些动态特效，和地震的震波建立一些视觉联系，不过会增加渲染压力；设置 <code>scale = NULL</code> 去掉默认对 size 变量的尺度变换；</li>
<li><code>e_title()</code> 添加一些文字介绍斐济地震带背后的数据背景；</li>
<li><code>e_tooltip()</code> 参考 Apache Echarts 官方文档<a href="https://echarts.apache.org/zh/option.html#geo.tooltip.formatter">tooltip</a>在气泡上定制悬浮提示，补充震点位置和震级信息，定性和定量结合；</li>
<li><code>e_visual_map()</code> 设置透明度缓解数据点覆盖，设置颜色和气泡大小的变化范围，设置组件两端的文本，设置组件的位置为右下角，更多设置详见<a href="https://echarts.apache.org/zh/option.html#visualMap">视觉映射组件</a>；</li>
<li><code>e_legend()</code> 隐藏图例，已用 <code>e_visual_map()</code> 替代；</li>
<li><code>e_theme()</code> 参考<a href="https://echarts.apache.org/zh/theme-builder.html">主题配置页面</a>挑选黑色背景主题。</li>
</ul>
<pre class="r"><code># 使用默认的地图
annotation_point &lt;- c(-21.0744, 183.7499, 0, 7, 0)
quakes &lt;- rbind(quakes, annotation_point) # 把这个点加到数据集里面
# 新加一列专用于文本注释
quakes$annotation &lt;- &#39; &#39;
quakes[which(quakes$lat == -21.0744 &amp; quakes$long == 183.7499), ]$annotation &lt;- &#39;汤加火山&#39;

# 绘图
quakes |&gt;
  e_charts(x = long) |&gt;
  e_geo(
    roam = TRUE,
    map = &quot;world&quot;,
    boundingCoords = list(
      c(165.67, -38.59),
      c(188.13, -10.72)
    )
  ) |&gt;
  e_effect_scatter(
    serie = lat,
    scale = NULL, # 去掉尺度变换
    bind = annotation, # 用于 params.name
    size = mag, 
    name = &quot;地震点&quot;,
    coord_system = &quot;geo&quot;
  ) |&gt;
  e_visual_map(
    serie = mag, # 震级图例
    right = 0, bottom = 0, # 图例的位置，离容器右侧和下侧的距离
    text  = c(&quot;高&quot;, &quot;低&quot;), # 定义两端的文本
    textStyle = list(color = &quot;white&quot;),
    inRange = list(
      color = hcl.colors(10), # 填充颜色
      colorAlpha = 0.7, # 设置透明度
      symbolSize = c(1, 15) # 设置气泡大小
    )
  ) |&gt;
  e_labels(
    position = &#39;top&#39;,
    formatter = htmlwidgets::JS(&quot;function(params){return( params.name )}&quot;)
  ) |&gt; 
  e_tooltip(
    formatter = htmlwidgets::JS(&quot;
        function(params) {
          return(&#39;&lt;strong&gt;&#39; + params.seriesName + &#39;&lt;/strong&gt;&#39; + 
          &#39;&lt;br&gt;经度：&#39; + params.value[0] + 
          &#39;&lt;br&gt;纬度：&#39; + params.value[1] + 
          &#39;&lt;br&gt;震级：&#39; + params.value[2])
        }
      &quot;)
  ) |&gt;
  e_title(
    text = &quot;斐济地震带&quot;,
    subtext = &quot;斐济是南太平洋上的一个岛国&quot;,
    left = &quot;center&quot;,
    sublink = &quot;https://echarts4r.john-coene.com/&quot;
  ) |&gt; 
  e_legend(show = FALSE) |&gt;  # 隐藏图例
  e_theme(name = &quot;chalk&quot;)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-chalk"></span>
<img src="img/quakes-chalk.png" class="full" alt="" />
<p class="caption">图 3.2:  <strong>echarts4r</strong> 使用内置矢量地图数据</p>
</div>
<p>下面介绍在瓦片地图数据的基础上展示 quakes 数据，如图<a href="#fig:quakes-osm">3.3</a> 所示，这里采用地理图层 <code>e_leaflet()</code> 调用开放的 OpenStreetMap 瓦片服务。</p>
<pre class="r"><code># OSM
quakes |&gt;
  e_charts(long) |&gt;
  e_leaflet(center = c(175, -20), zoom = 4) |&gt;
  e_leaflet_tile() |&gt;
  e_scatter(lat, size = mag, coord_system = &quot;leaflet&quot;)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-osm"></span>
<img src="img/quakes-osm.png" class="full" alt="" />
<p class="caption">图 3.3:  <strong>echarts4r</strong> 使用 OpenStreetMap 地图</p>
</div>
<p>只要提供瓦片地图服务的模版，就可以切换地图底图数据，图<a href="#fig:quakes-ggmap">3.4</a>使用了谷歌的地图服务。</p>
<pre class="r"><code># 谷歌地图
quakes |&gt;
  e_charts(long) |&gt;
  e_leaflet(center = c(175, -20), zoom = 4) |&gt;
  e_leaflet_tile(
    template = &quot;http://mt2.google.cn/vt/lyrs=m@167000000&amp;hl=zh-CN&amp;gl=cn&amp;x={x}&amp;y={y}&amp;z={z}&amp;s=Galil&quot;,
    options = list(tileSize = 256, minZoom = 3, maxZoom = 17)
  ) |&gt;
  e_scatter(lat, size = mag, coord_system = &quot;leaflet&quot;)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-ggmap"></span>
<img src="img/quakes-ggmap.png" class="full" alt="" />
<p class="caption">图 3.4:  <strong>echarts4r</strong> 使用谷歌地图</p>
</div>
<p>类似谷歌的要求，使用 Mapbox 地图服务也需要先申请个人访问令牌，申请下来后，也把它设置到 R 语言环境变量里 <code>MAPBOX_TOKEN</code>，以便后续使用。</p>
<pre class="r"><code># MAPBOX 地图
quakes |&gt;
  e_charts(long) |&gt;
  e_mapbox(
    # MAPBOX 的访问令牌
    token = Sys.getenv(&quot;MAPBOX_TOKEN&quot;),
    # 地图风格样式
    style = &quot;mapbox://styles/mapbox/dark-v9&quot;,
    # 视角：地图中心
    center = c(175, -20),
    # 缩放等级
    zoom = 4
  ) |&gt;
  e_scatter_3d(lat, mag, coord_system = &quot;mapbox&quot;) |&gt;
  e_visual_map(mag)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-mapbox"></span>
<img src="img/quakes-mapbox.png" class="full" alt="" />
<p class="caption">图 3.5:  <strong>echarts4r</strong> 使用 MAPBOX 地图</p>
</div>
<p>在国内，最好使用百度、高德这样的国家认可的地图服务提供商，这也很容易，只需用高德的 tile 服务数据替换 OSM 的。</p>
<pre class="r"><code># 高德地图
quakes |&gt;
  e_charts(long) |&gt;
  e_leaflet(center = c(175, -20), zoom = 4) |&gt;
  e_leaflet_tile(
    template = &quot;https://webrd02.is.autonavi.com/appmaptile?lang=zh_cn&amp;size=1&amp;scale=1&amp;style=8&amp;x={x}&amp;y={y}&amp;z={z}&quot;,
    options = list(tileSize = 256, minZoom = 3, maxZoom = 17)
  ) |&gt;
  e_scatter(lat, size = mag, coord_system = &quot;leaflet&quot;)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-amap"></span>
<img src="img/quakes-amap.png" class="full" alt="" />
<p class="caption">图 3.6:  <strong>echarts4r</strong> 使用高德地图</p>
</div>
<p>另外，袁凡整理的材料 — <a href="https://cosx.org/2021/12/introduction-to-echarts4r/"><strong>echarts4r</strong>: 从入门到应用</a>，详细介绍了如何用 <strong>echarts4r</strong> 绘制各种各样的常用图形，如何引入外部地图数据制图，文章完全基于用 R Markdown 编译，图文并茂，内容可重复。苏玮制作的 <a href="https://github.com/swsoyee/2019-ncov-japan">日本新冠疫情看板</a> 也大量使用 <strong>echarts4r</strong>，可见 <strong>echarts4r</strong> 能力之强，此看板适合比较高阶的 R 语言读者学习，地理可视化的定制化程度比较高。</p>
<p>百度、阿里、腾讯等公司都提供大量面向不同场景的地图服务，一些软件也内置了地图，如<a href="https://www.tableau.com/products/desktop">tableau</a>、<a href="https://grass.osgeo.org/">GRASS GIS</a> 和<a href="https://www.qgis.org/">QGIS</a>等，下图<a href="#fig:qgis">3.7</a> 展示 QGIS 软件使用在线的 OpenStreetMap 地图。</p>
<div class="figure"><span style="display:block;" id="fig:qgis"></span>
<img src="img/qgis.png" class="full" alt="" />
<p class="caption">图 3.7:  QGIS 软件内的 OpenStreetMap 地图</p>
</div>
</div>
<div id="leaflet" class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> leaflet</h2>
<p><strong>leaflet</strong> <span class="citation">[<a href="#ref-leaflet" role="doc-biblioref">3</a>]</span> 包借助 <a href="https://github.com/ramnathv/htmlwidgets"><strong>htmlwidgets</strong></a> 封装了鼎鼎大名的开源交互式可视化地图库 <a href="https://leafletjs.com/">leaflet</a>。注意，leaflet 只是一个渲染 GIS 数据的可视化库，并不提供 GIS 数据服务。类似的可视化库还有<a href="https://github.com/openlayers/openlayers">OpenLayers</a>，及其 R 接口<a href="https://github.com/crazycapivara/openlayers">openlayers</a>，另一个紧密相关的空间数据处理工具是<a href="https://github.com/geoserver/geoserver">GeoServer</a>，它遵循 Open Geospatial Consortium (OGC) Web Feature Service (WFS) 和 Web Coverage Service (WCS) 标准，支持各种 GIS 数据源。</p>
<p>在可视化的过程中，配色是非常重要的一个环节，准确地表达地图上各个区域或位置的数据信息，负责体现分类、层次、大小等信息。常见的操作是将一组数据映射成一组颜色值，还是以 quakes 数据集为例，下面将连续型的地震震级数据映射成一组颜色值。这方面的工作已经有非常成熟的 R 包来做了，比如<a href="https://github.com/r-lib/scales"><strong>scales</strong></a>包和<a href="https://github.com/SymbolixAU/colourvalues"><strong>colourvalues</strong></a> 包。如图 <a href="#fig:quakes-viridis">3.8</a>，默认情况下 <code>viridis</code> 调色板，颜色越黄值越大。</p>
<pre class="r"><code># 将连续型数据向量转化为颜色向量
colorize_numeric &lt;- function(x) {
  scales::col_numeric(palette = &quot;viridis&quot;, domain = range(x))(x)
}
# 在数据集 quakes 上添加新的一列数据 color
quakes &lt;- transform(quakes, color = colorize_numeric(mag))
# 绘制散点图
plot(data = quakes, lat ~ long, col = color, pch = 19)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-viridis"></span>
<img src="img/quakes-viridis.png" class="full" alt="" />
<p class="caption">图 3.8:  地震震级映射连续的颜色值</p>
</div>
<p>另一种情况是将分类型的变量映射上颜色，这通常采用分类型的调色板，比如 <code>Set2</code>。所有常用的调色板可见 <strong>RColorBrewer</strong> 包，在命令行中直接运行 <code>RColorBrewer::display.brewer.all()</code> 即可预览。稍微值得注意的是当分类太多，超出了调色板的数量，需要自己构造一下，比如 <code>Set2</code> 只有8种颜色，但是需要10种，可通过如下方法插值构造：</p>
<pre class="r"><code>colorRampPalette(colors = RColorBrewer::brewer.pal(n = 8, name = &quot;Set2&quot;))(10)
#  [1] &quot;#66C2A5&quot; &quot;#DA9870&quot; &quot;#BE979C&quot; &quot;#AB98C8&quot; &quot;#DF92B6&quot; &quot;#ADCF60&quot; &quot;#E1D83B&quot; &quot;#F3CF5B&quot;
#  [9] &quot;#D9C09A&quot; &quot;#B3B3B3&quot;</code></pre>
<p>如图 <a href="#fig:quakes-set2">3.9</a> 所示，用不同颜色表示不同种类的鸢尾花。</p>
<pre class="r"><code># 注意因子水平个数
colorize_factor &lt;- function(x) {
  scales::col_factor(palette = &quot;Set2&quot;, levels = unique(x))(x)
}
# 给每个点设置一个颜色
iris &lt;- transform(iris, color = colorize_factor(Species))
# 绘图
plot(data = iris, Petal.Length ~ Petal.Width, col = color, pch = 19)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-set2"></span>
<img src="img/quakes-set2.png" class="full" alt="" />
<p class="caption">图 3.9:  三种鸢尾花用不同颜色标记</p>
</div>
<p>实际上，还可以将地震震级分段，用梯度变化的颜色表示震级的大小，如图<a href="#fig:quakes-leaflet">3.10</a>所示。</p>
<pre class="r"><code>library(leaflet)
data(quakes)
# 构造 Pop 提示
quakes$popup_text &lt;- lapply(paste(
  &quot;编号:&quot;, &quot;&lt;strong&gt;&quot;, quakes$stations, &quot;&lt;/strong&gt;&quot;, &quot;&lt;br&gt;&quot;,
  &quot;震深:&quot;, quakes$depth, &quot;&lt;br&gt;&quot;,
  &quot;震级:&quot;, quakes$mag
), htmltools::HTML)
# 构造调色板
pal &lt;- colorBin(&quot;Spectral&quot;, bins = pretty(quakes$mag), reverse = TRUE)
# 绘图可视化
leaflet(quakes, options = leafletOptions(attributionControl = FALSE)) |&gt;
  addProviderTiles(providers$CartoDB.Positron) |&gt;
  # 添加带颜色的散点图
  addCircles(lng = ~long, lat = ~lat, color = ~ pal(mag), label = ~popup_text) |&gt;
  # 在右下角添加图例
  addLegend(&quot;bottomright&quot;, pal = pal, values = ~mag, title = &quot;地震震级&quot;) |&gt;
  # 在左下角添加地图比例尺
  addScaleBar(position = c(&quot;bottomleft&quot;))</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-leaflet"></span>
<img src="img/quakes-leaflet.png" class="full" alt="" />
<p class="caption">图 3.10: 散点图</p>
</div>
<p><a href="https://github.com/bhaskarvk/leaflet.extras"><strong>leaflet.extras</strong></a> 提供绘制热力图的扩展，另一个与之类似的包是<a href="https://github.com/trafficonese/leaflet.extras2"><strong>leaflet.extras2</strong></a> 包，前者虽已停止开发了，但是目前看来还可以用。</p>
<pre class="r"><code>#  提供 addHeatmap 函数绘制热力图 
library(leaflet.extras) 

leaflet(quakes) |&gt; 
  addProviderTiles(providers$CartoDB.Positron) |&gt; 
  addCircles(lng = ~long, lat = ~lat, color = ~ pal(mag), label = ~popup_text) |&gt; 
  setView(178, -25, 5) |&gt; 
  addHeatmap(
    lng = ~long, lat = ~lat, intensity = ~mag,
    blur = 20, max = 0.05, radius = 15
  ) |&gt;  
  addLegend(&quot;bottomright&quot;, pal = pal, values = ~mag, title = &quot;地震震级&quot;) |&gt; 
  addScaleBar(position = &quot;bottomleft&quot;)</code></pre>
<p>绘制热力图就这么简单，如图 <a href="#fig:quakes-heatmap">3.11</a> 所示，在图<a href="#fig:quakes-leaflet">3.10</a>的基础上添加了热力图，实际上就是根据点的密度添加色彩，密度值根据核密度估计算法统计出来。</p>
<div class="figure"><span style="display:block;" id="fig:quakes-heatmap"></span>
<img src="img/quakes-heatmap.png" class="full" alt="" />
<p class="caption">图 3.11: 热力图</p>
</div>
</div>
<div id="plotly" class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> plotly</h2>
<p><strong>plotly</strong> <span class="citation">[<a href="#ref-plotly" role="doc-biblioref">5</a>]</span> 包在地理可视化方面提供散点图 <a href="https://plotly.com/r/reference/scattergeo/">scattergeo</a> 和等值图 <a href="https://plotly.com/r/reference/choropleth/">choropleth</a> 两种基础类型。<strong>plotly</strong> 还为 <a href="https://mapbox.com/">mapbox</a> 地图服务添加三个专门的绘图函数，分别是散点图<a href="https://plotly.com/r/reference/scattermapbox/">scattermapbox</a>、等值图<a href="https://plotly.com/r/reference/choroplethmapbox/">choroplethmapbox</a>和热力图<a href="https://plotly.com/r/reference/densitymapbox/">densitymapbox</a>。</p>
<pre class="r"><code>plotly::plot_mapbox(
  data = quakes, colors = &quot;Spectral&quot;,
  lon = ~long, lat = ~lat, color = ~mag,
  type = &quot;scattermapbox&quot;, mode = &quot;markers&quot;,
  marker = list(size = 10, opacity = 0.5)
) |&gt;
  plotly::layout(
    title = &quot;斐济地震带&quot;,
    # mapbox 地图设置 https://plotly.com/r/reference/layout/mapbox/
    mapbox = list(
      # style = &#39;dark&#39;, # 暗黑主题
      zoom = 4, # 缩放级别
      center = list(lat = -20, lon = 175)
    )
  ) |&gt;
  plotly::colorbar(title = &quot;震级&quot;) |&gt;
  plotly::config(
    mapboxAccessToken = Sys.getenv(&quot;MAPBOX_TOKEN&quot;),
    displayModeBar = FALSE
  )</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-plotly"></span>
<img src="img/quakes-plotly.png" class="full" alt="" />
<p class="caption">图 3.12:  <strong>plotly</strong> 包使用 Mapbox 地图</p>
</div>
<p>接下来介绍布局设置，以 <code>layout(mapbox = ...)</code> 内的 style 参数为例， 它是用来设置地图风格样式的，除了默认的参数值 <code>basic</code>，还可以设置为夜晚暗黑 <code>dark</code>，卫星地图 <code>satellite</code> 等。若设置<code>open-street-map</code>，调 OpenStreetMap 服务，则无需 <code>MAPBOX_TOKEN</code>，具体哪些用到 <code>MAPBOX_TOKEN</code> 哪些不需要用到 <code>MAPBOX_TOKEN</code>，读者可以根据需要选择，详见<a href="https://plotly.com/r/mapbox-layers/">mapbox-layers 文档</a>，其他参数设置见<a href="https://plotly.com/r/reference/layout/mapbox/">mapbox 文档</a>。</p>
<div class="figure"><span style="display:block;" id="fig:quakes-satellite"></span>
<img src="img/quakes-satellite.png" class="full" alt="" />
<p class="caption">图 3.13:  <strong>plotly</strong> 包使用 Mapbox 卫星地图</p>
</div>
<pre class="r"><code>plotly::plot_ly(
  data = quakes,
  type = &quot;densitymapbox&quot;,
  lat = ~lat,
  lon = ~long,
  coloraxis = &quot;coloraxis&quot;,
  radius = 10
) |&gt; 
  plotly::layout(
    mapbox = list(
      style = &quot;stamen-terrain&quot;,
      zoom = 4,
      center = list(lat = -25, lon = 178)
    ), coloraxis = list(colorscale = &quot;Viridis&quot;)
  ) |&gt; 
  plotly::config(displayModeBar = FALSE)</code></pre>
<div class="figure"><span style="display:block;" id="fig:mapbox-density"></span>
<img src="img/mapbox-density.png" class="full" alt="" />
<p class="caption">图 3.14:  <strong>plotly</strong> 包使用 Mapbox 绘制热力图</p>
</div>
<p><strong>plotly</strong> 包内置了两个地图数据集，一个是美国州级多边形数据<code>"USA-states"</code>，另一个是国家级多边形数据，来自 Natural Earth，需要3个字母的国家代码传给参数 <code>locations</code>。</p>
<pre class="r"><code>dat &lt;- data.frame(state.x77,
  stats_abbr = state.abb
)
# 地理单元名称要和 stats_abbr 保持一致
plotly::plot_ly(
  data = dat,
  type = &quot;choropleth&quot;,
  locations = ~stats_abbr, # 两个字母的州名缩写
  locationmode = &quot;USA-states&quot;, # 地理几何地图数据
  colorscale = &quot;Viridis&quot;, # 其它调色板如 &quot;RdBu&quot;
  z = ~Population
) |&gt;
  plotly::colorbar(title = &quot;人口&quot;) |&gt; 
  plotly::layout(
    geo = list(scope = &quot;usa&quot;),
    title = &quot;1974年美国各州的人口&quot;
  ) |&gt;
  plotly::config(displayModeBar = FALSE)</code></pre>
<div class="figure"><span style="display:block;" id="fig:mapbox-choropleth"></span>
<img src="img/mapbox-choropleth.png" class="full" alt="" />
<p class="caption">图 3.15:  <strong>plotly</strong> 包使用 Mapbox 绘制面量图</p>
</div>
<p>多边形矢量地图数据，多边形的边界常常是行政区域，choropleth 地图是填充颜色的多边形，颜色深浅表示数据指标，地图的作用在于展示指标的空间变化，在美国，郡县一级的行政区大致相当于咱们市一级行政单位，比如图<a href="#fig:mapbox-choropleth-counties">3.16</a> 展示美国各个县的失业率，大城市失业率相对较高。值得注意，数据量较大的时<strong>plotly</strong>渲染速度较慢。</p>
<pre class="r"><code># 示例修改自 https://plotly.com/r/choropleth-maps/
library(plotly)
# 数据集来自 https://github.com/plotly/datasets
# 下载保存至本地目录
data_dir &lt;- &quot;~/Documents/Github/plotly-datasets&quot;
# 准备地图数据
map_url &lt;- paste(data_dir, &quot;geojson-counties-fips.json&quot;, sep = &quot;/&quot;)
# 读取 GeoJSON 格式地图数据
counties &lt;- rjson::fromJSON(file = map_url)
# 准备观测数据
data_url &lt;- paste(data_dir, &quot;fips-unemp-16.csv&quot;, sep = &quot;/&quot;)
# 导入行政编码和失业率数据
df &lt;- read.csv(data_url, colClasses = c(fips = &quot;character&quot;))
# 绘图
plotly::plot_ly(
  data = df,
  type = &quot;choropleth&quot;, # 图形种类
  geojson = counties,  # GeoJSON 地图数据
  locations = ~fips,   # 类似行政编码
  z = ~unemp,  # 失业率
  colorscale = &quot;Viridis&quot;, # 调色板
  zmin = 0,  # 有颜色映射的失业率下限
  zmax = 12,
  marker = list(line = list(
    width = 0 # 去掉每个县的边界线
  ))
) |&gt; 
  plotly::colorbar(title = &quot;失业率 (%)&quot;) |&gt; 
  plotly::layout(
    title = &quot;2016 年美国各个县的失业率&quot;,
    # 参数设置详见 https://plotly.com/r/reference/layout/geo/
    geo = list(
      scope = &quot;usa&quot;, 
      # 地图聚焦到 USA，其它取值有 &quot;africa&quot; 和 &quot;asia&quot; 等
      projection = list(type = &quot;albers usa&quot;), 
      # 投影方式，常用的还有 &quot;mercator&quot; 等
      showlakes = TRUE, # 显示湖
      lakecolor = plotly::toRGB(&quot;white&quot;) # 湖以白色填充
    )
  ) |&gt; 
  plotly::config(displayModeBar = FALSE)</code></pre>
<div class="figure"><span style="display:block;" id="fig:mapbox-choropleth-counties"></span>
<img src="img/mapbox-choropleth-counties.png" class="full" alt="" />
<p class="caption">图 3.16:  <strong>plotly</strong> 包使用 Mapbox 绘制面量图</p>
</div>
<p>函数 <code>plot_ly(locations = ~fips,...)</code> 传进去的参数值 fips（Federal Information Processing Standards，即联邦信息处理标准，简称 FIPS）。FIPS 类似我国的行政区划编码，美国地图上每一块区域都有唯一的一个代码对应，详见<a href="https://en.wikipedia.org/wiki/FIPS_county_code">FIPS 代码</a>。观测数据需要和地图数据 GeoJSON 里每个 feature（代表一个地理单元）的 id 或 properties （地理单元的各个属性值）下的主键性质的属性值映射。进一步，读者可参考<a href="https://plotly.com/r/choropleth-maps/">choropleth-maps</a>文档中的示例。</p>
</div>
<div id="lattice" class="section level2" number="3.4">
<h2><span class="header-section-number">3.4</span> lattice</h2>
<p>2001 年 <strong>lattice</strong> 包就发布到 CRAN 了，已经过去20多年了，功能相当全面成熟稳定，内置于 R 软件。下面介绍 <strong>lattice</strong> 包的数据可视化能力，继续以 quakes 数据集为例展开介绍。</p>
<pre class="r"><code>library(lattice)
# 散点图
xyplot(lat ~ long,
  data = quakes,
  scales = list(
    draw = T,
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  pch = 19, alpha = 0.3, 
  cex = 1.5, col = &quot;darkgreen&quot;,
  grid = TRUE # 添加背景网格线
)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-xyplot"></span>
<img src="img/quakes-xyplot.png" class="full" alt="" />
<p class="caption">图 3.17: 散点图</p>
</div>
<pre class="r"><code># 仅保留低密度区域上的散点
xyplot(lat ~ long,
  data = quakes,
  scales = list(
    draw = T,
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  panel = function(x, y, ...) {
    panel.smoothScatter(x, y, ...,
      colramp = hcl.colors, # 可用其它调色板，比如 terrain.colors
      pch = 19
    )
  }
)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-smooth"></span>
<img src="img/quakes-smooth.png" class="full" alt="" />
<p class="caption">图 3.18: 热力图</p>
</div>
<pre class="r"><code>library(loa)
# 气泡图
loaPlot(mag ~ long * lat,
  data = quakes,
  col.regions = &quot;Spectral&quot;,
  alpha = 0.6, 
  scales = list(
    draw = T,
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  )
)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-bubble"></span>
<img src="img/quakes-bubble.png" class="full" alt="" />
<p class="caption">图 3.19: 气泡图</p>
</div>
<pre class="r"><code># 蜂窝图
loaPlot(mag ~ long * lat,
  data = quakes,
  panel = panel.binPlot, 
  breaks = 30, 
  statistic = max,
  col.regions = &quot;Spectral&quot;,
  scales = list(
    draw = T,
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  )
)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-binplot"></span>
<img src="img/quakes-binplot.png" class="full" alt="" />
<p class="caption">图 3.20: 蜂窝图</p>
</div>
<pre class="r"><code># 等高图
loaPlot(mag ~ long * lat,
  data = quakes,
  panel = panel.surfaceSmooth, 
  too.far = 0.1,
  col.regions = &quot;Spectral&quot;,
  scales = list(
    draw = T,
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  )
)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-contour"></span>
<img src="img/quakes-contour.png" class="full" alt="" />
<p class="caption">图 3.21: 等高图</p>
</div>
<p>就地震数据集 quakes 来说，它还有地震深度变量，实际上，完整地描述一个地震的位置，当然需要震深，想要立体化地呈现出来必须借助三维图形。<strong>lattice</strong> 包就具备绘制三维图形的能力，如图<a href="#fig:quakes-cloud">3.22</a>所示，此外，<a href="https://github.com/dmurdoch/rgl"><strong>rgl</strong></a> 包<span class="citation">[<a href="#ref-rgl" role="doc-biblioref">6</a>]</span>可以绘制交互式的<strong>真三维</strong>图形，如图<a href="#fig:quakes-rgl">3.23</a>。</p>
<pre class="r"><code>quakes &lt;- transform(quakes, cex = mag - 4)
# 三维气泡图
cloud(-depth ~ long * lat,
  data = quakes, pch = 19,
  col = quakes$color, # 气泡颜色映射震级
  cex = quakes$cex, # 气泡大小映射震级
  # z 轴标签旋转 90 度
  scales = list(
    arrows = FALSE, col = &quot;black&quot;,
    z = list(rot = 90)
  ),
  # 减少三维图形的边空
  lattice.options = list(
    layout.widths = list(
      left.padding = list(x = -.6, units = &quot;inches&quot;),
      right.padding = list(x = -1.0, units = &quot;inches&quot;)
    ),
    layout.heights = list(
      bottom.padding = list(x = -.8, units = &quot;inches&quot;),
      top.padding = list(x = -1.0, units = &quot;inches&quot;)
    )
  ),
  # 设置坐标轴字体大小
  par.settings = list(
    axis.line = list(col = &quot;transparent&quot;),
    fontsize = list(text = 15, points = 10)
  ),
  # 设置三维图的观察方位
  screen = list(z = 30, x = -65, y = 0)
)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-cloud"></span>
<img src="img/quakes-cloud.png" class="full" alt="" />
<p class="caption">图 3.22:  <strong>lattice</strong> 包绘制三维气泡图</p>
</div>
<pre class="r"><code># 设置 WebGL 渲染
options(rgl.useNULL = TRUE)
options(rgl.printRglwidget = TRUE)
library(rgl)
with(quakes, {
  plot3d(
    x = long, y = lat, z = -depth,
    col = color, size = mag - 4, type = &quot;s&quot;
  )
})</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-rgl"></span>
<img src="img/quakes-rgl.png" class="full" alt="" />
<p class="caption">图 3.23:  <strong>rgl</strong> 包绘制三维气泡图</p>
</div>
<p>结合三维气泡图，也许读者已经发现震级和震深有一些关系，不妨再看看仔细它们之间关系，如图<a href="#fig:quakes-mag">3.24</a>。</p>
<pre class="r"><code># 数据抖动和透明度是为了减轻数据点的覆盖情况
stripplot(depth ~ factor(mag),
  data = quakes,
  jitter.data = TRUE, alpha = 0.6,
  main = &quot;Depth of earthquake epicenters by magnitude&quot;,
  xlab = &quot;Magnitude (Richter)&quot;,
  ylab = &quot;Depth (km)&quot;,
  col = &quot;black&quot;,
  grid = TRUE
)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-mag"></span>
<img src="img/quakes-mag.png" class="full" alt="" />
<p class="caption">图 3.24: 抖动图</p>
</div>
<p>无论震级如何，地震似乎集中发生在表层或深层的位置，中间带反而比较稀疏，可见震级和地震的位置关系不大，地不地震、震级如何主要是由地质条件决定的。</p>
</div>
</div>
<div id="数据结构" class="section level1" number="4">
<h1><span class="header-section-number">4</span> 数据结构</h1>
<p>本节开始介绍一些空间数据相关的基础知识，R 语言有一些扩展包是专门处理空间数据的，提供基础数据结构和类型，了解这些是为空间数据操作、分析、建模打基础。空间数据操作（Spatial Data Manipulation），如计算空间区域的面积、空间点的路径、区域叠加、基于空间关系的数据查询等。空间数据分析（Spatial Data Analysis），空间数据的描述性分析和探索性分析，帮助发现数据中的模式规律。空间统计分析（Spatial Statistical Analysis），传统的统计模型认为观测值之间常常是独立的，而空间数据自带空间相关性，需要专门的统计分析方法。空间数据建模（Spatial Data Modeling），面对不同的空间数据类型需要不同的建模方法，比如空间点模式分析（Spatial Point Pattern Analysis）、格网/面状数据分析（Area Data/Grid Data/lattice Data Analysis）、地统计分析（Geostatistics）等。</p>
<div id="矢量数据-sp" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> 矢量数据 sp</h2>
<p><strong>sp</strong> <span class="citation">[<a href="#ref-sp" role="doc-biblioref">7</a>]</span> 是一个 R 包，提供一种存储和操作空间数据的对象类型，具体地，提供点 SpatialPoints / SpatialMultiPoints、线 SpatialLines、多边形 SpatialPolygons、栅格 SpatialGrid / SpatialPixels 等基础空间数据类型以及相应构造方法，还有聚合 <code>aggregate()</code>，合并 <code>merge()</code>，转化 <code>spTransform()</code> 和绘图 <code>spplot()</code> / <code>bubble()</code> / <code>image()</code> 等空间数据操作和可视化函数。</p>
<pre class="r"><code>library(sp)
getClass(&quot;Spatial&quot;)
# Class &quot;Spatial&quot; [package &quot;sp&quot;]
# 
# Slots:
#                               
# Name:         bbox proj4string
# Class:      matrix         CRS
# 
# Known Subclasses: 
# Class &quot;SpatialPoints&quot;, directly
# Class &quot;SpatialMultiPoints&quot;, directly
# Class &quot;SpatialGrid&quot;, directly
# Class &quot;SpatialLines&quot;, directly
# Class &quot;SpatialPolygons&quot;, directly
# Class &quot;SpatialPointsDataFrame&quot;, by class &quot;SpatialPoints&quot;, distance 2
# Class &quot;SpatialPixels&quot;, by class &quot;SpatialPoints&quot;, distance 2
# Class &quot;SpatialMultiPointsDataFrame&quot;, by class &quot;SpatialMultiPoints&quot;, distance 2
# Class &quot;SpatialGridDataFrame&quot;, by class &quot;SpatialGrid&quot;, distance 2
# Class &quot;SpatialLinesDataFrame&quot;, by class &quot;SpatialLines&quot;, distance 2
# Class &quot;SpatialPixelsDataFrame&quot;, by class &quot;SpatialPoints&quot;, distance 3
# Class &quot;SpatialPolygonsDataFrame&quot;, by class &quot;SpatialPolygons&quot;, distance 2</code></pre>
<p>可以看出 <strong>sp</strong> 打造的一套空间数据基础类型及其衍生类型，知道数据类型才知道后续该怎么对其进行操作，调用合适的方法。比如最常使用的绘图函数 <code>plot()</code> 已经汇集很多方法了，它也是一个绘图对象，对于不同类型的数据对象，它会调用相应的绘图方法。在 R 语言内，一切都是对象，一切操作都是函数调用。</p>
<table>
<caption><span id="tab:methods-plot">表 4.1: </span>plot 绘图方法</caption>
<tbody>
<tr class="odd">
<td align="left">plot,ANY,ANY-method</td>
<td align="left">plot.histogram</td>
</tr>
<tr class="even">
<td align="left">plot,Spatial,missing-method</td>
<td align="left">plot.HoltWinters</td>
</tr>
<tr class="odd">
<td align="left">plot,SpatialGrid,missing-method</td>
<td align="left">plot.isoreg</td>
</tr>
<tr class="even">
<td align="left">plot,SpatialGridDataFrame,missing-method</td>
<td align="left">plot.lm</td>
</tr>
<tr class="odd">
<td align="left">plot,SpatialLines,missing-method</td>
<td align="left">plot.medpolish</td>
</tr>
<tr class="even">
<td align="left">plot,SpatialMultiPoints,missing-method</td>
<td align="left">plot.mlm</td>
</tr>
<tr class="odd">
<td align="left">plot,SpatialPixels,missing-method</td>
<td align="left">plot.ppr</td>
</tr>
<tr class="even">
<td align="left">plot,SpatialPixelsDataFrame,missing-method</td>
<td align="left">plot.prcomp</td>
</tr>
<tr class="odd">
<td align="left">plot,SpatialPoints,missing-method</td>
<td align="left">plot.princomp</td>
</tr>
<tr class="even">
<td align="left">plot,SpatialPolygons,missing-method</td>
<td align="left">plot.profile.nls</td>
</tr>
<tr class="odd">
<td align="left">plot.acf</td>
<td align="left">plot.R6</td>
</tr>
<tr class="even">
<td align="left">plot.data.frame</td>
<td align="left">plot.raster</td>
</tr>
<tr class="odd">
<td align="left">plot.decomposed.ts</td>
<td align="left">plot.shingle</td>
</tr>
<tr class="even">
<td align="left">plot.default</td>
<td align="left">plot.spec</td>
</tr>
<tr class="odd">
<td align="left">plot.dendrogram</td>
<td align="left">plot.stepfun</td>
</tr>
<tr class="even">
<td align="left">plot.density</td>
<td align="left">plot.stl</td>
</tr>
<tr class="odd">
<td align="left">plot.ecdf</td>
<td align="left">plot.table</td>
</tr>
<tr class="even">
<td align="left">plot.factor</td>
<td align="left">plot.trellis</td>
</tr>
<tr class="odd">
<td align="left">plot.formula</td>
<td align="left">plot.ts</td>
</tr>
<tr class="even">
<td align="left">plot.function</td>
<td align="left">plot.tskernel</td>
</tr>
<tr class="odd">
<td align="left">plot.hclust</td>
<td align="left">plot.TukeyHSD</td>
</tr>
</tbody>
</table>
<p><strong>sp</strong> 提供最基础的空间数据类是 Spatial 类，下面是一个实例。</p>
<pre class="r"><code># 构造最基础的 Spatial 类
S &lt;- Spatial(
  bbox = matrix(c(
    165.67, 188.13, # 经度区间
    -38.59, -10.72  # 纬度区间
  ),
  ncol = 2, byrow = TRUE,
  dimnames = list(NULL, c(&quot;min&quot;, &quot;max&quot;))
  ),
  # 不推荐 proj4string = CRS(&quot;+proj=longlat +datum=WGS84&quot;) 
  proj4string = CRS(&quot;EPSG:4326&quot;)
)
# 查看数据 S 类型
class(S)
# [1] &quot;Spatial&quot;
# attr(,&quot;package&quot;)
# [1] &quot;sp&quot;</code></pre>
<p>空间对象 S 有两个重要的部分，地理边界和坐标参考系，这两个信息可以分别用函数 <code>bbox()</code> 和 <code>slot(, "proj4string")</code> 单独提取。</p>
<pre class="r"><code>bbox(S)
#         min    max
# [1,] 165.67 188.13
# [2,] -38.59 -10.72
slot(S, &quot;proj4string&quot;)
# Coordinate Reference System:
# Deprecated Proj.4 representation: +proj=longlat +datum=WGS84 +no_defs 
# WKT2 2019 representation:
# GEOGCRS[&quot;WGS 84 (with axis order normalized for visualization)&quot;,
#     ENSEMBLE[&quot;World Geodetic System 1984 ensemble&quot;,
#         MEMBER[&quot;World Geodetic System 1984 (Transit)&quot;,
#             ID[&quot;EPSG&quot;,1166]],
#         MEMBER[&quot;World Geodetic System 1984 (G730)&quot;,
#             ID[&quot;EPSG&quot;,1152]],
#         MEMBER[&quot;World Geodetic System 1984 (G873)&quot;,
#             ID[&quot;EPSG&quot;,1153]],
#         MEMBER[&quot;World Geodetic System 1984 (G1150)&quot;,
#             ID[&quot;EPSG&quot;,1154]],
#         MEMBER[&quot;World Geodetic System 1984 (G1674)&quot;,
#             ID[&quot;EPSG&quot;,1155]],
#         MEMBER[&quot;World Geodetic System 1984 (G1762)&quot;,
#             ID[&quot;EPSG&quot;,1156]],
#         MEMBER[&quot;World Geodetic System 1984 (G2139)&quot;,
#             ID[&quot;EPSG&quot;,1309]],
#         ELLIPSOID[&quot;WGS 84&quot;,6378137,298.257223563,
#             LENGTHUNIT[&quot;metre&quot;,1],
#             ID[&quot;EPSG&quot;,7030]],
#         ENSEMBLEACCURACY[2.0],
#         ID[&quot;EPSG&quot;,6326]],
#     PRIMEM[&quot;Greenwich&quot;,0,
#         ANGLEUNIT[&quot;degree&quot;,0.0174532925199433],
#         ID[&quot;EPSG&quot;,8901]],
#     CS[ellipsoidal,2],
#         AXIS[&quot;geodetic longitude (Lon)&quot;,east,
#             ORDER[1],
#             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433,
#                 ID[&quot;EPSG&quot;,9122]]],
#         AXIS[&quot;geodetic latitude (Lat)&quot;,north,
#             ORDER[2],
#             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433,
#                 ID[&quot;EPSG&quot;,9122]]],
#     USAGE[
#         SCOPE[&quot;Horizontal component of 3D system.&quot;],
#         AREA[&quot;World.&quot;],
#         BBOX[-90,-180,90,180]],
#     REMARK[&quot;Axis order reversed compared to EPSG:4326&quot;]]</code></pre>
<p>实际上，除了函数 <code>bbox()</code> 和 <code>slot(, "proj4string")</code>，Spatial 类还有很多方法。</p>
<pre class="r"><code>methods(class = &quot;Spatial&quot;)
#  [1] [[            [[&lt;-          [&lt;-           $             $&lt;-           aggregate    
#  [7] bbox          cbind         coordinates&lt;- dimensions    fullgrid      geometry     
# [13] geometry&lt;-    gridded       head          is.projected  merge         over         
# [19] plot          polygons      proj4string   proj4string&lt;- rebuild_CRS   spChFIDs&lt;-   
# [25] spsample      spTransform   subset        summary       tail          wkt          
# see &#39;?methods&#39; for accessing help and source code</code></pre>
<p>接下来，介绍如何从 data.frame 类型构造 sp 类型，还是以 R 内置的 quakes 数据集为例，过程很简单，只需三步将 quakes 转化为 SpatialPointsDataFrame 类型。</p>
<pre class="r"><code># 加载数据
data(&quot;quakes&quot;)
# 指定坐标
coordinates(quakes) &lt;- ~long+lat
# 指定坐标参考系
proj4string(quakes) &lt;- CRS(&quot;EPSG:4326&quot;) # 不推荐 CRS(&quot;+proj=longlat +datum=WGS84&quot;)</code></pre>
<p>查看转化后的数据情况：</p>
<pre class="r"><code># 查看类型
class(quakes)
# [1] &quot;SpatialPointsDataFrame&quot;
# attr(,&quot;package&quot;)
# [1] &quot;sp&quot;
# 查看数据
quakes
#          coordinates depth mag stations
# 1    (181.6, -20.42)   562 4.8       41
# 2      (181, -20.62)   650 4.2       15
# 3       (184.1, -26)    42 5.4       43
# 4    (181.7, -17.97)   626 4.1       19
# 5      (182, -20.42)   649 4.0       11
....
# 查看边界
bbox(quakes)
#         min    max
# long 165.67 188.13
# lat  -38.59 -10.72</code></pre>
<p>直接调用 <code>plot()</code> 方法，获取图<a href="#fig:quakes-sp">4.1</a>。实际上，会调用 SpatialPoints 类的 <code>plot()</code> 方法，<code>plot()</code> 本身也是一个泛型函数，R 语言中的泛型有点类似面向对象编程中的多态。</p>
<pre class="r"><code>plot(quakes)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-sp"></span>
<img src="img/quakes-sp.png" class="full" alt="" />
<p class="caption">图 4.1: 空间数据绘图</p>
</div>
<p>调 sp 数据对象特有的方法 <code>spplot()</code>，获取图<a href="#fig:quakes-spplot">4.2</a>。</p>
<pre class="r"><code>p1 &lt;- spplot(quakes, &quot;depth&quot;, main = &quot;Depth&quot;,
  as.table = TRUE, # 面板自左上开始
  scales = list(
    draw = TRUE, # 坐标轴刻度
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  colorkey = TRUE,
  alpha = 0.7,
  key.space = &quot;right&quot;
)
p2 &lt;- spplot(quakes, &quot;mag&quot;, main = &quot;Mag&quot;,
  as.table = TRUE, # 面板自左上开始
  scales = list(
    draw = TRUE, # 坐标轴刻度
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  colorkey = TRUE, # 添加颜色条
  alpha = 0.7, # 散点透明度
  key.space = &quot;right&quot; # 颜色条放图右边
)
print(p1, split = c(1, 1, 2, 1), more = TRUE)
print(p2, split = c(2, 1, 2, 1), more = FALSE)</code></pre>
<div class="figure"><span style="display:block;" id="fig:quakes-spplot"></span>
<img src="img/quakes-spplot.png" class="full" alt="" />
<p class="caption">图 4.2: 空间数据绘图</p>
</div>
<p>地震主要是由于地壳运动产生的，两条地震带由内圈到外圈，地震深度有明显的阶梯变化，暗示着断层的方向和位置。</p>
<div class="rmdnote">
<p><strong>sp</strong> 会逐步退出空间数据领域，Roger Bivand 已经在为他的著作《Applied Spatial Data Analysis with R》迁移升级<a href="https://github.com/rsbivand/sf_asdar2ed">代码</a>，推荐读者尽快转移到 <strong>sf</strong> 上。考虑到一些读者大概率还会遇到基于 <strong>sp</strong> 的空间数据处理、分析和可视化的案例代码，因而做一些介绍，毕竟生态的迁移过程还要一段时间。</p>
</div>
</div>
<div id="矢量数据-sf" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> 矢量数据 sf</h2>
<p><strong>sf</strong> 包依赖三个基础的地理空间数据处理库，分别是制图投影库 <a href="https://proj.org/">proj</a>（Cartographic <strong>Proj</strong>ections Library，简称 proj），开源几何计算引擎 <a href="https://trac.osgeo.org/geos">geos</a>（ <strong>G</strong>eometry <strong>E</strong>ngine, <strong>O</strong>pen <strong>S</strong>ource，简称 geos），地理空间数据抽象库 <a href="https://www.gdal.org/">gdal</a> （<strong>G</strong>eospatial <strong>D</strong>ata <strong>A</strong>bstraction <strong>L</strong>ibrary，简称 gdal）。<strong>sf</strong> <span class="citation">[<a href="#ref-sf" role="doc-biblioref">8</a>]</span> 可以看作是继 <strong>sp</strong> 后的第二代空间数据处理和分析的框架。</p>
<pre class="r"><code>library(sf)
# Linking to GEOS 3.10.2, GDAL 3.4.2, PROJ 8.2.1; sf_use_s2() is TRUE</code></pre>
<pre class="r"><code>data(alaska, package = &#39;spData&#39;)
alaska
# Simple feature collection with 1 feature and 6 fields
# Geometry type: MULTIPOLYGON
# Dimension:     XY
# Bounding box:  xmin: -2176000 ymin: 404900 xmax: 1493000 ymax: 2384000
# Projected CRS: NAD83(NSRS2007) / Alaska Albers
#   GEOID   NAME REGION           AREA total_pop_10 total_pop_15
# 1    02 Alaska   West 1718925 [km^2]       691189       733375
#                         geometry
# 1 MULTIPOLYGON (((-1730018 47...</code></pre>
<p>数据集 alaska 只有1行6列，使用的坐标参考系是 Alaska Albers (EPSG:3467)。各个变量分别是 GEOID 地理标识符（geographic identifiers），NAME 州的名称，REGION 区域的名称，AREA 面积（平方千米），total_pop_10 2010 年人口，total_pop_15 2015 年人口，geometry 表示 sf 多边形类 MULTIPOLYGON 的集合属性，阿拉斯加地区是由多个多边形组成的，通过图<a href="#fig:sf-alaska">4.3</a>可以直观地看出来。</p>
<pre class="r"><code>plot(alaska[&quot;total_pop_15&quot;])</code></pre>
<div class="figure"><span style="display:block;" id="fig:sf-alaska"></span>
<img src="img/sf-alaska.png" class="full" alt="" />
<p class="caption">图 4.3:  <strong>sf</strong> 包绘制多边形数据</p>
</div>
<pre class="r"><code>data(world, package = &#39;spData&#39;)
world
# Simple feature collection with 177 features and 10 fields
# Geometry type: MULTIPOLYGON
# Dimension:     XY
# Bounding box:  xmin: -180 ymin: -89.9 xmax: 180 ymax: 83.65
# Geodetic CRS:  WGS 84
# # A tibble: 177 × 11
#    iso_a2 name_long        continent   region_un subregion type  area_km2     pop lifeExp
#  * &lt;chr&gt;  &lt;chr&gt;            &lt;chr&gt;       &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
#  1 FJ     Fiji             Oceania     Oceania   Melanesia Sove…   1.93e4  8.86e5    70.0
#  2 TZ     Tanzania         Africa      Africa    Eastern … Sove…   9.33e5  5.22e7    64.2
#  3 EH     Western Sahara   Africa      Africa    Northern… Inde…   9.63e4 NA         NA  
#  4 CA     Canada           North Amer… Americas  Northern… Sove…   1.00e7  3.55e7    82.0
#  5 US     United States    North Amer… Americas  Northern… Coun…   9.51e6  3.19e8    78.8
#  6 KZ     Kazakhstan       Asia        Asia      Central … Sove…   2.73e6  1.73e7    71.6
#  7 UZ     Uzbekistan       Asia        Asia      Central … Sove…   4.61e5  3.08e7    71.0
#  8 PG     Papua New Guinea Oceania     Oceania   Melanesia Sove…   4.65e5  7.76e6    65.2
#  9 ID     Indonesia        Asia        Asia      South-Ea… Sove…   1.82e6  2.55e8    68.9
# 10 AR     Argentina        South Amer… Americas  South Am… Sove…   2.78e6  4.30e7    76.3
# # … with 167 more rows, and 2 more variables: gdpPercap &lt;dbl&gt;, geom &lt;MULTIPOLYGON [°]&gt;</code></pre>
<p>world 包含 177 个国家和地区的人口数据，area_km2 面积、pop 人口（2014 年）、lifeExp 人均寿命（2014 年）和 gdpPercap 人均 GDP （2014 年）。地理信息相关的数据有 iso_a2 国标 ISO 的国家编码，name_long 国家名字，continent 大洲名字，region_un 区域名称，subregion 子区域名称和 type 类型。数据收集自美国国家地理网站<a href="https://www.naturalearthdata.com/">Natural Earth</a> 和世界银行 <a href="https://data.worldbank.org/">World Bank</a>，Jakub Nowosad 整理在 <strong>spData</strong> 包里。</p>
<pre class="r"><code>plot(world[&quot;gdpPercap&quot;])</code></pre>
<div class="figure"><span style="display:block;" id="fig:sf-world"></span>
<img src="img/sf-world.png" class="full" alt="" />
<p class="caption">图 4.4:  2014 年世界各国人均 GDP</p>
</div>
<div class="rmdnote">
<p><strong>spData</strong> 包内置的 world 数据集将台湾和中国大陆的地区用不同的颜色标记，严格来讲，这是不符合国家地图规范的，不能出现在期刊、书籍等正式的出版物里。</p>
</div>
</div>
</div>
<div id="数据操作" class="section level1" number="5">
<h1><span class="header-section-number">5</span> 数据操作</h1>
<p>先简要介绍 Base R 内置的一般数据操作，也是最常见的，然后介绍 <strong>sf</strong> 包和空间数据操作。<strong>sf</strong> 包对 Base R 内置的一些函数做了扩展以支持空间数据的合并、聚合等。</p>
<div id="一般数据操作" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> 一般数据操作</h2>
<p>通过排列组合 R 软件内置的一些基础数据操作函数能够满足大部分使用场景，这些基础函数都来自 <strong>base</strong> 包和 <strong>stats</strong> 包，由 R 语言 核心团队维护，约<strong>10</strong>来个函数：</p>
<ol style="list-style-type: decimal">
<li><p>函数 <code>subset()</code> 提取数据框中的某些列和行，也可以用 <code>$</code> 或 <code>[</code> 实现。</p></li>
<li><p>函数 <code>transform()</code> 可以在原来的数据框上添加新的一列，这个新的列通常是根据已有的列加减乘除等计算而来。</p></li>
<li><p>函数 <code>order()</code> 按照数据框的某个（些）列排序，如先按照第一列从小到大排序，再按照第二列从小到大排序。</p></li>
<li><p>函数 <code>aggregate()</code> 分组聚合函数，也是很常用的。</p></li>
<li><p>函数 <code>reshape()</code> 将长格式的数据框变形为宽格式的数据框，反之亦可。</p></li>
<li><p>函数 <code>merge()</code> 合并两个数据框，有内关联、左关联、右关联等合并方式，合并操作可以和 SQL 中的关联操作对应。</p></li>
<li><p>函数 <code>split()</code> 将数据框按照某个分类变量拆分为列表，后续常常可以接 <code>lapply()</code> 实现分组计算，最后调用 <code>do.call()</code> / <code>Reduce()</code> 等合并计算结果。</p></li>
<li><p>函数 <code>duplicated()</code> 查出是否有<strong>重复</strong>的记录，后续可以决定是否去掉。</p></li>
<li><p>函数 <code>complete.cases()</code> 查出是否有<strong>不完整</strong>的记录，后续考虑是否要去掉。</p></li>
</ol>
<p>下面以 R 软件内置的数据集 mtcars 为例，介绍数据操作的一个典型过程，拆分、计算、合并，早年Hadley Wickham 创建 <strong>plyr</strong> 包 <span class="citation">[<a href="#ref-plyr" role="doc-biblioref">9</a>]</span> 就是干这个事情，后来，陆续出现很多 R 包，如 <strong>reshape</strong> 包（已退休）、<strong>reshape2</strong>（已退休）、<strong>dplyr</strong>（活跃）、<strong>purrr</strong>（活跃）、<strong>tidyr</strong>（活跃），一直处于不太稳定的状态，此处不再细说。</p>
<pre class="r"><code>data(&quot;mtcars&quot;)
mtcars
#                      mpg cyl  disp  hp drat    wt  qsec vs am gear carb
# Mazda RX4           21.0   6 160.0 110 3.90 2.620 16.46  0  1    4    4
# Mazda RX4 Wag       21.0   6 160.0 110 3.90 2.875 17.02  0  1    4    4
# Datsun 710          22.8   4 108.0  93 3.85 2.320 18.61  1  1    4    1
# Hornet 4 Drive      21.4   6 258.0 110 3.08 3.215 19.44  1  0    3    1
# Hornet Sportabout   18.7   8 360.0 175 3.15 3.440 17.02  0  0    3    2
....</code></pre>
<pre class="r"><code># 拆分
mtcars_cyl &lt;- split(x = mtcars, f = ~cyl) # 从 R &gt;= 4.1.0 开始 split 支持公式语法
# 计算
mtcars_fit &lt;- lapply(mtcars_cyl, lm, formula = mpg ~ disp) # 求解回归模型
mtcars_coef &lt;- lapply(mtcars_fit, coef) # 提取回归系数
# 合并
dat &lt;- do.call(&quot;rbind&quot;, mtcars_coef)
dat
#   (Intercept)      disp
# 4       40.87 -0.135142
# 6       19.08  0.003605
# 8       22.03 -0.019634</code></pre>
<p>如果读者对<strong>data.table</strong>语法比较熟悉，这个过程将是一气呵成！</p>
<pre class="r"><code>library(data.table)
# data.frame 转化为 data.table 类型
mtcars &lt;- as.data.table(mtcars)
# 分组线性回归
mtcars[, as.list(coef(lm(mpg ~ disp))), by = .(cyl)]
#    cyl (Intercept)      disp
# 1:   6       19.08  0.003605
# 2:   4       40.87 -0.135142
# 3:   8       22.03 -0.019634</code></pre>
<p>如果想要自己的代码稳定、高效、简洁、易维护，那就先学习一下 Base R 的基本数据操作吧！熟悉之后，可以再深入学习一下 <strong>data.table</strong> 提供的高级数据操作，熟练掌握之后，配合 SQL，可以成为真正的生产力工具，从 Base R 到 <strong>data.table</strong> 可以加深理解 R 语言的精要，从而真正地提升编码水平。最后总结一点，新手都在做高难度动作<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a>，高手都在练基本动作<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>。为了让自己的编码更加有效率，更加符合语言本身的特点，先从数据操作开始，一点一点从头练习。</p>
</div>
<div id="空间数据操作" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> 空间数据操作</h2>
<p><strong>sf</strong> 内置了一些基础的空间数据操作函数，在此基础上，绝大多数复杂的空间数据操作都可以拆解为这些基础动作，更多详情见<strong>sf</strong>包<a href="https://r-spatial.github.io/sf/articles/sf1.html">帮助文档</a>。</p>
<pre class="r"><code>library(sf)
# 基础数据操作函数
methods(class = &quot;sf&quot;)
#  [1] [                     [[&lt;-                  $&lt;-                  
#  [4] aggregate             as.data.frame         cbind                
#  [7] coerce                dbDataType            dbWriteTable         
# [10] filter                identify              initialize           
# [13] merge                 plot                  print                
# [16] rbind                 show                  slotsFromS3          
# [19] st_agr                st_agr&lt;-              st_area              
# [22] st_as_s2              st_as_sf              st_as_sfc            
# [25] st_bbox               st_boundary           st_buffer            
# [28] st_cast               st_centroid           st_collection_extract
# [31] st_convex_hull        st_coordinates        st_crop              
# [34] st_crs                st_crs&lt;-              st_difference        
# [37] st_drop_geometry      st_filter             st_geometry          
# [40] st_geometry&lt;-         st_inscribed_circle   st_interpolate_aw    
# [43] st_intersection       st_intersects         st_is_valid          
# [46] st_is                 st_join               st_line_merge        
# [49] st_m_range            st_make_valid         st_nearest_points    
# [52] st_node               st_normalize          st_point_on_surface  
# [55] st_polygonize         st_precision          st_reverse           
# [58] st_sample             st_segmentize         st_set_precision     
# [61] st_shift_longitude    st_simplify           st_snap              
# [64] st_sym_difference     st_transform          st_triangulate       
# [67] st_union              st_voronoi            st_wrap_dateline     
# [70] st_write              st_z_range            st_zm                
# [73] transform            
# see &#39;?methods&#39; for accessing help and source code</code></pre>
<p>下面举个简单的例子，计算两点之间的距离，首先构造几何对象「点」，然后计算两点之间的距离。</p>
<pre class="r"><code>st_distance(st_point(c(-71.0882, 42.3607)), st_point(c(-74.1197, 40.6976)))
#             [,1]
# [1,] 3.457729582</code></pre>
<p>默认采用的是笛卡尔坐标系，二维、三维、四维都可以，两个点的情况下，相当于计算平面上两个点的距离，平面上两个点之间直线最短，即欧式距离：</p>
<p><span class="math display">\[
d = \sqrt{(x_1 - x_2)^2 + (y_1-y_2)^2}
\]</span></p>
<p>就这个例子而言，<code>st_distance()</code> 函数的作用相当于：</p>
<pre class="r"><code>sqrt((-71.0882 - (-74.1197))^2 + (42.3607 - 40.6976)^2)
# [1] 3.457729582</code></pre>
<p>假设这个点是球面上的一个点，球面的参照系为<a href="https://en.wikipedia.org/wiki/World_Geodetic_System">世界大地测量系统</a>（World Geodetic System），1984 年由美国国家地理空间情报局（National Geospatial-Intelligence Agency）建立和维护，简称 WGS 84，被全球定位系统采用。WGS 84 另一个响亮的名字是 EPSG:4326，EPSG 是欧洲石油调查组织（European Petroleum Survey Group）的简称。在 Web 电子地图上，常将 WGS 84 下的经纬度映射为平面上的点，即将坐标系映射到 EPSG:3857，相应地，坐标单位从经纬度转为米。</p>
<pre class="r"><code># 设置点所处的参照系 WGS 84
# 此时 -71.0882 表示经度 42.3607 表示纬度
st_sfc(st_point(c(-71.0882, 42.3607)), crs = 4326)
# Geometry set for 1 feature 
# Geometry type: POINT
# Dimension:     XY
# Bounding box:  xmin: -71.0882 ymin: 42.3607 xmax: -71.0882 ymax: 42.3607
# Geodetic CRS:  WGS 84
# POINT (-71.0882 42.3607)</code></pre>
<p><strong>sf</strong> 包提供的函数 <code>st_crs()</code> 可以非常方便地检索坐标系的信息，以 WGS 84 为例。</p>
<pre class="r"><code>st_crs(&quot;EPSG:4326&quot;)
# Coordinate Reference System:
#   User input: EPSG:4326 
#   wkt:
# GEOGCRS[&quot;WGS 84&quot;,
#     ENSEMBLE[&quot;World Geodetic System 1984 ensemble&quot;,
#         MEMBER[&quot;World Geodetic System 1984 (Transit)&quot;],
#         MEMBER[&quot;World Geodetic System 1984 (G730)&quot;],
#         MEMBER[&quot;World Geodetic System 1984 (G873)&quot;],
#         MEMBER[&quot;World Geodetic System 1984 (G1150)&quot;],
#         MEMBER[&quot;World Geodetic System 1984 (G1674)&quot;],
#         MEMBER[&quot;World Geodetic System 1984 (G1762)&quot;],
#         MEMBER[&quot;World Geodetic System 1984 (G2139)&quot;],
#         ELLIPSOID[&quot;WGS 84&quot;,6378137,298.257223563,
#             LENGTHUNIT[&quot;metre&quot;,1]],
#         ENSEMBLEACCURACY[2.0]],
#     PRIMEM[&quot;Greenwich&quot;,0,
#         ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],
#     CS[ellipsoidal,2],
#         AXIS[&quot;geodetic latitude (Lat)&quot;,north,
#             ORDER[1],
#             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],
#         AXIS[&quot;geodetic longitude (Lon)&quot;,east,
#             ORDER[2],
#             ANGLEUNIT[&quot;degree&quot;,0.0174532925199433]],
#     USAGE[
#         SCOPE[&quot;Horizontal component of 3D system.&quot;],
#         AREA[&quot;World.&quot;],
#         BBOX[-90,-180,90,180]],
#     ID[&quot;EPSG&quot;,4326]]</code></pre>
<p>可知 WGS 84 坐标系采用的基准面是椭球面，椭球的赤道半径为 6378137米，扁率为 1/298.257223563。</p>
<pre class="r"><code>st_distance(
  st_sfc(st_point(c(-71.0882, 42.3607)), crs = 4326),
  st_sfc(st_point(c(-74.1197, 40.6976)), crs = 4326)
)
# Units: [m]
#             [,1]
# [1,] 312822.1794</code></pre>
<p>空间数据对象常常围绕点、线、多边形或多维数组（用来表示卫星图像、时空数据）等展开，可以把这些几何对象看作是主键一样的东西，在同一坐标参考系下，一个地理位置或一块区域是不会有两个相同的地理标记的，其它观测变量是维度或指标，也可以看作这块区域的属性，比如说邵东市地区（一个多边形区域），地区拥有的人口数量、土地面积、人均 GDP等。</p>
<p>对于大规模的空间数据，需要借助专门的数据库处理，无论是构建在<a href="https://postgresql.org/">PostgreSQL</a>之上的<a href="http://postgis.net/">PostGIS</a> 还是构建在 Hadoop 之上<a href="https://prestodb.io/docs/current/functions/geospatial.html">Presto</a>，SQL 查询引擎都提供了一系列空间数据操作函数，且和<a href="https://github.com/r-spatial/sf"><strong>sf</strong></a> 包提供的操作函数是十分相似的。下面以 Presto 为例，分别计算欧式平面和椭球面上两点之间的距离。</p>
<p>平面几何，两点之间直线最短，距离就是欧氏距离。</p>
<pre class="sql"><code>ST_Distance(ST_Point(-71.0882, 42.3607), ST_Point(-74.1197, 40.6976))</code></pre>
<pre><code>3.457729581676387</code></pre>
<p>球面几何，两点之间最短距离是大圆的弧长，点的坐标视为经纬度参与计算。</p>
<pre class="sql"><code>ST_Distance(to_spherical_geography(ST_Point(-71.0882, 42.3607)), to_spherical_geography(ST_Point(-74.1197, 40.6976)))</code></pre>
<pre><code>312822.1793690028</code></pre>
<p>可见，R 包 <strong>sf</strong> 和 Presto 计算的结果完全一致，Presto 采用的空间坐标参考系也是 WGS 84。</p>
</div>
</div>
<div id="案例美国北卡婴儿猝死综合征数据" class="section level1" number="6">
<h1><span class="header-section-number">6</span> 案例：美国北卡婴儿猝死综合征数据</h1>
<p>再看一个稍微复杂的例子，涉及数据读取、操作和绘图，数据集 SIDS (Sudden Infant Death Syndrome，简称 SIDS)来自 <strong>sf</strong> 包，更早些时候收集在 <strong>sp</strong> 包内，更多细节见 Edzer Pebesma 开发的 <strong>sp</strong> 包<a href="https://edzer.github.io/sp/">帮助文档</a>，描述 1974 年和 1979 年美国北卡罗来纳州各个区县的婴儿猝死综合征的情况。</p>
<pre class="r"><code># 读取数据，且读取后不要转化为 tibble 数据类型
nc &lt;- read_sf(system.file(&quot;gpkg/nc.gpkg&quot;, package = &quot;sf&quot;), as_tibble = FALSE)
# 提取部分列
nc2 &lt;- subset(x = nc, select = c(&quot;SID74&quot;, &quot;SID79&quot;))
# 查看数据
nc2
# Simple feature collection with 100 features and 2 fields
# Geometry type: MULTIPOLYGON
# Dimension:     XY
# Bounding box:  xmin: -84.32 ymin: 33.88 xmax: -75.46 ymax: 36.59
# Geodetic CRS:  NAD27
# First 10 features:
#    SID74 SID79                           geom
# 1      1     0 MULTIPOLYGON (((-81.47 36.2...
# 2      0     3 MULTIPOLYGON (((-81.24 36.3...
# 3      5     6 MULTIPOLYGON (((-80.46 36.2...
# 4      1     2 MULTIPOLYGON (((-76.01 36.3...
# 5      9     3 MULTIPOLYGON (((-77.22 36.2...
# 6      7     5 MULTIPOLYGON (((-76.75 36.2...
# 7      0     2 MULTIPOLYGON (((-76.01 36.3...
# 8      0     2 MULTIPOLYGON (((-76.56 36.3...
# 9      4     2 MULTIPOLYGON (((-78.31 36.2...
# 10     1     5 MULTIPOLYGON (((-80.03 36.2...</code></pre>
<p>nc2 是一种宽格式数据，有两列 SID74 和 SID79，现在希望在地图上以 ggplot2 的分面绘图方式同时展示两个变量的空间分布，因此，需要先将数据由「宽格式」转为「长格式」。转化前，先来看下 nc2 的数据类型：</p>
<pre class="r"><code>class(nc2)
# [1] &quot;sf&quot;         &quot;data.frame&quot;</code></pre>
<p>它是一个非常复杂的数据类型，集合了 <code>sf</code> 和 <code>data.frame</code> 两种基本类型，在数据操作和绘图时，会根据类型的先后顺序依次查找和调用对应类型下的方法。</p>
<pre class="r"><code># 将 nc2 强制转化为简单的 data.frame 类型
nc3 &lt;- as.data.frame(nc2)
# 对 nc2 做「宽格式」转「长格式」的变形操作
nc3 &lt;- reshape(
  data = nc3,
  varying = c(&quot;SID74&quot;, &quot;SID79&quot;), # 需要转行的列，也可以用索引位置代替
  times = c(&quot;SID74&quot;, &quot;SID79&quot;),
  v.names = &quot;SID&quot;, # 列转行 列值构成的新列，指定名称
  timevar = &quot;VAR&quot;, # 列转行 列名构成的新列，指定名称
  idvar = &quot;geom&quot;,
  new.row.names = 1:(2 * 100), # 2 列拉长，每列有 100 个值，长格式有 2*100 行
  direction = &quot;long&quot;
)
# 变形完成后，恢复原来的数据类型
nc3 &lt;- st_as_sf(nc3, sf_column_name = &quot;geom&quot;)
class(nc3)
# [1] &quot;sf&quot;         &quot;data.frame&quot;</code></pre>
<div id="ggplot2-sf" class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> ggplot2 &amp; sf</h2>
<p><strong>ggplot2</strong> 提供的几何图层 <code>geom_sf()</code> 是专门为 sf 数据对象准备的，<code>facet_wrap()</code> 和 <code>facet_grid()</code> 都可以用来实现分面，布局样式稍有不同，更多绘图细节介绍见《ggplot2: Elegant Graphics for Data Analysis》<span class="citation">[<a href="#ref-Wickham2022" role="doc-biblioref">10</a>]</span>
第三版的地图章节，如图 <a href="#fig:sf-nc">6.1</a>。在地图上绘制栅格图形，有个专业的制图术语 — <a href="https://en.wikipedia.org/wiki/Choropleth_map">Choropleth Map</a>，翻译过来，大致叫填充地图、等值域图、瓦片图、围栏图、面量图、断层图等，可以非常直观地展示观测变量在地理区域内的变化情况。</p>
<pre class="r"><code>library(ggplot2)
ggplot() +
  geom_sf(data = nc3, aes(fill = SID)) +
  facet_wrap(~VAR, ncol = 1)
# 或
# ggplot() +
#   geom_sf(data = nc3, aes(fill = SID)) +
#   facet_grid(rows = vars(VAR))</code></pre>
<div class="figure"><span style="display:block;" id="fig:sf-nc"></span>
<img src="img/sf-nc.png" class="full" alt="" />
<p class="caption">图 6.1:  sf 数据可视化</p>
</div>
</div>
<div id="leaflet-mapdeck" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> leaflet &amp; mapdeck</h2>
<p>而 <strong>leaflet</strong> 支持绘制交互式的图形，如图 <a href="#fig:leaflet-nc">6.2</a> 所示。稍微注意的是，需要先将数据映射到坐标参考系 EPSG:4326 上，而后 <strong>leaflet</strong> 会负责将数据转化映射到 EPSG:3857，详见<a href="https://rstudio.github.io/leaflet/projections.html">文档</a>。</p>
<pre class="r"><code># https://stackoverflow.com/questions/57223853/
# 转化坐标和 leaflet 的坐标系保持一致
nc2 &lt;- sf::st_transform(nc2, crs = 4326)
library(leaflet)
# 调色板
pal &lt;- colorNumeric(&quot;plasma&quot;, domain = NULL)
# 绘图
leaflet(nc2) |&gt;  
  addTiles() |&gt; 
  addPolygons(
    stroke = FALSE, smoothFactor = 0.3, fillOpacity = 1.0,
    fillColor = ~ pal(SID74)
  ) |&gt; 
  addLegend(pal = pal, values = ~SID74, opacity = 1.0)</code></pre>
<div class="figure"><span style="display:block;" id="fig:leaflet-nc"></span>
<img src="img/leaflet-nc.png" class="full" alt="" />
<p class="caption">图 6.2:  <strong>leaflet</strong> 数据可视化</p>
</div>
<p>实现类似功能的还有 <strong>mapdeck</strong> 包。</p>
<pre class="r"><code>library(mapdeck)
mapdeck() |&gt; 
  add_polygon(
    data = nc2, 
    fill_colour = &quot;SID74&quot;,
    fill_opacity = 0.5,
    palette = &quot;spectral&quot;
  )</code></pre>
</div>
<div id="spspplot" class="section level2" number="6.3">
<h2><span class="header-section-number">6.3</span> sp::spplot</h2>
<p>在 <strong>sf</strong> 包出来前，<strong>maptools</strong> 曾经是空间数据操作的主力，是读取 <code>*.shp</code> 文件的主要方式。配合 <strong>sp</strong> 包，是实现空间数据分析和可视化的主要帮手。</p>
<pre class="r"><code>library(maptools)
nc &lt;- readShapePoly(
  fn = system.file(&quot;shapes/sids.shp&quot;, package = &quot;maptools&quot;),
  proj4string = CRS(&quot;EPSG:6267&quot;) # 不推荐 CRS(&quot;+proj=longlat +datum=NAD27&quot;)
)</code></pre>
<div class="rmdwarn">
<p>用 <strong>maptools</strong> 包提供的 <code>readShapePoly()</code> 函数读取 shp 文件的方式已经过时，将在 2023 年底不可用，推荐使用 <code>sf::st_read()</code> 方式读取，部分功能会迁移到 <strong>sp</strong> 包。<strong>sf</strong> 包内置的 nc.shp 数据文件和 <strong>maptools</strong> 包内置的 sids.shp 数据文件是一样的。下面是替代方案：</p>
<pre class="r"><code># 读取数据
nc &lt;- sf::st_read(system.file(&quot;shape/nc.shp&quot;, package = &quot;sf&quot;))
# 将数据对象从 sf 类型转化为 sp 类型
nc &lt;- sf::as(nc, &quot;Spatial&quot;)</code></pre>
</div>
<p><strong>sp</strong> 包提供的函数 <code>spplot()</code> 方法绘制类似的分面图，这其中借助了 <strong>lattice</strong> 包的绘图能力，效果如<a href="#fig:lattice-nc">6.3</a>所示。</p>
<pre class="r"><code>spplot(nc, c(&quot;SID74&quot;, &quot;SID79&quot;),
  as.table = TRUE,
  scales = list(draw = T, 
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  sp.layout = list(&quot;SpatialPolygonsRescale&quot;,
    layout.north.arrow(2),
    offset = c(-76, 34), scale = 0.5, which = 2
  )
)</code></pre>
<div class="figure"><span style="display:block;" id="fig:lattice-nc"></span>
<img src="img/lattice-nc.png" class="full" alt="" />
<p class="caption">图 6.3:  <strong>lattice</strong> 数据可视化</p>
</div>
<p><strong>ggmap</strong> 包获取的 Google 瓦片地图和 <strong>leaflet</strong> 包 使用的 OpenStreetMap 地图在坐标参考系上是一样的，都是 EPSG:3857，想把数据绘制到地图上，需要先将数据的坐标参考系转换到 EPSG:3857，坐标单位从经纬度随之变为米。</p>
<pre class="r"><code>library(ggmap)
bgMap = get_map(as.vector(bbox(nc)), source = &quot;google&quot;, zoom = 8) 
spplot(spTransform(nc, CRSobj = CRS(&quot;EPSG:3857&quot;)),
  c(&quot;SID74&quot;, &quot;SID79&quot;),
  as.table = TRUE,
  scales = list(
    draw = T,
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  sp.layout = list(panel.ggmap, bgMap, first = TRUE)
)</code></pre>
<div class="figure"><span style="display:block;" id="fig:sp-nc"></span>
<img src="img/sp-nc.png" class="full" alt="" />
<p class="caption">图 6.4:  <strong>sp</strong> 数据可视化</p>
</div>
</div>
<div id="latticeextramapplot" class="section level2" number="6.4">
<h2><span class="header-section-number">6.4</span> latticeExtra::mapplot</h2>
<p><strong>latticeExtra</strong> <span class="citation">[<a href="#ref-latticeExtra" role="doc-biblioref">11</a>]</span> 在 <strong>lattice</strong> 的基础上，封装了一些高级函数，围绕本篇主题，下面介绍一下 <code>mapplot()</code> 函数，读者不妨类比 <code>spplot()</code> 函数，可知它是专门为 map 数据类型提供绘图服务。 map 数据类型在 R 语言中存在很多年了，算得上是古老了，很久以前绘制地图的 R 包主要有：提供基础地图数据的 <strong>maps</strong>包， 提供更多常用地图数据的 <strong>mapdata</strong> 包， 实现坐标投影转化的 <strong>mapproj</strong> 包 和数据读写、操作的 <strong>maptools</strong> 包。</p>
<pre class="r"><code>mapplot(x, data, map,
  outer = TRUE,
  prepanel = prepanel.mapplot,
  panel = panel.mapplot,
  aspect = &quot;iso&quot;,
  legend = NULL,
  breaks, cuts = 30,
  colramp = colorRampPalette(hcl.colors(n = 11, palette = &quot;Spectral&quot;)),
  colorkey = TRUE,
  ...
)

prepanel.mapplot(x, y, map, ...)
panel.mapplot(x, y, map,
  breaks, colramp,
  exact = FALSE, lwd = 0.5,
  ...
)</code></pre>
<p>参数 <code>x</code> 提供符合 R 语言语法的公式，比如 <code>y ~ x1 + x2</code>。参数 <code>data</code> 提供数据集，包含观测变量。参数 <code>map</code> 提供地理边界信息，地理单元的名称必须和公式中变量 y 的值匹配。</p>
<pre class="r"><code># 加载 maps 包
library(maps)
# 将 sp 多边形类型 SpatialPolygons 转化为 map 类型
# 每个多边形单元的名字（郡县）都是唯一的
# 原数据 nc 里面标识每个单元的字段 NAME
nc_map &lt;- SpatialPolygons2map(nc, namefield = &quot;NAME&quot;)
# 查看转化后的数据类型
class(nc_map)</code></pre>
<pre class="r"><code># 提取原数据中的观测变量
dat &lt;- nc@data
library(latticeExtra)
# 绘图
mapplot(NAME ~ SID79 + SID74,
  data = dat, border = NA,
  map = nc_map,
  colramp = viridisLite::plasma, # hcl.colors,
  scales = list(
    draw = T,
    # 去掉图形上边、右边多余的刻度线
    x = list(alternating = 1, tck = c(1, 0)),
    y = list(alternating = 1, tck = c(1, 0))
  ),
  xlab = &quot;Long&quot;, ylab = &quot;Lat&quot;
)</code></pre>
<div class="figure"><span style="display:block;" id="fig:latticeExtra-nc"></span>
<img src="img/latticeExtra-nc.png" class="full" alt="" />
<p class="caption">图 6.5:  <strong>latticeExtra</strong> 数据可视化</p>
</div>
</div>
</div>
<div id="总结归纳" class="section level1" number="7">
<h1><span class="header-section-number">7</span> 总结归纳</h1>
<p>本文意在提供一个基于 R 语言的空间数据结构、可视化的简单概览，帮助读者了解空间数据可视化的轮廓，提供 R 语言在此领域的探索和实践。</p>
<p>本文创作过程中使用了大量的 R 包，感谢 R 语言社区的各个维护者，是他们开源共享的精神建立了如今繁荣的局面。总的来说，分两块，其一提供基础的空间数据类型，以及相应的数据操作方法，包括导入各种各样格式的空间数据，其二是空间数据分析和可视化方法，支持接入各种各样的地图服务，渲染静态和交互图形。空间数据方面，特别是 <strong>sp</strong> <span class="citation">[<a href="#ref-sp" role="doc-biblioref">7</a>]</span> 和 <strong>sf</strong><span class="citation">[<a href="#ref-sf" role="doc-biblioref">8</a>]</span> 包的开发者 <a href="https://www.r-spatial.org/">Edzer Pebesma</a>，<strong>raster</strong> <span class="citation">[<a href="#ref-raster" role="doc-biblioref">12</a>]</span>和 <strong>terra</strong> 包<span class="citation">[<a href="#ref-terra" role="doc-biblioref">13</a>]</span>的开发者 <a href="https://github.com/rhijmans">Robert J. Hijmans</a>，数据可视化方面，特别是 <strong>lattice</strong> 包 <span class="citation">[<a href="#ref-lattice" role="doc-biblioref">1</a>]</span> 的开发者 <a href="https://deepayan.github.io/">Deepayan Sarkar</a>，<strong>ggplot2</strong> 包<span class="citation">[<a href="#ref-Wickham2022" role="doc-biblioref">10</a>]</span>的开发者 <a href="https://hadley.nz/">Hadley Wickham</a> 和 <a href="https://www.data-imaginist.com/">Thomas Lin Pedersen</a>，<strong>RgoogleMaps</strong> 包的开发者 <span class="citation">[<a href="#ref-Loecher2015" role="doc-biblioref">14</a>]</span> <a href="https://blog.hwr-berlin.de/codeandstats/">Markus Loecher</a>，<strong>ggmap</strong> 包<span class="citation">[<a href="#ref-Kahle2013" role="doc-biblioref">15</a>]</span>的开发者 <a href="https://www.kahle.io/">David Kahle</a>，<strong>leaflet</strong> 包<span class="citation">[<a href="#ref-leaflet" role="doc-biblioref">3</a>]</span>的开发者 <a href="https://github.com/jcheng5">Joe Cheng</a>，<strong>echarts4r</strong> 包<span class="citation">[<a href="#ref-echarts4r" role="doc-biblioref">4</a>]</span>的开发者 <a href="https://john-coene.com/">John Coene</a>，<strong>plotly</strong> 包<span class="citation">[<a href="#ref-Sievert2020" role="doc-biblioref">16</a>]</span>的开发者 <a href="https://cpsievert.me/">Carson Sievert</a>。这些开发者只是 R 语言社区的冰山一角，截止写作时间，CRAN 上的开发者已经超过<strong>10000</strong>人。表<a href="#tab:spatial-deps">7.1</a>列出了基础的空间数据处理、分析和可视化的 R 包，也是本文直接或间接使用的一些 R 包，更多详情见 CRAN 上关于空间数据的<a href="https://cran.r-project.org/view=Spatial">任务视图</a>。</p>
<table>
<caption><span id="tab:spatial-deps">表 7.1: </span>空间分析的 R 包（排名不分先后）</caption>
<colgroup>
<col width="26%" />
<col width="52%" />
<col width="20%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">R 包</th>
<th align="left">简介</th>
<th align="left">维护者</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><strong>mapdata</strong> <span class="citation">[<a href="#ref-mapdata" role="doc-biblioref">17</a>]</span></td>
<td align="left">Extra Map Databases</td>
<td align="left">Alex Deckmyn</td>
</tr>
<tr class="even">
<td align="left"><strong>mapproj</strong> <span class="citation">[<a href="#ref-mapproj" role="doc-biblioref">18</a>]</span></td>
<td align="left">Map Projections</td>
<td align="left">Alex Deckmyn</td>
</tr>
<tr class="odd">
<td align="left"><strong>maps</strong> <span class="citation">[<a href="#ref-maps" role="doc-biblioref">19</a>]</span></td>
<td align="left">Draw Geographical Maps</td>
<td align="left">Alex Deckmyn</td>
</tr>
<tr class="even">
<td align="left"><strong>plotly</strong> <span class="citation">[<a href="#ref-plotly" role="doc-biblioref">5</a>]</span></td>
<td align="left">Create Interactive Web Graphics via ‘plotly.js’</td>
<td align="left">Carson Sievert</td>
</tr>
<tr class="odd">
<td align="left"><strong>ggmap</strong> <span class="citation">[<a href="#ref-ggmap" role="doc-biblioref">20</a>]</span></td>
<td align="left">Spatial Visualization with ggplot2</td>
<td align="left">David Kahle</td>
</tr>
<tr class="even">
<td align="left"><strong>lattice</strong> <span class="citation">[<a href="#ref-lattice" role="doc-biblioref">1</a>]</span></td>
<td align="left">Trellis Graphics for R</td>
<td align="left">Deepayan Sarkar</td>
</tr>
<tr class="odd">
<td align="left"><strong>latticeExtra</strong> <span class="citation">[<a href="#ref-latticeExtra" role="doc-biblioref">11</a>]</span></td>
<td align="left">Extra Graphical Utilities Based on Lattice</td>
<td align="left">Deepayan Sarkar</td>
</tr>
<tr class="even">
<td align="left"><strong>sf</strong> <span class="citation">[<a href="#ref-sf" role="doc-biblioref">8</a>]</span></td>
<td align="left">Simple Features for R</td>
<td align="left">Edzer Pebesma</td>
</tr>
<tr class="odd">
<td align="left"><strong>sp</strong> <span class="citation">[<a href="#ref-sp" role="doc-biblioref">7</a>]</span></td>
<td align="left">Classes and Methods for Spatial Data</td>
<td align="left">Edzer Pebesma</td>
</tr>
<tr class="even">
<td align="left"><strong>stars</strong> <span class="citation">[<a href="#ref-stars" role="doc-biblioref">21</a>]</span></td>
<td align="left">Spatiotemporal Arrays, Raster and Vector Data Cubes</td>
<td align="left">Edzer Pebesma</td>
</tr>
<tr class="odd">
<td align="left"><strong>leaflet</strong> <span class="citation">[<a href="#ref-leaflet" role="doc-biblioref">3</a>]</span></td>
<td align="left">Create Interactive Web Maps with the JavaScript ‘Leaflet’ Library</td>
<td align="left">Joe Cheng</td>
</tr>
<tr class="even">
<td align="left"><strong>echarts4r</strong> <span class="citation">[<a href="#ref-echarts4r" role="doc-biblioref">4</a>]</span></td>
<td align="left">Create Interactive Graphs with ‘Echarts JavaScript’ Version 5</td>
<td align="left">John Coene</td>
</tr>
<tr class="odd">
<td align="left"><strong>loa</strong> <span class="citation">[<a href="#ref-loa" role="doc-biblioref">22</a>]</span></td>
<td align="left">Lattice Options and Add-Ins</td>
<td align="left">Karl Ropkins</td>
</tr>
<tr class="even">
<td align="left"><strong>RgoogleMaps</strong> <span class="citation">[<a href="#ref-RgoogleMaps" role="doc-biblioref">23</a>]</span></td>
<td align="left">Overlays on Static Maps</td>
<td align="left">Markus Loecher</td>
</tr>
<tr class="odd">
<td align="left"><strong>rasterVis</strong> <span class="citation">[<a href="#ref-rasterVis" role="doc-biblioref">24</a>]</span></td>
<td align="left">Visualization Methods for Raster Data</td>
<td align="left">Oscar Perpinan Lamigueiro</td>
</tr>
<tr class="even">
<td align="left"><strong>raster</strong> <span class="citation">[<a href="#ref-raster" role="doc-biblioref">12</a>]</span></td>
<td align="left">Geographic Data Analysis and Modeling</td>
<td align="left">Robert J. Hijmans</td>
</tr>
<tr class="odd">
<td align="left"><strong>terra</strong> <span class="citation">[<a href="#ref-terra" role="doc-biblioref">13</a>]</span></td>
<td align="left">Spatial Data Analysis</td>
<td align="left">Robert J. Hijmans</td>
</tr>
<tr class="even">
<td align="left"><strong>maptools</strong> <span class="citation">[<a href="#ref-maptools" role="doc-biblioref">25</a>]</span></td>
<td align="left">Tools for Handling Spatial Objects</td>
<td align="left">Roger Bivand</td>
</tr>
<tr class="odd">
<td align="left"><strong>rgdal</strong> <span class="citation">[<a href="#ref-rgdal" role="doc-biblioref">26</a>]</span></td>
<td align="left">Bindings for the ‘Geospatial’ Data Abstraction Library</td>
<td align="left">Roger Bivand</td>
</tr>
<tr class="even">
<td align="left"><strong>rgeos</strong> <span class="citation">[<a href="#ref-rgeos" role="doc-biblioref">27</a>]</span></td>
<td align="left">Interface to Geometry Engine - Open Source (‘GEOS’)</td>
<td align="left">Roger Bivand</td>
</tr>
<tr class="odd">
<td align="left"><strong>ggplot2</strong> <span class="citation">[<a href="#ref-ggplot2" role="doc-biblioref">2</a>]</span></td>
<td align="left">Create Elegant Data Visualisations Using the Grammar of Graphics</td>
<td align="left">Thomas Lin Pedersen</td>
</tr>
<tr class="even">
<td align="left"><strong>mapedit</strong> <span class="citation">[<a href="#ref-mapedit" role="doc-biblioref">28</a>]</span></td>
<td align="left">Interactive Editing of Spatial Data in R</td>
<td align="left">Tim Appelhans</td>
</tr>
<tr class="odd">
<td align="left"><strong>mapview</strong> <span class="citation">[<a href="#ref-mapview" role="doc-biblioref">29</a>]</span></td>
<td align="left">Interactive Viewing of Spatial Data in R</td>
<td align="left">Tim Appelhans</td>
</tr>
<tr class="even">
<td align="left"><strong>mapsf</strong> <span class="citation">[<a href="#ref-mapsf" role="doc-biblioref">30</a>]</span></td>
<td align="left">Thematic Cartography</td>
<td align="left">Timothée Giraud</td>
</tr>
</tbody>
</table>
<p>从 <strong>sp</strong> 到 <strong>sf</strong>，从 <strong>raster</strong> 到 <strong>terra</strong>，是 R 语言在空间数据领域前进的一大步，在使用的直观感受上，数据读写、操作的性能得到极大的提升，整个空间数据处理领域的 R 包依赖也将大为减少。</p>
<p><strong>rgeos</strong> <span class="citation">[<a href="#ref-rgeos" role="doc-biblioref">27</a>]</span>、<strong>rgdal</strong> <span class="citation">[<a href="#ref-rgdal" role="doc-biblioref">26</a>]</span> 和 <strong>maptools</strong> <span class="citation">[<a href="#ref-maptools" role="doc-biblioref">25</a>]</span> 都将于 2023 年底移出 CRAN，不再维护，它们主要用来读取和操作空间数据，相比于 <strong>sf</strong> <span class="citation">[<a href="#ref-sf" role="doc-biblioref">8</a>]</span> 加 <strong>terra</strong> <span class="citation">[<a href="#ref-terra" role="doc-biblioref">13</a>]</span> 的新方案，它们都落后了。部分功能会迁移到 <strong>sp</strong> 包<span class="citation">[<a href="#ref-sp" role="doc-biblioref">7</a>]</span>，而 <strong>raster</strong> 包<span class="citation">[<a href="#ref-raster" role="doc-biblioref">12</a>]</span>也不推荐使用，大迁移背景介绍见<a href="https://github.com/r-spatial/evolution">这里</a>，几十年过去了，维护者退休了，代码的历史包袱很重，很难维护，功能和性能也没新的好。2019 年出版的开源书籍<a href="https://geocompr.robinlovelace.net/">《Geocomputation with R》</a> 已经在紧锣密鼓地升级了，感兴趣的读者不妨看看新旧<a href="https://keen-swartz-3146c4.netlify.app/older.html">详细比较</a>。</p>
<p><strong>ggplot2</strong> 及其生态是很好的，可能大家不知道的是，<strong>lattice</strong> 在绘图能力上丝毫不逊色于 <strong>ggplot2</strong>，甚至还有超越。本篇主要介绍空间数据，下面以 R 软件内置的地形数据 volcano 为例。</p>
<div class="figure"><span style="display:block;" id="fig:lattice-volcano-shade"></span>
<img src="img/lattice-volcano-shade.png" class="full" alt="" />
<p class="caption">图 7.1:  <a href="https://en.wikipedia.org/wiki/Maungawhau_/_Mount_Eden">Auckland Maunga Whau 火山</a>三维地形图 <span class="math inline">\(10m\times 10m\)</span></p>
</div>
<p>仅是图 <a href="#fig:lattice-volcano-shade">7.1</a> 就已经让 <strong>ggplot2</strong> 自愧不如了，更别说实现图<a href="#fig:lattice-volcano-contour">7.2</a>这样的组合图形，此例摘自 <a href="https://deepayan.github.io/">Deepayan Sarkar</a> 的书《<strong>lattice</strong>: Multivariate Data Visualization with R》<span class="citation">[<a href="#ref-Sarkar2008" role="doc-biblioref">31</a>]</span>。</p>
<div class="figure"><span style="display:block;" id="fig:lattice-volcano-contour"></span>
<img src="img/lattice-volcano-contour.png" class="full" alt="" />
<p class="caption">图 7.2:  Auckland Maunga Whau 火山带等值线的三维地形图 <span class="math inline">\(10m\times 10m\)</span></p>
</div>
<p>顺便一提，Python 语言社区关于空间数据操作的流行模块有<a href="https://github.com/shapely/shapely">shapely</a>和<a href="https://github.com/geopandas/geopandas">geopandas</a>，后者还包含基于<a href="https://github.com/matplotlib/matplotlib">matplotlib</a>的地理可视化，而做空间数据可视化的有<a href="https://github.com/bokeh/bokeh">bokeh</a>、<a href="https://github.com/pyecharts/pyecharts">pyecharts</a>和<a href="https://github.com/plotly/plotly.py">plotly</a>等。<a href="https://github.com/matplotlib/basemap">basemap</a> 基于 matplotlib 提供地图坐标映射，作用类似 R 包 <strong>mapproj</strong>。<a href="https://github.com/ResidentMario/geoplot">geoplot</a> 提供高级易用的使用接口，扩展 <a href="https://github.com/SciTools/cartopy">cartopy</a> 和 matplotlib 在地理可视化方面的能力。<a href="https://github.com/rasterio/rasterio">rasterio</a> 读写栅格数据，更多 Python 语言相关的地理可视化见<a href="https://github.com/sacridini/Awesome-Geospatial">地理资源列表</a>。</p>
</div>
<div id="未来展望" class="section level1" number="8">
<h1><span class="header-section-number">8</span> 未来展望</h1>
<p>本文只涉及空间数据领域的皮毛，说白了就是导入几种格式的空间数据画点小地图，也未涉及百万乃至百亿级的大规模空间数据的可视化，以及支持可视分析需要的空间数据存储、检索、操作、分析、建模和应用的知识和技术。此外，对于不同类型的空间数据有不同的分析方法和统计模型，比如点数据的模式分析，面数据的层次分析，栅格数据的图像分析等，本文亦未涉及。再有，面向具体业务问题，从问题发现到数据模型的转化、界定、拆解、优化和应用所需要的领域知识，本文也未涉及。笔者所知所学有限，空间数据领域是如此广阔，需要大家一起发力。</p>
<p>在大规模空间数据可视化和计算方面，<a href="https://github.com/keplergl/kepler.gl">Kepler.gl</a> 是一款开源的大规模地理数据分析工具。<a href="https://github.com/visgl/deck.gl">deck.gl</a> WebGL2 加持的高性能大规模空间数据可视化框架，支持灵活的自定义。Uber 开发的<a href="https://github.com/uber/h3">h3</a> 提供六边形分层时空索引，<a href="https://github.com/locationtech/geomesa">GeoMesa</a> 提供点、线、多边形的时空索引，支持分布式时空数据查询分析，结合 kafka 提供近实时的时空数据流处理能力，支持自定义 <a href="https://github.com/apache/spark">Apache Spark</a> 作为分布式地理分析计算引擎，要知道 Spark 本身是不提供针对空间数据操作的 SQL 函数，因此，使用成本是很高的。更进一步，<a href="https://github.com/apache/incubator-sedona">Apache Sedona</a>专门应用于大规模空间数据处理的集群计算系统，扩展了 Apache Spark / SparkSQL 的能力，提供一组开箱即用的套件 SpatialSQL，支持 Python 和 R 等多种编程接口。<a href="https://github.com/prestodb/presto">Presto</a> 作为一款分布式 SQL 查询引擎，内置了常用空间数据操作的函数，和 R 包 <strong>sf</strong> 提供的函数名基本是一致的，迁移学习成本低。更加老牌的 GIS 数据库当属站在<a href="https://www.postgresql.org/">PostgreSQL</a>肩膀上的<a href="http://postgis.net/">PostGIS</a>，PostgreSQL提供基础的空间数据类型，作为存储设施，PostGIS 提供空间数据特有的系列操作。</p>
</div>
<div id="环境信息" class="section level1" number="9">
<h1><span class="header-section-number">9</span> 环境信息</h1>
<p>本文的 R Markdown 源文件是在 RStudio IDE 内编辑的，用 <strong>blogdown</strong> <span class="citation">[<a href="#ref-Xie2017" role="doc-biblioref">32</a>]</span> 构建网站，<a href="https://github.com/gohugoio/hugo">Hugo</a> 渲染 <strong>knitr</strong> 之后的 Markdown 文件，得益于 <strong>blogdown</strong> 对 R Markdown 格式的支持，图、表和参考文献的交叉引用非常方便，省了不少文字编辑功夫。文中使用了多个 R 包，为方便复现本文内容，下面列出详细的环境信息：</p>
<pre class="r"><code>xfun::session_info(packages = c(
  &quot;knitr&quot;, &quot;rmarkdown&quot;, &quot;blogdown&quot;,
  &quot;ggmap&quot;, &quot;ggplot2&quot;, &quot;data.table&quot;,
  &quot;lattice&quot;, &quot;loa&quot;, &quot;latticeExtra&quot;,
  &quot;baidumap&quot;, &quot;RgoogleMaps&quot;,
  &quot;maps&quot;, &quot;mapproj&quot;, &quot;usmap&quot;,
  &quot;mapdata&quot;, &quot;maptools&quot;, &quot;spData&quot;,
  &quot;leaflet.extras&quot;, &quot;rjson&quot;, &quot;rgl&quot;,
  &quot;raster&quot;, &quot;terra&quot;, &quot;sp&quot;, &quot;sf&quot;,
  &quot;leaflet&quot;, &quot;echarts4r&quot;, &quot;plotly&quot;
), dependencies = FALSE)
# R version 4.2.1 (2022-06-23)
# Platform: x86_64-apple-darwin17.0 (64-bit)
# Running under: macOS Big Sur ... 10.16
# 
# Locale: en_US.UTF-8 / en_US.UTF-8 / en_US.UTF-8 / C / en_US.UTF-8 / en_US.UTF-8
# 
# Package version:
#   baidumap_0.2.2       blogdown_1.10        data.table_1.14.2    echarts4r_0.4.4     
#   ggmap_3.0.0          ggplot2_3.3.6        knitr_1.39           lattice_0.20-45     
#   latticeExtra_0.6.30  leaflet_2.1.1        leaflet.extras_1.0.0 loa_0.2.47.1        
#   mapdata_2.3.0        mapproj_1.2.8        maps_3.4.0           maptools_1.1.4      
#   plotly_4.10.0        raster_3.5.21        rgl_0.109.6          RgoogleMaps_1.4.5.3 
#   rjson_0.2.21         rmarkdown_2.14       sf_1.0-7             sp_1.5-0            
#   spData_2.0.1         terra_1.5.34         usmap_0.6.0         
# 
# Pandoc version: 2.18
# 
# Hugo version: 0.101.0</code></pre>
</div>
<div id="refer" class="section level1" number="10">
<h1><span class="header-section-number">10</span> 参考文献</h1>
<div id="refs" class="references csl-bib-body">
<div id="ref-lattice" class="csl-entry">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline"><span class="smallcaps">Sarkar</span>, D. (2021). <em><a href="http://lattice.r-forge.r-project.org/">Lattice: Trellis graphics for r</a></em>.</div>
</div>
<div id="ref-ggplot2" class="csl-entry">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline"><span class="smallcaps">Wickham</span>, H., <span class="smallcaps">Chang</span>, W., <span class="smallcaps">Henry</span>, L., <span class="smallcaps">Pedersen</span>, T. L., <span class="smallcaps">Takahashi</span>, K., <span class="smallcaps">Wilke</span>, C., <span class="smallcaps">Woo</span>, K., <span class="smallcaps">Yutani</span>, H. and <span class="smallcaps">Dunnington</span>, D. (2022). <em><a href="https://CRAN.R-project.org/package=ggplot2">ggplot2: Create elegant data visualisations using the grammar of graphics</a></em>.</div>
</div>
<div id="ref-leaflet" class="csl-entry">
<div class="csl-left-margin">[3] </div><div class="csl-right-inline"><span class="smallcaps">Cheng</span>, J., <span class="smallcaps">Karambelkar</span>, B. and <span class="smallcaps">Xie</span>, Y. (2022). <em><a href="https://rstudio.github.io/leaflet/">Leaflet: Create interactive web maps with the JavaScript leaflet library</a></em>.</div>
</div>
<div id="ref-echarts4r" class="csl-entry">
<div class="csl-left-margin">[4] </div><div class="csl-right-inline"><span class="smallcaps">Coene</span>, J. (2022). <em><a href="https://CRAN.R-project.org/package=echarts4r">echarts4r: Create interactive graphs with echarts JavaScript version 5</a></em>.</div>
</div>
<div id="ref-plotly" class="csl-entry">
<div class="csl-left-margin">[5] </div><div class="csl-right-inline"><span class="smallcaps">Sievert</span>, C., <span class="smallcaps">Parmer</span>, C., <span class="smallcaps">Hocking</span>, T., <span class="smallcaps">Chamberlain</span>, S., <span class="smallcaps">Ram</span>, K., <span class="smallcaps">Corvellec</span>, M. and <span class="smallcaps">Despouy</span>, P. (2021). <em><a href="https://CRAN.R-project.org/package=plotly">Plotly: Create interactive web graphics via plotly.js</a></em>.</div>
</div>
<div id="ref-rgl" class="csl-entry">
<div class="csl-left-margin">[6] </div><div class="csl-right-inline"><span class="smallcaps">Adler</span>, D. and <span class="smallcaps">Murdoch</span>, D. (2022). <em><a href="https://CRAN.R-project.org/package=rgl">Rgl: 3D visualization using OpenGL</a></em>.</div>
</div>
<div id="ref-sp" class="csl-entry">
<div class="csl-left-margin">[7] </div><div class="csl-right-inline"><span class="smallcaps">Pebesma</span>, E. and <span class="smallcaps">Bivand</span>, R. (2022). <em><a href="https://CRAN.R-project.org/package=sp">Sp: Classes and methods for spatial data</a></em>.</div>
</div>
<div id="ref-sf" class="csl-entry">
<div class="csl-left-margin">[8] </div><div class="csl-right-inline"><span class="smallcaps">Pebesma</span>, E. (2022). <em><a href="https://CRAN.R-project.org/package=sf">Sf: Simple features for r</a></em>.</div>
</div>
<div id="ref-plyr" class="csl-entry">
<div class="csl-left-margin">[9] </div><div class="csl-right-inline"><span class="smallcaps">Wickham</span>, H. (2022). <em><a href="https://CRAN.R-project.org/package=plyr">Plyr: Tools for splitting, applying and combining data</a></em>.</div>
</div>
<div id="ref-Wickham2022" class="csl-entry">
<div class="csl-left-margin">[10] </div><div class="csl-right-inline"><span class="smallcaps">Wickham</span>, H. (2022). <em><a href="https://ggplot2-book.org/"><span class="nocase">ggplot2</span>: Elegant graphics for data analysis</a></em>. Springer-Verlag New York.</div>
</div>
<div id="ref-latticeExtra" class="csl-entry">
<div class="csl-left-margin">[11] </div><div class="csl-right-inline"><span class="smallcaps">Sarkar</span>, D. and <span class="smallcaps">Andrews</span>, F. (2022). <em><a href="https://R-Forge.R-project.org/projects/latticeextra/">latticeExtra: Extra graphical utilities based on lattice</a></em>.</div>
</div>
<div id="ref-raster" class="csl-entry">
<div class="csl-left-margin">[12] </div><div class="csl-right-inline"><span class="smallcaps">Hijmans</span>, R. J. (2022). <em><a href="https://rspatial.org/raster">Raster: Geographic data analysis and modeling</a></em>.</div>
</div>
<div id="ref-terra" class="csl-entry">
<div class="csl-left-margin">[13] </div><div class="csl-right-inline"><span class="smallcaps">Hijmans</span>, R. J. (2022). <em><a href="https://rspatial.org/terra/">Terra: Spatial data analysis</a></em>.</div>
</div>
<div id="ref-Loecher2015" class="csl-entry">
<div class="csl-left-margin">[14] </div><div class="csl-right-inline"><span class="smallcaps">Loecher</span>, M. and <span class="smallcaps">Ropkins</span>, K. (2015). <a href="http://www.jstatsoft.org/v63/i04/"><span>RgoogleMaps</span> and <span class="nocase">loa</span>: Unleashing <span>R</span> graphics power on map tiles</a>. <em>Journal of Statistical Software</em> <strong>63</strong> 1–8.</div>
</div>
<div id="ref-Kahle2013" class="csl-entry">
<div class="csl-left-margin">[15] </div><div class="csl-right-inline"><span class="smallcaps">Kahle</span>, D. and <span class="smallcaps">Wickham</span>, H. (2013). <a href="https://journal.r-project.org/archive/2013-1/kahle-wickham.pdf"><span class="nocase">ggmap</span>: Spatial visualization with <span class="nocase">ggplot2</span></a>. <em>The R Journal</em> <strong>5</strong> 144–61.</div>
</div>
<div id="ref-Sievert2020" class="csl-entry">
<div class="csl-left-margin">[16] </div><div class="csl-right-inline"><span class="smallcaps">Sievert</span>, C. (2020). <em><a href="https://plotly-r.com/">Interactive web-based data visualization with <span>R</span>, <span class="nocase">plotly</span>, and <span class="nocase">shiny</span></a></em>. Chapman; Hall/CRC, Boca Raton, Florida.</div>
</div>
<div id="ref-mapdata" class="csl-entry">
<div class="csl-left-margin">[17] </div><div class="csl-right-inline"><span class="smallcaps">Richard A. Becker</span>, O. S. code by and <span class="smallcaps">Ray Brownrigg.</span>, A. R. Wilks. R. version by. (2018). <em><a href="https://CRAN.R-project.org/package=mapdata">Mapdata: Extra map databases</a></em>.</div>
</div>
<div id="ref-mapproj" class="csl-entry">
<div class="csl-left-margin">[18] </div><div class="csl-right-inline"><span class="smallcaps">McIlroy</span>, D., <span class="smallcaps">Brownrigg</span>, R., <span class="smallcaps">Minka</span>, T. P. and <span class="smallcaps">Bivand</span>, R. (2022). <em><a href="https://CRAN.R-project.org/package=mapproj">Mapproj: Map projections</a></em>.</div>
</div>
<div id="ref-maps" class="csl-entry">
<div class="csl-left-margin">[19] </div><div class="csl-right-inline"><span class="smallcaps">Brownrigg</span>, R. (2021). <em><a href="https://CRAN.R-project.org/package=maps">Maps: Draw geographical maps</a></em>.</div>
</div>
<div id="ref-ggmap" class="csl-entry">
<div class="csl-left-margin">[20] </div><div class="csl-right-inline"><span class="smallcaps">Kahle</span>, D., <span class="smallcaps">Wickham</span>, H. and <span class="smallcaps">Jackson</span>, S. (2019). <em><a href="https://github.com/dkahle/ggmap">Ggmap: Spatial visualization with ggplot2</a></em>.</div>
</div>
<div id="ref-stars" class="csl-entry">
<div class="csl-left-margin">[21] </div><div class="csl-right-inline"><span class="smallcaps">Pebesma</span>, E. (2021). <em><a href="https://CRAN.R-project.org/package=stars">Stars: Spatiotemporal arrays, raster and vector data cubes</a></em>.</div>
</div>
<div id="ref-loa" class="csl-entry">
<div class="csl-left-margin">[22] </div><div class="csl-right-inline"><span class="smallcaps">Ropkins</span>, K. (2021). <em><a href="http://loa.r-forge.r-project.org/loa.intro.html">Loa: Lattice options and add-ins</a></em>.</div>
</div>
<div id="ref-RgoogleMaps" class="csl-entry">
<div class="csl-left-margin">[23] </div><div class="csl-right-inline"><span class="smallcaps">Loecher</span>, M. (2020). <em><a href="https://github.com/markusloecher/rgooglemaps/blob/master/rgooglemaps/www/QuickTutorial.html">RgoogleMaps: Overlays on static maps</a></em>.</div>
</div>
<div id="ref-rasterVis" class="csl-entry">
<div class="csl-left-margin">[24] </div><div class="csl-right-inline"><span class="smallcaps">Perpinan Lamigueiro</span>, O. and <span class="smallcaps">Hijmans</span>, R. (2022). <em><a href="https://oscarperpinan.github.io/rastervis/">rasterVis: Visualization methods for raster data</a></em>.</div>
</div>
<div id="ref-maptools" class="csl-entry">
<div class="csl-left-margin">[25] </div><div class="csl-right-inline"><span class="smallcaps">Bivand</span>, R. and <span class="smallcaps">Lewin-Koh</span>, N. (2022). <em><a href="https://CRAN.R-project.org/package=maptools">Maptools: Tools for handling spatial objects</a></em>.</div>
</div>
<div id="ref-rgdal" class="csl-entry">
<div class="csl-left-margin">[26] </div><div class="csl-right-inline"><span class="smallcaps">Bivand</span>, R., <span class="smallcaps">Keitt</span>, T. and <span class="smallcaps">Rowlingson</span>, B. (2022). <em><a href="https://CRAN.R-project.org/package=rgdal">Rgdal: Bindings for the geospatial data abstraction library</a></em>.</div>
</div>
<div id="ref-rgeos" class="csl-entry">
<div class="csl-left-margin">[27] </div><div class="csl-right-inline"><span class="smallcaps">Bivand</span>, R. and <span class="smallcaps">Rundel</span>, C. (2021). <em><a href="https://CRAN.R-project.org/package=rgeos">Rgeos: Interface to geometry engine - open source (GEOS)</a></em>.</div>
</div>
<div id="ref-mapedit" class="csl-entry">
<div class="csl-left-margin">[28] </div><div class="csl-right-inline"><span class="smallcaps">Appelhans</span>, T., <span class="smallcaps">Russell</span>, K. and <span class="smallcaps">Busetto</span>, L. (2020). <em><a href="https://github.com/r-spatial/mapedit">Mapedit: Interactive editing of spatial data in r</a></em>.</div>
</div>
<div id="ref-mapview" class="csl-entry">
<div class="csl-left-margin">[29] </div><div class="csl-right-inline"><span class="smallcaps">Appelhans</span>, T., <span class="smallcaps">Detsch</span>, F., <span class="smallcaps">Reudenbach</span>, C. and <span class="smallcaps">Woellauer</span>, S. (2022). <em><a href="https://github.com/r-spatial/mapview">Mapview: Interactive viewing of spatial data in r</a></em>.</div>
</div>
<div id="ref-mapsf" class="csl-entry">
<div class="csl-left-margin">[30] </div><div class="csl-right-inline"><span class="smallcaps">Giraud</span>, T. (2022). <em><a href="https://CRAN.R-project.org/package=mapsf">Mapsf: Thematic cartography</a></em>.</div>
</div>
<div id="ref-Sarkar2008" class="csl-entry">
<div class="csl-left-margin">[31] </div><div class="csl-right-inline"><span class="smallcaps">Sarkar</span>, D. (2008). <em><a href="http://lmdvr.r-forge.r-project.org"><span class="nocase">lattice</span>: Multivariate data visualization with <span>R</span></a></em>. Springer-Verlag, New York.</div>
</div>
<div id="ref-Xie2017" class="csl-entry">
<div class="csl-left-margin">[32] </div><div class="csl-right-inline"><span class="smallcaps">Xie</span>, Y., <span class="smallcaps">Hill</span>, A. P. and <span class="smallcaps">Thomas</span>, A. (2017). <em><a href="https://bookdown.org/yihui/blogdown/"><span class="nocase">blogdown</span>: Creating websites with <span>R</span> markdown</a></em>. Chapman; Hall/CRC, Boca Raton, Florida.</div>
</div>
</div>
</div>
<div class="footnotes footnotes-end-of-document">
<hr />
<ol>
<li id="fn1"><p>各种花里胡哨引入一堆 R 包和函数，直接告诉你答案，又不告诉你为什么，三天不学习就跟不少变化。<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>基本动作就是内功心法，无论面对的数据操作如何复杂，最终都能一一化解，以不变应万变。<a href="#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
