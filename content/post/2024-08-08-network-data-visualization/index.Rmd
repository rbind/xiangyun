---
title: 网络数据可视化与 R 语言
author: 黄湘云
date: '2024-08-08'
slug: network-data-visualization
categories:
  - 统计图形
tags:
  - 网络分析
  - ggplot2
  - Rgraphviz
  - igraph 
  - ggraph
  - DiagrammeR
bibliography: 
  - refer.bib
  - packages.bib
draft: true
math: true
output:
  blogdown::html_page:
    toc: true
thumbnail: /img/seven-bridges.png
link-citations: true
description: "本文首先概览 R 语言在网络数据分析和可视化方面的情况；然后介绍图的表示（矩阵），图的计算（矩阵计算），图的展示（点、线等），图的工具（R 和其它软件）；最后以 CRAN 上 R 包的元数据为基础，介绍网络分析和可视化的过程，也发现了 R 语言社区中一些非常有意思的现象。"
---


```{r setup, echo=FALSE}
library(data.table)
knitr::opts_chunk$set(
  comment = "#",
    error = FALSE,
     tidy = FALSE,
    cache = FALSE,
     echo = FALSE,
 collapse = TRUE
)
# 控制输出的宽度
options(width = 69)
```

```{css, echo=FALSE}
.sidebar {
  border: 1px solid #ccc;
}

.rmdwarn {
  border: 1px solid #EA4335;
}

.rmdnote {
  border: 1px solid #FBBC05;
}

.rmdtip {
  border: 1px solid #34A853;
}

.sidebar, .rmdwarn, .rmdnote, .rmdtip {
  border-left-width: 5px;
  border-radius: 5px;
  padding: 1em;
  margin: 1em 0;
}

div.rmdwarn::before, div.rmdnote::before, div.rmdtip::before {
  display: block;
  font-size: 1.1em;
  font-weight: bold;
  margin-bottom: 0.25em;
}

div.rmdwarn::before {
  content: "警告";
  color: #EA4335;
}

div.rmdnote::before {
  content: "注意";
  color: #FBBC05;
}

div.rmdtip::before {
  content: "提示";
  color: #34A853;
}

.rmdinfo {
  border: 1px solid #ccc;
  border-left-width: 5px;
  border-radius: 5px;
  padding: 1em;
  margin: 1em 0;
}
div.rmdinfo::before {
  content: "声明";
  color: block;
  display: block;
  font-size: 1.1em;
  font-weight: bold;
  margin-bottom: 0.25em;
}

figure {
  text-align: center;
}

div.img {
  text-align: center;
  display: block; 
  margin-left: auto; 
  margin-right: auto;
}

.columns {
  display: flex;
}
```

::: rmdtip
时隔四年，Gephi 发布了 1.0.0 版，写一篇文章庆祝一下。
:::


# 本文概览


本文首先概览 R 语言在网络数据分析和可视化方面的情况；然后介绍图的表示（矩阵），图的计算（矩阵计算），图的展示（点、线等），图的工具（R 和其它软件）；最后以 CRAN 上 R 包的元数据为基础，介绍网络分析和可视化的过程，也发现了 R 语言社区中一些非常有意思的现象。

网络图是表示节点之间关系的图，核心在于关系的刻画， 用来表达网络关系的是稀疏矩阵，以及为处理这种矩阵而专门优化的矩阵计算库，如 **Matrix** 、[**rsparse**](https://github.com/rexyai/rsparse)和 **RcppEigen** [@Bates2013]，PageRank  应该是大家最为熟悉的网络数据挖掘算法，图关系挖掘和计算的应用场景非常广泛，如社交推荐（社交 App）、风险控制（银行征信、企业查）、深度学习（图神经网络）、知识图谱（商户、商家、客户的实体关系网络）、区块链、物联网（IoT）、反洗钱（金融监管）、数据治理（数据血缘图谱）等。

企业级的图存储和计算框架，比较有名（可能是最有名的），反正，笔者最先听说的是[Neo4j](https://github.com/neo4j/neo4j) ，它有以 AGPL 协议发布的开源版本，还有商业版本。[Nebula Graph](https://github.com/vesoft-inc/nebula)  分布式开源图数据库，高扩展性和高可用性，支持千亿节点、万亿条边、毫秒级查询，有[中文文档](https://github.com/vesoft-inc/nebula-docs-cn/)，有企业应用案例，[美团图数据库平台建设及业务实践](https://mp.weixin.qq.com/s/aYd5tqwogJYfkJXhVNuNpg)。阿里研发的[GraphScope](https://github.com/alibaba/GraphScope) 提供一站式大规模图计算系统，支持图神经网络计算。[HugeGraph](https://github.com/hugegraph/hugegraph)图数据库应用于[金融反欺诈实践](https://zhuanlan.zhihu.com/p/114665466)。


[node2vec](https://cran.r-project.org/package=node2vec)包实现等人提出的大规模网络特征学习[@Grover2016]。[networkx](https://github.com/networkx/networkx)是做网络分析的 Python 模块。
[**rsparse**](https://github.com/rexyai/rsparse) 包提供很多基于稀疏矩阵的统计学习算法，支持基于 OpenMP 的并行计算。[RSpectra](https://github.com/yixuan/RSpectra) 包是 C++ 库 [Spectra](https://spectralib.org/) 的 R 接口，仅有两个函数 `eigs()` 和 `svds()` 分别用来计算 $N$ 阶矩阵（稀疏或稠密都行） Top K 个最大的特征值/特征向量，适合大规模特征值和奇异值分解问题，在 k 远远小于 N 时，特别能体现优越性。后面从 CRAN 网络数据中获取 Top K 个主要的组织、个人和 R 包。


<!--

[**RcppSparse**](https://github.com/zdebruine/RcppSparse)  RcppArmadillo 和 RcppEigen 深拷贝deep copy 操作，而 RcppSparse zero-copy 零拷贝，无缝衔接，而计算结果是一致的，详细描述见 [Constructing a Sparse Matrix Class in Rcpp](https://gallery.rcpp.org/articles/sparse-matrix-class/)

1. Roger Bivand 分析源码提交记录 <https://github.com/rsbivand/eRum18>
1. 基本数据操作到两大阵营的对话 <https://d.cosx.org/d/420697>
1. 分析 CRAN 上 R 包元数据，挖掘 R 社区中隐藏的信息 <https://r-graphics.netlify.com/cs-cran-network.html>
-->


# R 包概览


[igraph](https://github.com/igraph/igraph) 是非常流行和核心的网络分析 C 语言库，它提供有多种语言的接口，其 R 语言接口 [igraph](https://github.com/igraph/rigraph) 包也被很多其它做网络分析的 R 包所引用。开源的 [Gephi](https://github.com/gephi/gephi) 软件适合处理中等规模的网络分析和可视化。大规模图计算可以用 Apache Spark 的 [GraphX](https://spark.apache.org/graphx/)。R 语言这层，主要还是对应数据分析和数据产品，用于在内部咨询和商业分析。

[David Schoch](http://mr.schochastics.net/) 开发的 [graphlayouts](https://github.com/schochastics/graphlayouts) 包添加布局算法用于网络可视化，他个人网站上还有一些介绍 R 语言网络分析的文章。他开发的另一个 R 包[networkdata](https://github.com/schochastics/networkdata)收集了**980**个网络相关的数据集，用于教学、文章和书籍介绍相关知识应该足够，用不着自己还到处去找了。Thomas Lin Pedersen 开发的[ggraph](https://github.com/thomasp85/ggraph)包实现图和网络的绘图语法，类似 ggplot2 的设计，和以往的使用习惯保持一致，这就非常方便。他开发的另一个 R 包[tidygraph](https://github.com/thomasp85/tidygraph) 将净土应用到图操作上面。Martina Morris 等人开发了一批用于网络分析和建模的 R 包，类似 tidyverse 的做法都整合在 [statnet](https://github.com/statnet) 包里。

[BDgraph](https://cran.r-project.org/package=BDgraph) [@BDgraph2019] 基于生灭过程的贝叶斯结构学习用于图模型，

[qgraph](https://github.com/SachaEpskamp/qgraph) [@qgraph2012] 网络数据可视化和分析，高斯图模型计算

[DoubleML](https://github.com/DoubleML/doubleml-for-r/)[@DoubleML2021] 构建在 mlr3 及生态上，实现 Double/Debiased 机器学习框架[@Chernozhukov2018]。
[text2map](https://gitlab.com/culturalcartography/text2map) [@text2map2021] 文本分析，词嵌入，文本网络
[mlpack](https://github.com/mlpack/mlpack) [@mlpack2018] 是前沿机器学习算法合集。



[visNetwork](https://github.com/datastorm-open/visNetwork) 包 可以制作交互式网络图形，它是 JS 库 [vis-network](https://github.com/visjs/vis-network) 的 R 语言接口。Richard Iannone 而开发的[DiagrammeR](https://github.com/rich-iannone/DiagrammeR) 包可以制作静态的矢量网页图形。

::: rmdnote
[networkD3](https://github.com/christophergandrud/networkD3) CRAN 上次更新还在 2017 年，[Sam Tyner](https://sctyner.me/) 开发的 [geomnet](https://github.com/sctyner/geomnet) 包给 ggplot2 添加了网络图层 `geom_net`，目前未在 CRAN 上发布。François Briatte 开发的 [ggnet](https://github.com/briatte/ggnet) 目前也未在 CRAN 上发布，但是其帮助文档值得一看，[]( https://briatte.github.io/ggnet/)。
:::

另一类表达关系的是流程图或项目架构图，比较流行的制作工具（软件）有[graphviz](https://gitlab.com/graphviz/graphviz)、[plantuml](https://github.com/plantuml/plantuml)、[drawio-desktop](https://github.com/jgraph/drawio-desktop) 和[flowchart.js](https://github.com/adrai/flowchart.js)。在 R Markdown 文档中，knitr 包可以调用 [Graphviz](https://www.graphviz.org/) 软件生成网络图并插入到文档中，而 [nomnoml](https://github.com/rstudio/nomnoml) 包没有外部软件依赖，非常方便，下图\@ref(fig:nomnoml)即为该 R 包制作。

![(\#fig:nomnoml) 开发 R Shiny 应用的技术栈](https://user-images.githubusercontent.com/12031874/120408326-6190a900-c381-11eb-9dcf-9881d33fa2b6.png){.full}



```{r network-deps}
#| message: false
#| echo: false
# 获取 R 包元数据
Sys.setenv(R_CRAN_WEB = "https://mirrors.tuna.tsinghua.edu.cn/CRAN")
# 返回 data.frame
pdb <- tools::CRAN_package_db()

# CRAN 上的 R 包
pkgs <- c(
  "igraph", "graphlayouts", "ggraph", "tidygraph",
  "DiagrammeR", "visNetwork", "statnet", "sand",
  "geomnet", "ggnet", "ggnetwork", "qgraph", 
  "GGally", "sna", "network", "networkD3", 
  "Rgraphviz", "graph", "node2vec"
)

# Github 上的 R 包
remote_pkgs = c('geomnet' = 'sctyner', 'ggnet' = 'briatte')
# Bioconductor 上的 R 包
bioc_pkgs = c("Rgraphviz", "graph")

if (length(bioc_pkgs)) {
  if (!"BiocManager" %in% .packages(T)) install.packages("BiocManager")
}
# 安装依赖
invisible(lapply(pkgs, function(pkg) {
  if (system.file(package = pkg) != "") {
    return()
  }
  if(pkg %in% bioc_pkgs){
    BiocManager::install(pkg)
  }
  repo <- remote_pkgs[pkg]
  if (is.na(repo)) { # 不在 Github 上
    install.packages(pkg, quiet = TRUE)
  } else {
    remotes::install_github(paste(repo, pkg, sep = "/"))
  }
}))

# 处理掉丑陋的成对单引号
rmd_lib <- c(
  "ggplot2", "vis.js"
)
rmd_regexp <- paste("'(", paste(rmd_lib, collapse = "|"), ")'", sep = "")

# 提取 R Shiny 应用使用的 R 包及其基本描述
sub_pdb <- subset(
  x = pdb,
  select = c("Package", "Title", "Maintainer", "URL", "License", "BugReports"),
  subset = Package %in% pkgs
) |>
  transform(Title = gsub("(\\\n)", " ", Title)) |>
  transform(Title = gsub(rmd_regexp, "\\1", Title)) |> 
  transform(Maintainer = gsub("<([^<>]*)>", "", Maintainer)) |> 
  # transform(URL = gsub("(\\\n)", " ", URL)) |> 
  # transform(URL = gsub(",", "", URL)) |> 
  # transform(URL = ifelse(is.na(URL), BugReports, URL)) |> 
  # transform(URL = ifelse(is.na(URL), sprintf("https://CRAN.R-project.org/package=%s", Package), URL)) |> 
  transform(Package = paste0("**", Package, "**", " ", "[@", Package, "]"))

# 展示表格
knitr::kable(sub_pdb[order(sub_pdb$Maintainer), 
                     setdiff(colnames(sub_pdb), c("URL", "BugReports", "License"))],
  row.names = FALSE,
  caption = "网络分析的 R 包（排名不分先后）",
  col.names = c("R 包", "简介", "维护者")
)
```
```{r write-bib, include=FALSE}
# 保存 bib
bib <- knitr::write_bib(
  x = pkgs, file = NULL, prefix = ""
)
bib <- unlist(bib)
bib <- gsub("(\\\n)", " ", bib)
xfun::write_utf8(bib, "packages.bib")
```


推荐 Github 上[超棒的网络分析](https://github.com/briatte/awesome-network-analysis) 资源集合，ggplot2 关于网络数据可视化的[介绍](https://ggplot2-book.org/networks.html)，阅读 Erick Kolaczyk 的书籍《Statistical Analysis of Network Data with R》[@Kolaczyk2014;@Kolaczyk2020]和发表在《R Journal》上的文章《Network Visualization with ggplot2》[@Tyner2017]及其配套 R 包 [ggnetwork](https://github.com/briatte/ggnetwork)。Katherine Ognyanova 在个人博客上持续维护的材料 --- [Static and dynamic network visualization with R](https://kateto.net/network-visualization)，David Schoch 介绍用 R 包 ggraph 和 graphlayouts 做网络数据可视化的材料 --- [Network Visualizations in R: using ggraph and graphlayouts](http://mr.schochastics.net/netVizR.html)，Albert-László Barabási 的在线书籍[《Network Science》](http://networksciencebook.com/)，Douglas Luke 的《A User’s Guide to Network Analysis in R》[@Luke2015]。无论是软件工具还是相关文献，笔者相信这只是列举了很小的一部分而已，但是应该足够应付绝大部分使用场景，读者若还有补充，欢迎来统计之都论坛留言评论 --- [中等规模及以上的网络图，怎么用 R 高效地绘制](https://d.cosx.org/d/419292)或灌水 --- [R 社区的开发人员知多少](https://d.cosx.org/d/420670)。

落园园主的博文[十八般武艺，谁主天下？](https://cosx.org/2013/02/jinyong-fiction-mining)分析金庸先生小说揭密最受欢迎的兵器，刘思喆的博文[从北京地铁规划再看地段的重要性](https://bjt.name/2021/02/13/subway.html)分析地铁网络寻找房价洼地。



# 网络分析基础

![(\#fig:seven-bridges) 欧拉用图抽象的柯尼斯堡七桥](/img/seven-bridges.png){ width=65% }

柯尼斯堡七桥图的数据以 igraph 数据类型整理收录在 **igraphdata** 包里，数据集名称就叫 Koenigsberg。**igraph** 包集图数据表示、计算和可视化于一体，功能十分丰富，如图\@ref(fig:koenigsberg)是用**igraph** 包画的。

```{r koenigsberg}
#| fig.cap: "柯尼斯堡七桥"
#| message: false
#| fig.height: 3
#| echo: true
set.seed(6666)
data(Koenigsberg, package = "igraphdata")
par(mar = c(0, 0, 0, 0))
library(igraph)
plot(Koenigsberg)
```


## 安装 R 包

后续的内容使用到一些 R 包，需要先安装一下。

- **graph** 包：提供基础的类型定义和功能。
- **RBGL** 包：基于 BOOST 图库提供图算法，如最短路径，连通性等。
- **Rgraphviz** 包：基于 [Graphviz](https://www.graphviz.org/) 提供多种布局算法，渲染顶点、边、颜色等图形元素。
- **pkgDepTools** 包：快速制作 CRAN 上 R 包依赖关系图。

```{r}
#| echo=TRUE
if(!"BiocManager" %in% .packages(T)) install.packages("BiocManager")
if(!"graph" %in% .packages(T)) BiocManager::install(pkgs = "graph")
if(!"Rgraphviz" %in% .packages(T)) BiocManager::install(pkgs = "Rgraphviz")
if(!"pkgDepTools" %in% .packages(T)) BiocManager::install(pkgs = "pkgDepTools")
```


## 图的表示

### 从邻接矩阵构造图

在 R 环境中，邻接矩阵可从 matrix 数据类型构造，行名和列名是顶点，用1-0表示顶点之间是否有边，由0-1构造的邻接矩阵表示图。下面一个有4个顶点的简单图，邻接矩阵如下：

```{r}
#| echo=TRUE
# library(graph)
mat <- matrix(c(
  0, 0, 1, 1,
  0, 0, 1, 1,
  1, 1, 0, 1,
  1, 1, 1, 0
),
byrow = TRUE, ncol = 4,
dimnames = list(letters[1:4], letters[1:4])
)
mat
```

**graph** 包可以非常方便地将 matrix 类型的邻接矩阵转化为 graph 类型的图，还可以快速绘制图形，如图\@ref(fig:graph)所示。

(ref:graph) 用 **graph** 包绘制4个顶点的简单网络图

```{r graph}
#| echo=TRUE,
#| fig.cap="(ref:graph)",
#| message=FALSE
# 邻接矩阵转化为 graph 类型的图
g1 <- graph::graphAM(adjMat = mat)
class(g1)
graph::plot(g1)
```





### 随机模拟无向图

用函数 `randomGraph()` 随机生成一个无向网络图

```{r}
#| echo=TRUE
set.seed(123)
V <- letters[1:10] # 图的顶点
M <- 1:4  # 选择生成图的
g2 <- graph::randomGraph(V, M, p = 0.2)
graph::numEdges(g2)  # 边的个数
graph::edgeNames(g2) # 边的名字，无向图顶点之间用 ~ 连接
# 图的概览
g2
```

:::::: {.columns}
::: {.column width="47.5%" data-latex="{0.475\textwidth}"}
```{r}
#| echo=TRUE
graph::edges(g2) # 边
```
:::
::: {.column width="5%" data-latex="{0.05\textwidth}"}
\ 
<!-- an empty Div (with a white space), serving as
a column separator -->
:::
::: {.column width="47.5%" data-latex="{0.475\textwidth}"}
```{r}
#| echo=TRUE
graph::edgeWeights(g2) # 边的权重
```
:::
::::::


V 表示图的顶点， M 表示一组元素的集合，
p 表示从集合 M 中选出一个元素的概率。随机图的构造方法如下：
从 M 中以概率 p 选出一个元素，比如 1 （或者没有选），然后将 1 随机地指给 V 中的一个顶点 a，重复这个过程 4 次（次数取决于 M 中元素的个数）完成对一个顶点的随机指定，此时，顶点 a 对应一个长度为 4 的逻辑向量，有值的位置记为 TRUE，反之记为 FALSE，对其他顶点操作类似，这样就可以得到一个 10 * 4 的矩阵。如果某一列有两个顶点共有一个元素，比如 1， 则这两个顶点有边连接，反之则无。如果两个顶点共用2和3两个元素，则连接两个顶点的边的权重为 2。可见，V 和 M 的数量，以及 p 的值决定图的稠密程度。

(ref:random-graph) 用 **graph** 包生成10个顶点的随机网络图

```{r random-graph}
#| fig.cap="(ref:random-graph)"
graph::plot(g2)
```

```{r layout-graph}
#| fig.cap="图的布局：左图 neato 布局，右图 twopi 布局"
# 布局
par(mfrow = c(1,2))
graph::plot(g2, "neato")
graph::plot(g2, "twopi")
```

### mlr3 包的生态图

下面是一个真实的网络图示例，取自 Deepayan Sarkar 在 2010 年介绍 R 语言的[材料](https://www.isid.ac.in/~deepayan/R-tutorials/docs/roverview.pdf)，该材料涵盖 R 语言的来龙去脉，辅以丰富的示例介绍统计计算、统计图形。

```{r}
#| eval=FALSE,
#| echo=TRUE
library(graph)
library(RBGL)
library(pkgDepTools)
g <- makeDepGraph("https://cran.r-project.org", keep.builtin = TRUE)
g
```
```{r}
#| echo=FALSE,
#| message=FALSE
library(graph)
library(RBGL)
library(pkgDepTools)
g = readRDS(file = "data/cran-pkg-graph.rds")
g
```

截至2022年04月28日，CRAN 上的 R 包有 19056 个（即网络的顶点），组成的依赖关系网包含 95625 条边。下面以 **mlr3** 包为例，提取后向依赖图，即依赖**mlr3** 包的 R 包的关系网，作为 R 包开发者，常常需要关心自己的 R 包改动会对下游 R 包的影响。CRAN 也有政策，防止开发者**肆意**引入破坏性改动。

```{r}
#| echo=TRUE
revDepGraph <- function(g, pkg) {
  olen <- 0
  pkgKeep <- pkg
  elist <- g@edgeL
  elist <- elist[!(sapply(elist, is.null))]
  while (length(pkgKeep) > olen) {
    olen <- length(pkgKeep)
    w <- which(g@nodes %in% pkgKeep)
    revdep <- sapply(elist, function(x) any(w %in% x$edges))
    pkgKeep <- union(pkgKeep, names(revdep)[revdep])
  }
  subGraph(pkgKeep, g)
}
graph_mlr3 <- revDepGraph(g, "mlr3")
graph_mlr3
```

可知目前有 25 个 R 包直接或间接强依赖 **mlr3** 包，而这个依赖关系网有 50 条边，如图\@ref(fig:mlr3-dep-graph)所示，这其实就是 **mlr3** 包的生态。

(ref:mlr3-dep-graph) **mlr3** 包的后向依赖图

```{r mlr3-dep-graph}
#| fig.cap="(ref:mlr3-dep-graph)",
#| fig.width=8,
#| fig.height=8,
#| echo=TRUE
library(Rgraphviz)
# 顶点的形状为椭圆
graph.par(nodes = list(shape = "ellipse"))
# 布局算法 twopi
graph_mlr3_layout <- layoutGraph(graph_mlr3, layoutType = "twopi")
# 渲染图
renderGraph(graph_mlr3_layout)
```


```{r}
#| eval=FALSE
tools::dependsOnPkgs('mlr3', installed = pdb)
```




# 环境信息

在 RStudio IDE 内编辑本文的 R Markdown 源文件，用 **blogdown** 构建网站，[Hugo](https://github.com/gohugoio/hugo) 渲染 knitr 之后的 Markdown 文件，得益于 **blogdown** 对 R Markdown 格式的支持，图、表和参考文献的交叉引用非常方便，省了不少文字编辑功夫。文中使用了多个 R 包，为方便复现本文内容，下面列出详细的环境信息：

```{r}
#| echo=TRUE
xfun::session_info(packages = c(
  "knitr", "rmarkdown", "blogdown",
  "igraphdata", "igraph", "graph",
  "BiocManager", "Rgraphviz", "pkgDepTools",
  "ggplot2", "RBGL"
), dependencies = FALSE)
```


# 参考文献
