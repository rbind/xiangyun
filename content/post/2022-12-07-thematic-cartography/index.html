---
title: 探索美国的失业率
author: 黄湘云
date: '2022-12-07'
slug: thematic-cartography
categories:
  - 统计图形
tags: 
  - 专题地图
  - 地理可视化
  - 空间分析
  - 失业率
  - maps
  - lattice
  - latticeExtra
  - sf
  - ggplot2
  - tidycensus
output:
  blogdown::html_page:
    toc: true
    number_sections: true
link-citations: true
math: true
csl: institute-of-mathematical-statistics.csl
bibliography: refer.bib
description: "首先挑选一些感兴趣的话题，我个人对社会经济方面的有兴趣，内在的动力在于我想了解自己所处的这个复杂的社会。在我掌握一些数据分析的工具后，想要自己动手去复现、验证看到或听到的结论，也很有兴趣提出自己的问题，并从某个角度切入。从收集数据、校验数据、探索数据、分析数据、解释数据等过程中，打磨自己的技能，同时，深入地了解社会。本文想完整展现自己的一段分析过程，以美国失业率数据为例。"
---


<div id="TOC">
<ul>
<li><a href="#overview" id="toc-overview"><span class="toc-section-number">1</span> 本文概览</a></li>
<li><a href="#tools-review" id="toc-tools-review"><span class="toc-section-number">2</span> 探索工具</a></li>
<li><a href="#data-access" id="toc-data-access"><span class="toc-section-number">3</span> 数据获取</a></li>
<li><a href="#data-check" id="toc-data-check"><span class="toc-section-number">4</span> 数据探查</a></li>
<li><a href="#data-explore" id="toc-data-explore"><span class="toc-section-number">5</span> 数据探索</a>
<ul>
<li><a href="#maps" id="toc-maps"><span class="toc-section-number">5.1</span> maps 包</a></li>
<li><a href="#latticeExtra" id="toc-latticeExtra"><span class="toc-section-number">5.2</span> latticeExtra 包</a></li>
<li><a href="#sf" id="toc-sf"><span class="toc-section-number">5.3</span> sf 包</a></li>
<li><a href="#ggplot2" id="toc-ggplot2"><span class="toc-section-number">5.4</span> ggplot2 包</a></li>
</ul></li>
<li><a href="#data-analysis" id="toc-data-analysis"><span class="toc-section-number">6</span> 数据分析</a></li>
<li><a href="#refer" id="toc-refer"><span class="toc-section-number">7</span> 参考文献</a></li>
<li><a href="#session" id="toc-session"><span class="toc-section-number">8</span> 环境信息</a></li>
</ul>
</div>

<div class="rmdinfo">
<p>本文引用的所有信息均为公开信息，仅代表作者本人观点，与就职单位无关。</p>
</div>
<style type="text/css">
.center {
  text-align: center;
}
</style>
<div id="overview" class="section level1" number="1">
<h1><span class="header-section-number">1</span> 本文概览</h1>
<p>首先挑选一些感兴趣的话题，我个人对社会经济方面的有兴趣，内在的动力在于我想了解自己所处的这个复杂的社会。在我掌握一些数据分析的工具后，想要自己动手去复现、验证看到或听到的结论，也很有兴趣提出自己的问题，并从某个角度切入。从收集数据、校验数据、探索数据、分析数据、解释数据等过程中，打磨自己的技能，同时，深入地了解社会。本文想完整展现自己的一段分析过程，以美国失业率数据为例。</p>
<p>约 6-7年前，我在 <strong>maps</strong> 包里了解到 unemp 数据集，是一份 2009 年美国各个郡县的失业率数据，它有三个变量，fips 郡县代码，pop 人口，unemp 失业率。还了解到另外一个数据集 county.fips，它有两个变量，fips 郡县代码， polyname 州郡名称。有这份数据，我们可以展示 2009 年美国各个地方的失业率，最直接的可视化方法就是直方图和地区分布图。
直方图将连续型的数据，划分区间，统计每个失业率区间内，郡县的数量。地区分布图将每个郡县的失业率映射到美国郡县级的地图上，可以看到失业率在空间上的分布。时至今日，还可以收集尽可能多的历史数据，展示失业率的空间变化。进一步，收集和失业率紧密相关的数据指标，以及联邦政府、中央银行的经济政策。</p>
<p>以美国的失业率数据为例，还有些原因，美国人口调查局发布的数据完整，有 R 包封装了相关数据接口，数据获取也方便。世界银行也发布了很多世界发展相关的数据，可以结合起来分析，有相互印证的作用。在当下的环境中，对大部分人来说，失业率不是陌生的指标，却是十分关注的指标，算是一个热门话题。</p>
<p>R 语言实现数据分析的完整过程，尽可能使得计算和内容可重复。希望对那些用 R 语言来工作的人有一些启发，也希望引起一些读者的兴趣，去找到自己感兴趣的话题，亲自动手探索一番，将探索的过程和结果分享出来。</p>
</div>
<div id="tools-review" class="section level1" number="2">
<h1><span class="header-section-number">2</span> 探索工具</h1>
<p>早些年， <strong>ggplot2</strong> 包 <span class="citation">[<a href="#ref-Wickham2016" role="doc-biblioref">1</a>]</span> 与 <strong>maps</strong> <span class="citation">[<a href="#ref-maps2021" role="doc-biblioref">2</a>]</span>、<strong>mapproj</strong> <span class="citation">[<a href="#ref-mapproj2022" role="doc-biblioref">3</a>]</span> 和 <strong>mapdata</strong> <span class="citation">[<a href="#ref-Becker2018" role="doc-biblioref">4</a>]</span> 一起提供基于 Base R 的地理可视化方案。而后，又出现了 <strong>grid</strong> <span class="citation">[<a href="#ref-Paul2002" role="doc-biblioref">5</a>]</span> 包、<strong>lattice</strong> 包 <span class="citation">[<a href="#ref-Sarkar2008" role="doc-biblioref">6</a>]</span> 及其插件 <strong>latticeExtra</strong> 包 <span class="citation">[<a href="#ref-Deepayan2022" role="doc-biblioref">7</a>]</span> 一起提供基于栅格绘图系统（Trellis Graphics）的地理可视化方案。近年来，<strong>ggplot2</strong> 包 <span class="citation">[<a href="#ref-Wickham2022" role="doc-biblioref">8</a>]</span> 与 <strong>sf</strong> 包 <span class="citation">[<a href="#ref-Pebesma2018" role="doc-biblioref">9</a>]</span>、<strong>tigris</strong> <span class="citation">[<a href="#ref-tigris2022" role="doc-biblioref">10</a>]</span> 和 <strong>tidycensus</strong> <span class="citation">[<a href="#ref-Walker2022" role="doc-biblioref">11</a>]</span> 一起彻底革新了绘图方案，在空间数据获取、处理和可视化方面都更加的高效。这使得空间数据读取 <strong>rgdal</strong> <span class="citation">[<a href="#ref-rgdal2022" role="doc-biblioref">12</a>]</span> 、空间数据处理 <strong>maptools</strong> <span class="citation">[<a href="#ref-Bivand2022" role="doc-biblioref">13</a>]</span> 和空间几何计算 <strong>rgeos</strong> <span class="citation">[<a href="#ref-rgeos2021" role="doc-biblioref">14</a>]</span> 完全可以被 <strong>sf</strong> 包替代，一下子还替代了好些个空间坐标投影的 <a href="https://github.com/hypertidy/reproj/"><strong>reproj</strong> 包</a> <span class="citation">[<a href="#ref-reproj2020" role="doc-biblioref">15</a>]</span>、<a href="https://github.com/hypertidy/PROJ"><strong>PROJ</strong> 包</a> <span class="citation">[<a href="#ref-PROJ2020" role="doc-biblioref">16</a>]</span>和 <a href="https://proj.org/"><strong>proj4</strong> 包</a> <span class="citation">[<a href="#ref-Urbanek2022" role="doc-biblioref">17</a>]</span>，基于 <strong>sp</strong> 包 <span class="citation">[<a href="#ref-Pebesma2005" role="doc-biblioref">18</a>]</span> 的栅格数据处理 <strong>raster</strong> 包也跟着升级，不再依赖 <strong>sp</strong> 包，替之以 <strong>terra</strong> 包，与国际开源空间统计分析社区更加接轨。连接使用 Google 地图服务的 <strong>ggmap</strong> <span class="citation">[<a href="#ref-Kahle2013" role="doc-biblioref">19</a>]</span> 、<strong>RgoogleMaps</strong> <span class="citation">[<a href="#ref-Loecher2015" role="doc-biblioref">20</a>]</span>、<strong>plotKML</strong> <span class="citation">[<a href="#ref-Hengl2015" role="doc-biblioref">21</a>]</span> 和 <strong>mapmisc</strong> <span class="citation">[<a href="#ref-Brown2016" role="doc-biblioref">22</a>]</span>，可以被 <strong>tmap</strong> 包 <span class="citation">[<a href="#ref-Tennekes2018" role="doc-biblioref">23</a>]</span> 替代。<strong>leaflet</strong> 包<span class="citation">[<a href="#ref-leaflet2022" role="doc-biblioref">24</a>]</span>提供开放街道地图数据的获取接口，同时提供许多地理数据可视化的方法，地图可以缩放交互。还有一些辅助作图的 R 包，常用的有处理中文字体的 <strong>showtext</strong> 包<span class="citation">[<a href="#ref-Qiu2015" role="doc-biblioref">25</a>]</span>，提供丰富层次的调色板 <strong>viridisLite</strong> 包<span class="citation">[<a href="#ref-Garnier2021" role="doc-biblioref">26</a>]</span>，制作动态图形的 <strong>gganimate</strong> 包<span class="citation">[<a href="#ref-gganimate2022" role="doc-biblioref">27</a>]</span>、<strong>echarts4r</strong> 包<span class="citation">[<a href="#ref-echarts4r2022" role="doc-biblioref">28</a>]</span>和 <strong>plotly</strong> 包<span class="citation">[<a href="#ref-Sievert2020" role="doc-biblioref">29</a>]</span>等。更多内容请看 R 语言官网提供的两个视图：<a href="https://cran.r-project.org/view=Spatial">Spatial</a>和<a href="https://cran.r-project.org/view=SpatioTemporal">SpatioTemporal</a>。</p>
</div>
<div id="data-access" class="section level1" number="3">
<h1><span class="header-section-number">3</span> 数据获取</h1>
<p>本文获取的公开数据来源</p>
<ul>
<li><strong>maps</strong> 包内置的美国各郡县失业率数据，<a href="https://github.com/walkerke/tigris"><strong>tigris</strong></a> 包获取美国最新的比例尺 1:2000,0000 州、郡县级地图数据。</li>
<li><a href="https://github.com/walkerke/tidycensus"><strong>tidycensus</strong></a> 包获取美国人口调查局发布的社会经济数据。</li>
<li><a href="https://github.com/gshs-ornl/wbstats"><strong>wbstats</strong></a> 包获取世界银行发布的发展数据。</li>
</ul>
<p>获取数据的具体代码见后文。</p>
<!-- 
[**censusapi**](https://github.com/hrecht/censusapi)
[**WDI**](https://github.com/vincentarelbundock/WDI)
-->
</div>
<div id="data-check" class="section level1" number="4">
<h1><span class="header-section-number">4</span> 数据探查</h1>
<p><strong>maps</strong> 包内置了美国州、郡级地图数据，从下图 <a href="#fig:fig-usa-map">4.1</a> 不难看出，地图数据是不完整的。一眼看去，至少缺少阿拉斯加州、夏威夷州和波多黎各领地。</p>
<div class="figure"><span style="display:block;" id="fig:fig-usa-map"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-usa-map-1.png" alt="美国州、郡地图" width="50%" /><img src="{{< blogdown/postref >}}index_files/figure-html/fig-usa-map-2.png" alt="美国州、郡地图" width="50%" />
<p class="caption">
图 4.1: 美国州、郡地图
</p>
</div>
<p><strong>maps</strong> 包还内置了数据集 <code>county.fips</code>，记录了美国各郡县的行政代码及州郡名称，一共 3085 各郡县的 FIPS 代码 <code>fips</code> 和名称 <code>polyname</code>。</p>
<pre class="r"><code>str(county.fips)
# &#39;data.frame&#39;: 3085 obs. of  2 variables:
#  $ fips    : int  1001 1003 1005 1007 1009 1011 1013 1015 1017 1019 ...
#  $ polyname: chr  &quot;alabama,autauga&quot; &quot;alabama,baldwin&quot; &quot;alabama,barbour&quot; &quot;alabama,bibb&quot; ...</code></pre>
<p><strong>maps</strong> 包也内置了 <code>unemp</code> 数据集，记录了 2009 年美国各郡县的失业率，一共 3218 个郡县的失业率 <code>unemp</code>、人口 <code>pop</code> 和 FIPS 代码 <code>fips</code>。结合 <code>county.fips</code> 和 <code>unemp</code> 数据集来看，显然数据集 <code>county.fips</code> 要么早就过时了，要么收录不完整，导致至少缺少了 3218 - 3085 = 133 个郡县的 FIPS 代码。</p>
<pre class="r"><code>str(unemp)
# &#39;data.frame&#39;: 3218 obs. of  3 variables:
#  $ fips : int  1001 1003 1005 1007 1009 1011 1013 1015 1017 1019 ...
#  $ pop  : int  23288 81706 9703 8475 25306 3527 8884 52055 13726 11583 ...
#  $ unemp: num  9.7 9.1 13.4 12.1 9.9 16.4 16.7 10.8 18.6 11.8 ...</code></pre>
<p>数据初步探查的结果是：相对失业率数据集 unemp 来说，美国州、郡县级地图数据不完整，各郡县 FIPS 代码数据集 county.fips 不完整。</p>
<div class="rmdtip">
<p>美国各郡县的 FIPS 代码可类比我国<a href="http://www.mca.gov.cn/article/sj/xzqh/1980/">行政区划代码</a>，自1980年以来，每年都会发布一次，涉及一些市、区、县、乡、镇、街道等的变更。</p>
</div>
<p>county.fips 没有夏威夷、阿拉斯加、波多黎各的地图数据，导致 unemp 数据集里阿拉斯加、夏威夷、波多黎各和部分弗吉尼亚的小城市无法映射到地图上。</p>
<p>相对于 unemp 数据集，county.fips 数据集少了哪些地区的 FIPS 代码，当采用左关联来检查数据情况时，发现 county.fips 缺少 143 个郡县的代码。</p>
<pre class="r"><code>tmp &lt;- merge(x = unemp, y = county.fips, all.x = TRUE)
tmp2 &lt;- tmp[is.na(tmp$polyname), ]
dim(tmp2)
# [1] 143   4
head(tmp2)
#    fips    pop unemp polyname
# 68 2013   1148  10.1     &lt;NA&gt;
# 69 2016   2903   8.4     &lt;NA&gt;
# 70 2020 153264   7.0     &lt;NA&gt;
# 71 2050   7061  14.8     &lt;NA&gt;
# 72 2060   1159   3.6     &lt;NA&gt;
# 73 2068   2300   3.4     &lt;NA&gt;</code></pre>
<p>数据集 tmp2 中 fips 代码的前两位代表州，参考维基百科<a href="https://en.wikipedia.org/wiki/Federal_Information_Processing_Standard_state_code">联邦信息处理标准-州代码</a>，可知缺失的 FIPS 代码分布在 6个州或领地，分别是 20-Kansas 堪萨斯州、21-Kentucky 肯塔基州、22-Louisiana 路易斯安那州、15-Hawaii 夏威夷州、51-Virginia 弗吉尼亚州、72-Puerto Rico 波多黎各（领地）。</p>
<p>相对于 unemp 数据集，分各州统计 county.fips 缺少的 FIPS 代码的数量。</p>
<pre class="r"><code># 从郡县 FIPS
tmp2$state_fips &lt;- substr(tmp2$fips, start = 1, stop = 2)
aggregate(data = tmp2, fips ~ state_fips, FUN = length)
#   state_fips fips
# 1         15    4
# 2         20    8
# 3         21   10
# 4         22    9
# 5         51   34
# 6         72   78</code></pre>
<p>数据集 <code>unemp</code> 和 <code>county.fips</code> 都用整型来存储 FIPS 代码，这是错误的，应该用字符型。没关联上的州编号都是 10 以上，所以上面才能用函数 <code>substr()</code> 抽取州的 FIPS 代码，否则得另想办法统计缺失的分布情况。</p>
<div class="rmdtip">
<p>在企业中，上面的数据质量探查操作是非常典型的，如果在数据库集群中，检查数据缺失情况，那最好用 SQL 操作，上述 Base R 数据操作等价的 SQL 语句（以 SQLite 为例）如下：</p>
<pre class="sql"><code>SELECT state_fips,
       count(1) AS cnt
FROM
  (SELECT A.fips,
          substr(A.fips, 1, 2) AS state_fips,
          A.pop,
          A.unemp,
          B.polyname
   FROM unemp A
   LEFT JOIN county_fips B ON A.fips = B.fips
   WHERE B.polyname IS NULL )
GROUP BY state_fips</code></pre>
<div class="knitsql-table">
<table>
<caption><span id="tab:unnamed-chunk-8">表 4.1: </span>按州统计缺失的郡县数量</caption>
<thead>
<tr class="header">
<th align="left">state_fips</th>
<th align="right">cnt</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">15</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">20</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="left">21</td>
<td align="right">10</td>
</tr>
<tr class="even">
<td align="left">22</td>
<td align="right">9</td>
</tr>
<tr class="odd">
<td align="left">51</td>
<td align="right">34</td>
</tr>
<tr class="even">
<td align="left">72</td>
<td align="right">78</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="data-explore" class="section level1" number="5">
<h1><span class="header-section-number">5</span> 数据探索</h1>
<p>对于区域数据，描述其空间分布采用的常见图形是地区分布图（Choropleth maps）。也叫围栏图，一个个多边形围成的区域就好比大草原上的一个个围栏。也叫面量图，一块块区域加上该区域的属性、度量指标（经济的、人文的、社会的）。</p>
<div id="maps" class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> maps 包</h2>
<p><strong>maps</strong> 包的函数 <code>map()</code> 帮助文档 <code>?map</code> 给出了一个示例，地图数据就来自 <strong>maps</strong> 包，失业率数据 <code>unemp</code> 和行政编码数据 <code>county.fips</code> 也来自 <strong>maps</strong> 包。经过上面的数据探查，为美观起见，代码有所调整，结合下图 <a href="#fig:fig-unemp-maps">5.1</a>，除了验证数据质量外，2009 年美国各郡县的失业率分布非常直观了。美国东、西两岸经济比较发达，失业率也比较高，从沿海到内陆，失业率由高到低，有比较明显的层次感。</p>
<pre class="r"><code>library(maps)
library(mapproj)
# 失业率数据
data(unemp)
# 行政编码
data(county.fips)
# 准备调色板
colors &lt;- viridisLite::plasma(9)
# 失业率划分区间
unemp$colorBuckets &lt;- as.numeric(cut(
  unemp$unemp,
  c(seq(0, 10, by = 2), 15, 20, 25, 100)
))
# 准备图例文本
leg.txt &lt;- c(
  &quot;   &lt;2%&quot;, &quot;  2-4%&quot;, &quot;  4-6%&quot;,
  &quot;  6-8%&quot;, &quot; 8-10%&quot;, &quot;10-15%&quot;,
  &quot;15-20%&quot;, &quot;20-25%&quot;, &quot;  &gt;25%&quot;
)
# 根据区域单元的名称匹配地图数据上每个区域的 FIPS
cnty.fips &lt;- county.fips$fips[match(
  map(&quot;county&quot;, plot = FALSE)$names,
  county.fips$polyname
)]
# 根据 FIPS 给地图上每个区域的失业率匹配颜色
colorsmatched &lt;- unemp$colorBuckets[match(cnty.fips, unemp$fips)]
par(mar = c(1.5, 0, 2, 0))
# 绘制区县地图
map(&quot;county&quot;,
  col = colors[colorsmatched], fill = TRUE, resolution = 0,
  lty = 0, projection = &quot;polyconic&quot;, mar = c(0.5, 0.5, 2, 0.5)
)
# 添加州边界线
map(&quot;state&quot;,
  col = &quot;white&quot;, fill = FALSE, add = TRUE,
  lty = 1, lwd = 0.4, projection = &quot;polyconic&quot;
)
# 添加图标题
title(&quot;2009 年美国各郡县的失业率&quot;)
mtext(
  text = &quot;数据源：美国人口调查局&quot;,
  side = 1, adj = 0
)
# 添加图例
legend(&quot;bottomright&quot;,
  title = &quot;失业率(%)&quot;,
  legend = leg.txt,
  horiz = FALSE,
  fill = colors, cex = 0.85,
  box.col = NA, border = NA
)</code></pre>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:fig-unemp-maps"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-unemp-maps-1.png" alt="2009 年美国各郡县的失业率分布" width="672" />
<p class="caption">
图 5.1: 2009 年美国各郡县的失业率分布
</p>
</div>
</div>
<div id="latticeExtra" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> latticeExtra 包</h2>
<p>在数据探索的工具上，也可以用 <strong>latticeExtra</strong> 包来做，不过它也是依赖于 <strong>maps</strong> 包，依赖地图数据、坐标投影等。在绘制地区分布图方面，仅仅是提供一个新的绘图方式 — 基于 <strong>grid</strong> 的 <strong>lattice</strong> 绘图系统。实际操作下来，使用的复杂度不亚于 Base R 的基础绘图系统，而图形效果是基本一致的。更多详细介绍见另一篇文章<a href="https://cosx.org/2022/05/choropleth-map/">《地区分布图及其应用》</a>。</p>
<pre class="r"><code># 美国郡边界地图数据
us_county &lt;- map(&quot;county&quot;,
  plot = FALSE, fill = TRUE, projection = &quot;polyconic&quot;
)
# 美国州边界数据
us_state &lt;- map(&quot;state&quot;,
  plot = FALSE, fill = TRUE, projection = &quot;polyconic&quot;
)
# 失业率数据和行政区域名称关联
unemp_df &lt;- merge(unemp, county.fips, by = &quot;fips&quot;)
# 绘图
library(lattice)
latticeExtra::mapplot(polyname ~ unemp, data = unemp_df,
  # 地图数据
  map = us_county,
  # 配色采用 plasma 调色板
  colramp = viridisLite::plasma,
  # 修改默认的面板函数
  panel = function(x, y, map, ...) {
    # 对未收集到癌症死亡率数据的郡，添加郡边界线
    panel.lines(
      x = us_county$x, y = us_county$y,
      lty = 1, lwd = 0.2, col = &quot;black&quot;
    )
    # 地区分布图主体
    latticeExtra::panel.mapplot(x, y, map, ...)
    # 添加州边界线
    panel.lines(
      x = us_state$x, y = us_state$y,
      lty = 1, lwd = 0.2, col = &quot;white&quot;
    )
  },
  # 去掉郡县边界线
  border = NA,
  # cuts = 10, # 等距分桶的数，和参数 breaks 二选一
  breaks = c(seq(0, 10, by = 2), 15, 20, 25, 30, 35),
  # 仅绘制地图支持的那些失业率数据
  subset = polyname %in% us_county$names,
  # 去掉坐标轴
  scales = list(draw = F),
  # 去掉横轴标签
  xlab = &quot;&quot;,
  # 全局图形参数设置
  par.settings = list(
    # 副标题放在左下角
    par.sub.text = list(
      font = 2,
      just = &quot;left&quot;,
      x = grid::unit(5, &quot;mm&quot;),
      y = grid::unit(5, &quot;mm&quot;)
    ),
    # 轴线设置白色以隐藏
    axis.line = list(col = &quot;white&quot;)
  ),
  # 副标题
  sub = &quot;数据源：美国人口调查局&quot;,
  # 主标题
  main = &quot;2009 年美国各郡县的失业率&quot;
)</code></pre>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:fig-unemp-lattice"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-unemp-lattice-1.png" alt="2009 年美国各郡县的失业率分布" width="768" />
<p class="caption">
图 5.2: 2009 年美国各郡县的失业率分布
</p>
</div>
</div>
<div id="sf" class="section level2" number="5.3">
<h2><span class="header-section-number">5.3</span> sf 包</h2>
<p>从数据探查的结果可知，应该去获取更加完整的，和失业率数据能匹配上的地图数据。 <strong>tigris</strong> 包提供较新的美国州、郡县级矢量地图数据。地图数据的获取过程见文章<a href="https://cosx.org/2022/05/choropleth-map/">《地区分布图及其应用》</a>。</p>
<pre class="r"><code>library(sf)
# 准备地图数据
us_state_map &lt;- readRDS(file = &quot;data/us_state_map.rds&quot;)
us_county_map &lt;- readRDS(file = &quot;data/us_county_map.rds&quot;)
# 查看数据
us_county_map
# Simple feature collection with 3220 features and 9 fields
# Geometry type: GEOMETRY
# Dimension:     XY
# Bounding box:  xmin: -3112000 ymin: -1698000 xmax: 2258000 ymax: 1559000
# Projected CRS: USA_Contiguous_Albers_Equal_Area_Conic
# First 10 features:
#    STATEFP COUNTYFP COUNTYNS       AFFGEOID GEOID       NAME LSAD     ALAND
# 1       29      227 00758566 0500000US29227 29227      Worth   06 6.906e+08
# 2       31      061 00835852 0500000US31061 31061   Franklin   06 1.491e+09
# 3       36      013 00974105 0500000US36013 36013 Chautauqua   06 2.746e+09
# 4       37      181 01008591 0500000US37181 37181      Vance   06 6.537e+08
# 5       47      183 01639799 0500000US47183 47183    Weakley   06 1.503e+09
# 6       44      003 01219778 0500000US44003 44003       Kent   06 4.366e+08
# 7       08      101 00198166 0500000US08101 08101     Pueblo   06 6.180e+09
# 8       17      175 00424288 0500000US17175 17175      Stark   06 7.462e+08
# 9       29      169 00758539 0500000US29169 29169    Pulaski   06 1.417e+09
# 10      19      151 00465264 0500000US19151 19151 Pocahontas   06 1.495e+09
#       AWATER                       geometry
# 1  4.939e+05 MULTIPOLYGON (((114836 3450...
# 2  4.879e+05 MULTIPOLYGON (((-267685 323...
# 3  1.139e+09 MULTIPOLYGON (((1324221 647...
# 4  4.218e+07 MULTIPOLYGON (((1544260 322...
# 5  3.707e+06 MULTIPOLYGON (((625934 -988...
# 6  5.069e+07 MULTIPOLYGON (((1977965 726...
# 7  3.022e+07 MULTIPOLYGON (((-783174 122...
# 8  6.848e+05 MULTIPOLYGON (((500559 4247...
# 9  1.131e+07 MULTIPOLYGON (((312852 4616...
# 10 3.667e+06 MULTIPOLYGON (((88186 60633...</code></pre>
<p>为了将失业率数据合并到地图数据上，需要将地理区域唯一标识 GEOID 作类型转化。GEOID 是两个字符型变量 STATEFP 和 COUNTYFP 拼接起来的字符串变量。根据这份地图数据，可以知道美国目前一共有 3220 个郡县。</p>
<pre class="r"><code># 地理区域唯一标识
us_county_map$GEOID &lt;- as.integer(us_county_map$GEOID)
# 将失业率数据和地图数据合并
us_county_data &lt;- merge(
  x = us_county_map, y = unemp,
  by.x = &quot;GEOID&quot;, by.y = &quot;fips&quot;, all.x = TRUE
)</code></pre>
<p>从这份地图数据来看，有 8 个郡县没有失业率数据，主要分布在地广人稀的阿拉斯加州 （02-Alaska）。具体原因是什么呢？留待读者思考。</p>
<pre class="r"><code>us_county_data[is.na(us_county_data$unemp),]
# Simple feature collection with 8 features and 12 fields
# Geometry type: GEOMETRY
# Dimension:     XY
# Bounding box:  xmin: -2349000 ymin: -1537000 xmax: -492400 ymax: 712300
# Projected CRS: USA_Contiguous_Albers_Equal_Area_Conic
#      GEOID STATEFP COUNTYFP COUNTYNS       AFFGEOID                  NAME LSAD
# 77    2105      02      105 02371430 0500000US02105         Hoonah-Angoon   05
# 82    2158      02      158 01419985 0500000US02158              Kusilvak   05
# 88    2195      02      195 02516404 0500000US02195            Petersburg   04
# 89    2198      02      198 01419980 0500000US02198 Prince of Wales-Hyder   05
# 91    2230      02      230 02339479 0500000US02230               Skagway   12
# 94    2275      02      275 02516402 0500000US02275              Wrangell   03
# 549  15005      15      005 01702380 0500000US15005               Kalawao   06
# 2413 46102      46      102 01266992 0500000US46102         Oglala Lakota   06
#          ALAND    AWATER pop unemp colorBuckets                       geometry
# 77   1.698e+10 7.802e+09  NA    NA           NA MULTIPOLYGON (((-1435018 -1...
# 82   4.422e+10 6.694e+09  NA    NA           NA MULTIPOLYGON (((-2348786 -1...
# 88   7.513e+09 2.386e+09  NA    NA           NA MULTIPOLYGON (((-1411642 -1...
# 89   1.363e+10 1.462e+10  NA    NA           NA MULTIPOLYGON (((-1304827 -1...
# 91   1.124e+09 2.878e+07  NA    NA           NA MULTIPOLYGON (((-1516456 -1...
# 94   6.620e+09 2.384e+09  NA    NA           NA MULTIPOLYGON (((-1389562 -1...
# 549  3.106e+07 1.058e+08  NA    NA           NA POLYGON ((-846359 -1181798,...
# 2413 5.422e+09 7.126e+06  NA    NA           NA MULTIPOLYGON (((-562220 704...</code></pre>
<p>将失业率数据 unemp 视为左表，地图数据 us_county_map 视为右表，检查一下有多少失业率数据关联不上地图数据。实际情况是一共有 6 个郡县的失业率数据关联不上地图数据。</p>
<pre class="r"><code>us_county_data_tmp &lt;- merge(
  x = unemp, y = us_county_map,
  by.x = &quot;fips&quot;, by.y = &quot;GEOID&quot;, all.x = TRUE
)
us_county_data_tmp[is.na(us_county_data_tmp$STATEFP),]
#       fips  pop unemp colorBuckets STATEFP COUNTYFP COUNTYNS AFFGEOID NAME LSAD
# 86    2201 2507  13.6            6    &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;
# 88    2232 2278   7.3            4    &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;
# 91    2270 2807  20.4            8    &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;
# 92    2280 2836   9.8            5    &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;
# 2415 46113 3827  12.6            6    &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;
# 2914 51515 2768   8.9            5    &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt;     &lt;NA&gt; &lt;NA&gt; &lt;NA&gt;
#      ALAND AWATER                 geometry
# 86      NA     NA GEOMETRYCOLLECTION EMPTY
# 88      NA     NA GEOMETRYCOLLECTION EMPTY
# 91      NA     NA GEOMETRYCOLLECTION EMPTY
# 92      NA     NA GEOMETRYCOLLECTION EMPTY
# 2415    NA     NA GEOMETRYCOLLECTION EMPTY
# 2914    NA     NA GEOMETRYCOLLECTION EMPTY</code></pre>
<p>经过上面的检查，失业率数据和这份地图数据<strong>不是完全匹配</strong>的，但是差距也不大。要想进一步改进，甚至达到完全匹配，应该怎么做呢？就是根据收集到的失业率数据所在的年份去找相应年份的郡县地图数据。也就是去找 2009 年美国郡县级多边形矢量地图数据。余下的工作留待读者操作。</p>
<p>相比于前任 <strong>sp</strong> 包，<strong>sf</strong> 包将是新一代空间数据操作、分析和可视化的基石，引入 <a href="https://gdal.org/">GDAL</a>、<a href="https://proj.org/">PROJ</a> 和 <a href="https://github.com/libgeos/geos">GEOS</a> 三大空间数据处理的基础框架，和更庞大的空间数据社区接轨，不局限于 R 语言社区的一亩三分地。<strong>sf</strong> 包支持 Base R 绘图，以此绘制失业率专题地图，如图<a href="#fig:fig-unemp-sf">5.3</a>所示，可见效果丝毫不逊于 <strong>Base R</strong> 和 <strong>lattice</strong> 版本，而且在兼容性、代码量、稳定性和性能等方面有明显优势。</p>
<pre class="r"><code>par(mar = c(2, 0, 4, 0))
# 添加郡县地图作为底图，失业率缺失的地方涂上灰色
plot(st_geometry(us_county_map),
  reset = FALSE, border = &quot;grey90&quot;,
  col = &quot;grey80&quot;, main = &quot;2009 年美国各郡县的失业率&quot;
)
# 绘制图形主体
plot(us_county_data[&quot;unemp&quot;],
  pal = viridisLite::plasma,
  breaks = c(seq(0, 10, by = 2), 15, 20, 25, 30, 35),
  border = NA, key.pos = NULL, reset = FALSE, add = TRUE
)
# 添加州边界
plot(st_geometry(us_state_map),
  col = NA, border = &quot;gray90&quot;,
  add = TRUE, lwd = 0.2
)
mtext(
  text = &quot;数据源：美国人口调查局&quot;, side = 1, adj = 0.8
)
# 调色板
colors &lt;- viridisLite::plasma(10)
breaks &lt;- c(seq(0, 10, by = 2), 15, 20, 25, 30, 35)
# 图例文本
leg.txt &lt;- mapply(paste,
  breaks[-length(breaks)],
  breaks[-1],
  collapse = &quot; &quot;, sep = &quot;~&quot;
)
# 添加图例
legend(&quot;bottomright&quot;,
  legend = c(leg.txt, &quot;NA&quot;), title = &quot;失业率(%)&quot;,
  box.col = NA, border = NA,
  horiz = FALSE, fill = c(colors, &quot;grey80&quot;),
  cex = 0.85, xjust = 0.5
)</code></pre>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:fig-unemp-sf"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-unemp-sf-1.png" alt="2009 年美国各个郡县的失业率分布" width="768" />
<p class="caption">
图 5.3: 2009 年美国各个郡县的失业率分布
</p>
</div>
</div>
<div id="ggplot2" class="section level2" number="5.4">
<h2><span class="header-section-number">5.4</span> ggplot2 包</h2>
<p>站在 <strong>sf</strong> 包的肩膀上，<strong>ggplot2</strong> 包也可以绘制类似上图<a href="#fig:fig-unemp-sf">5.3</a>的效果。<strong>ggplot2</strong> 包的特点是有非常清晰的分层，图层层层叠加实现最终效果。优点是掌握其一般规律后，代码简洁易读，缺点是 <strong>ggplot2</strong> 包不太稳定，函数每隔一段时间会有不向后兼容的破坏性更改。复现下图必须采用与本文运行环境一致的 R 包，笔者当前采用的 <strong>ggplot2</strong> 版本是 3.4.0。添加郡县级失业率数据，添加州级多边形边界线，设置调色板和图形主题，添加图例标题和副标题，调整州、郡边界线以体现层次。</p>
<pre class="r"><code>library(ggplot2)
ggplot() +
  geom_sf(
    data = us_county_data, aes(fill = unemp),
    colour = &quot;grey80&quot;, linewidth = 0.05
  ) +
  geom_sf(
    data = us_state_map,
    colour = &quot;grey80&quot;, fill = NA, linewidth = 0.1
  ) +
  scale_fill_viridis_c(
    option = &quot;plasma&quot;, na.value = &quot;white&quot;
  ) +
  theme_void() +
  labs(
    fill = &quot;失业率&quot;, caption = &quot;数据源：美国人口调查局&quot;
  )</code></pre>
<div class="figure"><span style="display:block;" id="fig:fig-us-unemp"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-us-unemp-1.png" alt="2009 年美国各郡县失业率分布" width="768" />
<p class="caption">
图 5.4: 2009 年美国各郡县失业率分布
</p>
</div>
<p>请读者参考文章<a href="https://cosx.org/2022/05/choropleth-map/">《地区分布图及其应用》</a>给出失业率分段的地区分布图。</p>
<p>以 1PP （即一个百分点，宏观经济指标波动 1 个百分点是很大的事情了）为间隔，统计美国各个郡县的失业率分布情况，如图 <a href="#fig:fig-us-unemp-dist">5.5</a> 所示，除少量人口多，经济发达的郡县失业率远高于其它外，剩余的呈现正态分布，失业率集中于 8% 左右。</p>
<pre class="r"><code>ggplot() +
  geom_histogram(data = us_county_data[!is.na(us_county_data$unemp),], aes(x = unemp),
                 binwidth = 1, fill = &quot;lightblue&quot;, color = &quot;white&quot;) +
  theme_classic() +
  labs(x = &quot;失业率&quot;, y = &quot;郡县数量&quot;)</code></pre>
<div class="figure"><span style="display:block;" id="fig:fig-us-unemp-dist"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-us-unemp-dist-1.png" alt="2009 年美国失业率分布" width="672" />
<p class="caption">
图 5.5: 2009 年美国失业率分布
</p>
</div>
<p>unemp 数据集还包含一列 pop 人口数（但未提供人口数指标的说明），各个郡县的人口数如图<a href="#fig:fig-us-pop">5.6</a>所示。</p>
<pre class="r"><code>ggplot() +
  geom_sf(
    data = us_county_data, aes(fill = pop),
    colour = &quot;grey80&quot;, linewidth = 0.05
  ) +
  geom_sf(
    data = us_state_map,
    colour = &quot;grey80&quot;, fill = NA, linewidth = 0.1
  ) +
  scale_fill_viridis_c(
    option = &quot;plasma&quot;, na.value = &quot;white&quot;, trans = &quot;log10&quot;,
    labels = scales::label_number(scale_cut = scales::cut_short_scale())
  ) +
  theme_void() +
  labs(
    fill = &quot;人口数&quot;, caption = &quot;数据源：美国人口调查局&quot;
  )</code></pre>
<div class="figure"><span style="display:block;" id="fig:fig-us-pop"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-us-pop-1.png" alt="2009 年美国各郡县人口分布" width="768" />
<p class="caption">
图 5.6: 2009 年美国各郡县人口分布
</p>
</div>
<p>据查，2009 年美国人口总数超过 3 亿，unemp 数据集显示 2009 年美国各郡县人口总共约 1.5 亿。unemp 数据集中包含的各个郡县人口数具体是何含义，未知。留待读者继续探查。</p>
<pre class="r"><code>sum(us_county_data$pop, na.rm = T)
# [1] 154919862</code></pre>
</div>
</div>
<div id="data-analysis" class="section level1" number="6">
<h1><span class="header-section-number">6</span> 数据分析</h1>
<p>2008 年美国发生次贷危机，雷曼兄弟倒闭，随后席卷全球，2009 年失业率正处于历史高位。2019 年底出现新冠疫情，随后席卷全球，至今未消，2022 年俄乌爆发战争。俄罗斯作为世界上重要的能源输出国，乌克兰作为重要的粮食出口国，中国改革进入深水区，经济周期下行，去杠杆化的效应正在加速显现，失业率达到近30年以来的最高水平，国家正面临百年未有之大变局。</p>
<p>2022年11月15日至16日，二十国集团领导人第十七次峰会在印度尼西亚的巴厘岛举行，峰会主题为「共同复苏、强劲复苏」。G20 包含 中国、韩国、印度、美国、英国、加拿大、德国、意大利、法国、俄罗斯、日本、欧洲联盟、印度尼西亚、墨西哥、南非共和国、沙特阿拉伯、土耳其、澳大利亚、阿根廷、巴西。首先看看 G20 各个国家的整体失业率情况。</p>
<p>世界银行的数据获取参考文章<a href="https://xiangyun.rbind.io/2022/06/gapminder/">Gapminder：关注差异、理解变化</a>，美国人口调查局的数据获取参考文章<a href="https://cosx.org/2022/05/choropleth-map/">地区分布图及其应用</a>。</p>
<dl>
<dt>总失业人数（占劳动力总数的比例）（模拟劳工组织估计），指标 ID 为 SL.UEM.TOTL.ZS</dt>
<dd>
失业人数是指目前没有工作但可以参加工作且正在寻求工作的劳动力数量。各国对劳动力和失业人数的定义各有不同。详见<a href="https://data.worldbank.org.cn/indicator/SL.UEM.TOTL.ZS?locations=CN">世界银行网站</a>，经过比对，从数据 API 获得的数据和网站图表中显示的数据是一致的。
</dd>
<dt>按消费者价格指数衡量的通货膨胀（年通胀率），指标 ID 为 FP.CPI.TOTL.ZG</dt>
<dd>
按消费者价格指数衡量的通货膨胀反映出普通消费者在指定时间间隔（如年度）内购买固定或变动的一篮子货物和服务的成本的年百分比变化。通常采用拉斯佩尔公式进行计算。
</dd>
<dt>基尼 (GINI) 系数，指标 ID 为 SI.POV.GINI</dt>
<dd>
基尼系数用于衡量一个经济体中在个人或家庭中的收入分配（在某些情况下是消费支出）偏离完全平均分配的程度。洛伦兹曲线标示出总收入累积百分比与收入获得者累积人数的相对关系，曲线的起点为最贫困的个人或家庭。基尼系数测算洛伦兹曲线与假设的绝对平均线之间的面积，表示为在该线以下最大面积中所占的比例。因此，基尼系数为 0 表示完全平均，100% 则表示完全不平均。
</dd>
</dl>
<p>从世界银行数据库获取最近 30 年宏观经济数据，实际上，据笔者了解，世界银行仅提供最近 30 年的数据。</p>
<pre class="r"><code>wb_world_indicator &lt;- wbstats::wb_data(
  indicator = c(
    &quot;SL.UEM.TOTL&quot;, # 失业人数 Number of people unemployed
    &quot;SL.UEM.TOTL.ZS&quot;, # 失业率 Unemployed (%) (modeled ILO estimate)
    &quot;SL.UEM.TOTL.NE.ZS&quot;, # 失业率 Unemployed (%) national estimate

    &quot;NY.GDP.PCAP.KD.ZG&quot;, # 人均 GDP 增速
    &quot;NY.GDP.MKTP.CD&quot;, # GDP 总量
    &quot;NY.GDP.MKTP.KD.ZG&quot;, # GDP 增速

    &quot;FP.CPI.TOTL&quot;, # 消费价格指数（以 2010 年为对比基数 100）
    &quot;FP.CPI.TOTL.ZG&quot;, # 通货膨胀率
    &quot;SI.POV.GINI&quot;, # Gini 指数

    &quot;SP.DYN.LE00.IN&quot;, # 预期寿命
    &quot;NY.GDP.PCAP.CD&quot;, # 人均 GDP
    &quot;SP.POP.TOTL&quot; # 人口总数
  ),
  country = &quot;countries_only&quot;,
  return_wide = FALSE,
  start_date = 1991, end_date = 2021
)
# 保存数据到本地，方便后续使用
saveRDS(wb_world_indicator, file = &quot;data/wb_world_indicator.rds&quot;)</code></pre>
<p>从 G20 中选取 11 个国家（中国、印度、美国、英国、德国、法国、俄罗斯、日本、南非共和国、沙特阿拉伯、澳大利亚）。失业率数据、通货膨胀率数据和基尼 (GINI) 系数数据。</p>
<div class="figure"><span style="display:block;" id="fig:fig-uem"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-uem-1.png" alt="失业率数据" width="672" />
<p class="caption">
图 6.1: 失业率数据
</p>
</div>
<p>南非失业率一直居高不下，余下的国家失业率表现比较平稳。2020 年后，美国的失业率上涨比较多。</p>
<div class="figure"><span style="display:block;" id="fig:fig-cpi"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-cpi-1.png" alt="通货膨胀率数据" width="672" />
<p class="caption">
图 6.2: 通货膨胀率数据
</p>
</div>
<p>苏联解体后，俄罗斯经济上经历了休克疗法，政局不平稳，2000 年前俄罗斯的通胀高得没边，就不去谈它了，图中也没有展示相关数据，重点关注余下的国家。</p>
<div class="figure"><span style="display:block;" id="fig:fig-gini"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-gini-1.png" alt="基尼 (GINI) 系数数据" width="672" />
<p class="caption">
图 6.3: 基尼 (GINI) 系数数据
</p>
</div>
<p>基尼 (GINI) 系数数据不太多，南非有很高的基尼系数，贫富差距巨大，大部分在 30% - 40% 之间。中国贫富差距比美国小，比俄罗斯大，整体属于高位。</p>
<p>先看看美国各州、各郡县的失业情况。</p>
<pre class="r"><code># 读取数据
us_unemp_county &lt;- readRDS(file = &quot;data/us_unemp_county.rds&quot;)
us_unemp_state &lt;- readRDS(file = &quot;data/us_unemp_state.rds&quot;)
# 绘图
ggplot() +
  geom_sf(
    data = us_unemp_state,
    aes(fill = estimate / 10000), colour = NA
  ) +
  scale_fill_viridis_c(option = &quot;plasma&quot;, na.value = &quot;grey80&quot;) +
  coord_sf(crs = st_crs(&quot;ESRI:102003&quot;)) +
  labs(
    fill = &quot;失业人口\n（万）&quot;, 
    title = &quot;2016-2020 年度美国各州失业人口&quot;,
    caption = &quot;数据源：美国人口调查局&quot;
  ) +
  theme_void(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.direction = &quot;horizontal&quot;,
    legend.position = &quot;bottom&quot;,
    legend.justification = &quot;right&quot;,
    legend.title = element_text(size = 10),
    plot.caption = element_text(hjust = 0, vjust = 10)
  )</code></pre>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:fig-us-unemp-state"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-us-unemp-state-1.png" alt="2016-2020 年度美国各州失业人口" width="921.6" />
<p class="caption">
图 6.4: 2016-2020 年度美国各州失业人口
</p>
</div>
<pre class="r"><code># 绘图
ggplot() +
  geom_sf(
    data = st_geometry(us_unemp_county), fill = &quot;grey80&quot;, colour = NA
  ) +
  geom_sf(
    data = us_unemp_county[us_unemp_county$estimate &gt; 0,],
    aes(fill = estimate), colour = NA
  ) +
  geom_sf(
    data = us_unemp_state,
    colour = alpha(&quot;gray80&quot;, 1 / 4), fill = NA, size = 0.15
  ) +
  scale_fill_viridis_c(option = &quot;plasma&quot;, 
                       na.value = &quot;grey80&quot;, trans = &quot;log10&quot;) +
  coord_sf(crs = st_crs(&quot;ESRI:102003&quot;)) +
  labs(
    fill = &quot;失业人口\n&quot;, 
    title = &quot;2016-2020 年度美国各郡县失业人口&quot;,
    caption = &quot;数据源：美国人口调查局&quot;
  ) +
  theme_void(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.direction = &quot;horizontal&quot;,
    legend.position = &quot;bottom&quot;,
    legend.justification = &quot;right&quot;,
    legend.title = element_text(size = 10),
    plot.caption = element_text(hjust = 0, vjust = 10)
  )</code></pre>
<div class="figure"><span style="display:block;" id="fig:fig-us-unemp-county"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-us-unemp-county-1.png" alt="2015-2020 年度美国各郡县失业人口" width="921.6" />
<p class="caption">
图 6.5: 2015-2020 年度美国各郡县失业人口
</p>
</div>
<p>再以北卡州为例，看看各郡、各社区的失业情况。</p>
<pre class="r"><code>nc_unemployed_county &lt;- readRDS(file = &quot;data/nc_unemployed_county.RDS&quot;)

ggplot(data = nc_unemployed_county) +
  geom_sf(aes(fill = B27011_008E), color = NA) +
  scale_fill_viridis_c(option = &quot;C&quot;) +
  theme_void()</code></pre>
<div class="figure"><span style="display:block;" id="fig:fig-nc-unemployed-county"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-nc-unemployed-county-1.png" alt="北卡州各郡县失业率" width="768" />
<p class="caption">
图 6.6: 北卡州各郡县失业率
</p>
</div>
<div class="full-width">
<div class="figure"><span style="display:block;" id="fig:fig-nc-unemployed-tract"></span>
<img src="{{< blogdown/postref >}}index_files/figure-html/fig-nc-unemployed-tract-1.png" alt="北卡州各社区失业率" width="1152" />
<p class="caption">
图 6.7: 北卡州各社区失业率
</p>
</div>
</div>
<p>还有很多问题可以深入探索，比如根据美国历史至今的失业率变化情况，可否从中得到一些启示？美国人口调查局采用的失业率口径是什么？对失业率数据，采用空间区域平滑描述时空趋势变化。失业率居高不下，带来的连锁反应有哪些？继续以纽约、旧金山为例，犯罪率是否上升？CPI 是否上涨？利率是否变化？</p>
</div>
<div id="refer" class="section level1" number="7">
<h1><span class="header-section-number">7</span> 参考文献</h1>
<div id="refs" class="references csl-bib-body">
<div id="ref-Wickham2016" class="csl-entry">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline"><span class="smallcaps">Wickham</span>, H. (2016). <em><a href="https://ggplot2.tidyverse.org"><span class="nocase">ggplot2</span>: Elegant graphics for data analysis</a></em>. Springer-Verlag New York.</div>
</div>
<div id="ref-maps2021" class="csl-entry">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline"><span class="smallcaps">Becker</span>, R. A., <span class="smallcaps">Wilks</span>, A. R., <span class="smallcaps">Brownrigg</span>, R., <span class="smallcaps">Minka</span>, T. P. and <span class="smallcaps">Deckmyn</span>, A. (2021). <em><a href="https://github.com/adeckmyn/maps"><span class="nocase">maps</span>: Draw geographical maps</a></em>.</div>
</div>
<div id="ref-mapproj2022" class="csl-entry">
<div class="csl-left-margin">[3] </div><div class="csl-right-inline"><span class="smallcaps">McIlroy</span>, D., <span class="smallcaps">Brownrigg</span>, R., <span class="smallcaps">Minka</span>, T. P. and <span class="smallcaps">Bivand</span>, R. (2022). <em><a href="https://CRAN.R-project.org/package=mapproj"><span class="nocase">mapproj</span>: Map projections</a></em>.</div>
</div>
<div id="ref-Becker2018" class="csl-entry">
<div class="csl-left-margin">[4] </div><div class="csl-right-inline"><span class="smallcaps">Becker</span>, R. A., <span class="smallcaps">Wilks</span>, A. R. and <span class="smallcaps">Brownrigg</span>, R. (2018). <em><a href="https://CRAN.R-project.org/package=mapdata"><span class="nocase">mapdata</span>: Extra map databases</a></em>.</div>
</div>
<div id="ref-Paul2002" class="csl-entry">
<div class="csl-left-margin">[5] </div><div class="csl-right-inline"><span class="smallcaps">Murrell</span>, P. (2002). <a href="https://www.r-project.org/doc/Rnews/Rnews_2002-2.pdf">The <span class="nocase">grid</span> graphics package</a>. <em>R News</em> <strong>2</strong> 14–9.</div>
</div>
<div id="ref-Sarkar2008" class="csl-entry">
<div class="csl-left-margin">[6] </div><div class="csl-right-inline"><span class="smallcaps">Sarkar</span>, D. (2008). <em><a href="http://lmdvr.r-forge.r-project.org"><span class="nocase">lattice</span>: Multivariate data visualization with <span>R</span></a></em>. Springer-Verlag, New York.</div>
</div>
<div id="ref-Deepayan2022" class="csl-entry">
<div class="csl-left-margin">[7] </div><div class="csl-right-inline"><span class="smallcaps">Sarkar</span>, D. and <span class="smallcaps">Andrews</span>, F. (2022). <em><a href="https://CRAN.R-project.org/package=latticeExtra"><span class="nocase">latticeExtra</span>: Extra graphical utilities based on <span class="nocase">lattice</span></a></em>.</div>
</div>
<div id="ref-Wickham2022" class="csl-entry">
<div class="csl-left-margin">[8] </div><div class="csl-right-inline"><span class="smallcaps">Wickham</span>, H. (2022). <em><a href="https://ggplot2-book.org/"><span class="nocase">ggplot2</span>: Elegant graphics for data analysis</a></em>. Springer-Verlag New York.</div>
</div>
<div id="ref-Pebesma2018" class="csl-entry">
<div class="csl-left-margin">[9] </div><div class="csl-right-inline"><span class="smallcaps">Pebesma</span>, E. J. (2018). <a href="https://doi.org/10.32614/RJ-2018-009"><span class="nocase">Simple Features for R: Standardized Support for Spatial Vector Data</span></a>. <em><span>The R Journal</span></em> <strong>10</strong> 439–46.</div>
</div>
<div id="ref-tigris2022" class="csl-entry">
<div class="csl-left-margin">[10] </div><div class="csl-right-inline"><span class="smallcaps">Walker</span>, K. (2022). <em><a href="https://CRAN.R-project.org/package=tigris"><span class="nocase">tigris</span>: Load census TIGER/line shapefiles</a></em>.</div>
</div>
<div id="ref-Walker2022" class="csl-entry">
<div class="csl-left-margin">[11] </div><div class="csl-right-inline"><span class="smallcaps">Walker</span>, K. (2022). <em><a href="https://walker-data.com/census-r/">Analyzing US census data: Methods, maps, and models in r</a></em>. Chapman; Hall/CRC, Boca Raton, Florida.</div>
</div>
<div id="ref-rgdal2022" class="csl-entry">
<div class="csl-left-margin">[12] </div><div class="csl-right-inline"><span class="smallcaps">Bivand</span>, R., <span class="smallcaps">Keitt</span>, T. and <span class="smallcaps">Rowlingson</span>, B. (2022). <em><a href="https://CRAN.R-project.org/package=rgdal"><span class="nocase">rgdal</span>: Bindings for the ’geospatial’ data abstraction library</a></em>.</div>
</div>
<div id="ref-Bivand2022" class="csl-entry">
<div class="csl-left-margin">[13] </div><div class="csl-right-inline"><span class="smallcaps">Bivand</span>, R. and <span class="smallcaps">Lewin-Koh</span>, N. (2022). <em><a href="https://CRAN.R-project.org/package=maptools"><span class="nocase">maptools</span>: Tools for handling spatial objects</a></em>.</div>
</div>
<div id="ref-rgeos2021" class="csl-entry">
<div class="csl-left-margin">[14] </div><div class="csl-right-inline"><span class="smallcaps">Bivand</span>, R. and <span class="smallcaps">Rundel</span>, C. (2021). <em><a href="https://CRAN.R-project.org/package=rgeos"><span class="nocase">rgeos</span>: Interface to geometry engine - open source (’GEOS’)</a></em>.</div>
</div>
<div id="ref-reproj2020" class="csl-entry">
<div class="csl-left-margin">[15] </div><div class="csl-right-inline"><span class="smallcaps">Sumner</span>, M. D. (2020). <em><a href="https://CRAN.R-project.org/package=reproj"><span class="nocase">reproj</span>: Coordinate system transformations for generic map data</a></em>.</div>
</div>
<div id="ref-PROJ2020" class="csl-entry">
<div class="csl-left-margin">[16] </div><div class="csl-right-inline"><span class="smallcaps">Sumner</span>, M. D. (2020). <em><a href="https://CRAN.R-project.org/package=PROJ"><span>PROJ</span>: Generic coordinate system transformations using ’PROJ’</a></em>.</div>
</div>
<div id="ref-Urbanek2022" class="csl-entry">
<div class="csl-left-margin">[17] </div><div class="csl-right-inline"><span class="smallcaps">Urbanek</span>, S. (2022). <em><a href="https://CRAN.R-project.org/package=proj4"><span class="nocase">proj4</span>: A simple interface to the <span>PROJ.4</span> cartographic projections library</a></em>.</div>
</div>
<div id="ref-Pebesma2005" class="csl-entry">
<div class="csl-left-margin">[18] </div><div class="csl-right-inline"><span class="smallcaps">Pebesma</span>, E. J. and <span class="smallcaps">Bivand</span>, R. S. (2005). <a href="https://CRAN.R-project.org/doc/Rnews/">Classes and methods for spatial data in <span>R</span></a>. <em>R News</em> <strong>5</strong> 9–13.</div>
</div>
<div id="ref-Kahle2013" class="csl-entry">
<div class="csl-left-margin">[19] </div><div class="csl-right-inline"><span class="smallcaps">Kahle</span>, D. and <span class="smallcaps">Wickham</span>, H. (2013). <a href="https://journal.r-project.org/archive/2013-1/kahle-wickham.pdf"><span class="nocase">ggmap</span>: Spatial visualization with <span class="nocase">ggplot2</span></a>. <em>The R Journal</em> <strong>5</strong> 144–61.</div>
</div>
<div id="ref-Loecher2015" class="csl-entry">
<div class="csl-left-margin">[20] </div><div class="csl-right-inline"><span class="smallcaps">Loecher</span>, M. and <span class="smallcaps">Ropkins</span>, K. (2015). <a href="http://www.jstatsoft.org/v63/i04/"><span>RgoogleMaps</span> and <span class="nocase">loa</span>: Unleashing <span>R</span> graphics power on map tiles</a>. <em>Journal of Statistical Software</em> <strong>63</strong> 1–18.</div>
</div>
<div id="ref-Hengl2015" class="csl-entry">
<div class="csl-left-margin">[21] </div><div class="csl-right-inline"><span class="smallcaps">Hengl</span>, T., <span class="smallcaps">Roudier</span>, P., <span class="smallcaps">Beaudette</span>, D. and <span class="smallcaps">Pebesma</span>, E. (2015). <a href="https://www.jstatsoft.org/v63/i05/"><span class="nocase">plotKML</span>: Scientific visualization of spatio-temporal data</a>. <em>Journal of Statistical Software</em> <strong>63</strong> 1–25.</div>
</div>
<div id="ref-Brown2016" class="csl-entry">
<div class="csl-left-margin">[22] </div><div class="csl-right-inline"><span class="smallcaps">Brown</span>, P. E. (2016). <a href="https://journal.r-project.org/archive/2016-1/brown.pdf">Maps, coordinate reference systems and visualising geographic data with <span class="nocase">mapmisc</span></a>. <em><span>R Journal</span></em> <strong>8</strong> 64–91.</div>
</div>
<div id="ref-Tennekes2018" class="csl-entry">
<div class="csl-left-margin">[23] </div><div class="csl-right-inline"><span class="smallcaps">Tennekes</span>, M. (2018). <a href="https://doi.org/10.18637/jss.v084.i06"><span class="nocase">tmap</span>: Thematic maps in <span>R</span></a>. <em>Journal of Statistical Software</em> <strong>84</strong> 1–39.</div>
</div>
<div id="ref-leaflet2022" class="csl-entry">
<div class="csl-left-margin">[24] </div><div class="csl-right-inline"><span class="smallcaps">Cheng</span>, J., <span class="smallcaps">Karambelkar</span>, B. and <span class="smallcaps">Xie</span>, Y. (2022). <em><a href="https://CRAN.R-project.org/package=leaflet">Leaflet: Create interactive web maps with the JavaScript ’leaflet’ library</a></em>.</div>
</div>
<div id="ref-Qiu2015" class="csl-entry">
<div class="csl-left-margin">[25] </div><div class="csl-right-inline"><span class="smallcaps">Qiu</span>, Y. (2015). <a href="https://doi.org/10.32614/RJ-2015-008"><span class="nocase">showtext</span>: Using system fonts in <span>R</span> graphics</a>. <em><span>The R Journal</span></em> <strong>7</strong> 99–108.</div>
</div>
<div id="ref-Garnier2021" class="csl-entry">
<div class="csl-left-margin">[26] </div><div class="csl-right-inline"><span class="smallcaps">Garnier</span>, <span class="smallcaps">Simon</span>, <span class="smallcaps">Ross</span>, <span class="smallcaps">Noam</span>, <span class="smallcaps">Rudis</span>, <span class="smallcaps">Robert</span>, <span class="smallcaps">Camargo</span>, <span class="smallcaps">Pedro</span>, A., <span class="smallcaps">Sciaini</span>, <span class="smallcaps">Marco</span>, <span class="smallcaps">Scherer</span> and <span class="smallcaps">Cédric</span>. (2021). <em><a href="https://doi.org/10.5281/zenodo.4679424"><span class="nocase">viridis</span> - colorblind-friendly color maps for r</a></em>.</div>
</div>
<div id="ref-gganimate2022" class="csl-entry">
<div class="csl-left-margin">[27] </div><div class="csl-right-inline"><span class="smallcaps">Pedersen</span>, T. L. and <span class="smallcaps">Robinson</span>, D. (2022). <em><a href="https://CRAN.R-project.org/package=gganimate"><span class="nocase">gganimate</span>: A grammar of animated graphics</a></em>.</div>
</div>
<div id="ref-echarts4r2022" class="csl-entry">
<div class="csl-left-margin">[28] </div><div class="csl-right-inline"><span class="smallcaps">Coene</span>, J. (2022). <em><a href="https://CRAN.R-project.org/package=echarts4r"><span class="nocase">echarts4r</span>: Create interactive graphs with <span>Echarts JavaScript</span> version 5</a></em>.</div>
</div>
<div id="ref-Sievert2020" class="csl-entry">
<div class="csl-left-margin">[29] </div><div class="csl-right-inline"><span class="smallcaps">Sievert</span>, C. (2020). <em><a href="https://plotly-r.com">Interactive web-based data visualization with <span>R</span>, <span class="nocase">plotly</span>, and <span class="nocase">shiny</span></a></em>. Chapman; Hall/CRC.</div>
</div>
<div id="ref-Xie2018" class="csl-entry">
<div class="csl-left-margin">[30] </div><div class="csl-right-inline"><span class="smallcaps">Xie</span>, Y., <span class="smallcaps">Allaire</span>, J. J. and <span class="smallcaps">Grolemund</span>, G. (2018). <em><a href="https://bookdown.org/yihui/rmarkdown"><span>R Markdown</span>: The definitive guide</a></em>. Chapman; Hall/CRC, Boca Raton, Florida.</div>
</div>
<div id="ref-Xie2017" class="csl-entry">
<div class="csl-left-margin">[31] </div><div class="csl-right-inline"><span class="smallcaps">Xie</span>, Y., <span class="smallcaps">Hill</span>, A. P. and <span class="smallcaps">Thomas</span>, A. (2017). <em><a href="https://bookdown.org/yihui/blogdown/"><span class="nocase">blogdown</span>: Creating websites with <span>R</span> markdown</a></em>. Chapman; Hall/CRC, Boca Raton, Florida.</div>
</div>
</div>
</div>
<div id="session" class="section level1" number="8">
<h1><span class="header-section-number">8</span> 环境信息</h1>
<p>在 RStudio IDE 内编辑本文的 R Markdown 源文件<span class="citation">[<a href="#ref-Xie2018" role="doc-biblioref">30</a>]</span>，用 <strong>blogdown</strong> <span class="citation">[<a href="#ref-Xie2017" role="doc-biblioref">31</a>]</span>构建网站，<a href="https://github.com/gohugoio/hugo">Hugo</a> 渲染 knitr 之后的 Markdown 文件，得益于 <strong>blogdown</strong> 对 R Markdown 格式的支持，图、表和参考文献的交叉引用非常方便，省了不少文字编辑功夫。文中使用了多个 R 包，为方便复现本文内容，下面列出详细的环境信息：</p>
<pre class="r"><code>xfun::session_info(packages = c(
  &quot;knitr&quot;, &quot;rmarkdown&quot;, &quot;blogdown&quot;, 
  &quot;maps&quot;, &quot;mapproj&quot;, &quot;lattice&quot;, &quot;latticeExtra&quot;,
  &quot;sf&quot;, &quot;tidycensus&quot;, &quot;tigris&quot;, &quot;showtext&quot;,
  &quot;ggplot2&quot;, &quot;RSQLite&quot;, &quot;wbstats&quot;
), dependencies = FALSE)
# R version 4.2.2 (2022-10-31)
# Platform: x86_64-apple-darwin17.0 (64-bit)
# Running under: macOS Big Sur ... 10.16
# 
# Locale: en_US.UTF-8 / en_US.UTF-8 / en_US.UTF-8 / C / en_US.UTF-8 / en_US.UTF-8
# 
# Package version:
#   blogdown_1.15       ggplot2_3.4.0       knitr_1.41         
#   lattice_0.20-45     latticeExtra_0.6-30 mapproj_1.2.9      
#   maps_3.4.1          rmarkdown_2.18      RSQLite_2.2.19     
#   sf_1.0-9            showtext_0.9-5      tidycensus_1.2.3   
#   tigris_2.0          wbstats_1.0.4      
# 
# Pandoc version: 2.19.2
# 
# Hugo version: 0.108.0</code></pre>
</div>
